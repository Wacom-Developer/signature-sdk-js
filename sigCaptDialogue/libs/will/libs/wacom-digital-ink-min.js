var DigitalInk=function(t){"use strict";"undefined"==typeof ClipperLib&&console.warn("digital-ink dependency clipper-lib not found, expected in global scope"),"undefined"==typeof poly2tri&&console.warn("digital-ink dependency poly2tri not found, expected in global scope"),"undefined"==typeof protobuf&&console.warn("digital-ink dependency protobufjs not found, expected in global scope"),"undefined"==typeof md5&&console.warn("digital-ink dependency js-md5 not found, expected in global scope");var e=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},r="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function n(t,e){return t(e={exports:{}},e.exports),e.exports}var i=n((function(t){function e(r,n){return t.exports=e=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},e(r,n)}t.exports=e}));var o=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&i(t,e)},a=n((function(t){function e(r){return"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?t.exports=e=function(t){return typeof t}:t.exports=e=function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},e(r)}t.exports=e}));var s=function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t};var u=function(t,e){return!e||"object"!==a(e)&&"function"!=typeof e?s(t):e},c=n((function(t){function e(r){return t.exports=e=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},e(r)}t.exports=e}));var l=function(t){return-1!==Function.toString.call(t).indexOf("[native code]")};var h=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}},f=n((function(t){function e(r,n,o){return h()?t.exports=e=Reflect.construct:t.exports=e=function(t,e,r){var n=[null];n.push.apply(n,e);var o=new(Function.bind.apply(t,n));return r&&i(o,r.prototype),o},e.apply(null,arguments)}t.exports=e})),d=n((function(t){function e(r){var n="function"==typeof Map?new Map:void 0;return t.exports=e=function(t){if(null===t||!l(t))return t;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==n){if(n.has(t))return n.get(t);n.set(t,e)}function e(){return f(t,arguments,c(this).constructor)}return e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),i(e,t)},e(r)}t.exports=e}));function p(t){return function(){var e,r=c(t);if(y()){var n=c(this).constructor;e=Reflect.construct(r,arguments,n)}else e=r.apply(this,arguments);return u(this,e)}}function y(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}if("undefined"==typeof globalThis&&("undefined"!=typeof window?window.globalThis=window:"undefined"!=typeof self?self.globalThis=self:void 0!==r&&(r.globalThis=r)),String.prototype.contains||(String.prototype.contains=function(t){return-1!=this.indexOf(t)}),String.prototype.startsWith||(String.prototype.startsWith=function(t){return this.length>=t.length&&this.substring(0,t.length)==t}),String.prototype.endsWith||(String.prototype.endsWith=function(t){return this.length>=t.length&&this.substring(this.length-t.length,this.length)==t}),String.prototype.charsCode=function(){return this.split("").reduce((function(t,e){return t+e.charCodeAt(0)}),0)},String.prototype.containsIgnoreCase=function(t){return-1!=this.toUpperCase().indexOf(t.toUpperCase())},String.prototype.toCharArray=function(t){for(var e=t?new Uint8Array(this.length):new Array(this.length),r=0;r<this.length;r++){var n=this.charCodeAt(r);n>255&&(e.bytes=!1),e[r]=n}return e},String.fromCharArray=function(t){var e="";try{e=String.fromCharCode.apply(null,t)}catch(n){for(var r=0;r<t.length;r++)e+=String.fromCharCode(t[r])}return e},String.prototype.pad=function(t,e){return this.length<t?new Array(t-this.length+1).join(e||"-")+this:this.toString()},Number.prototype.pad=function(t){return String(this).length<t?new Array(t-String(this).length+1).join(0)+String(this):this.toString()},Number.prototype.toFloat32=function(){var t=new Float32Array(1);return t[0]=this,t[0]},Object.defineProperty(Array.prototype,"first",{get:function(){return this[0]},configurable:!0}),Object.defineProperty(Array.prototype,"last",{get:function(){return this[this.length-1]},configurable:!0}),Array.prototype.clear=function(){this.length=0},Array.prototype.contains=function(t){return this.indexOf(t)>-1},Array.prototype.clone=function(){return this.map((function(t){return Object.clone(t)}))},Array.prototype.unique=function(){var t=this;return this.filter((function(e,r){return t.indexOf(e)==r}))},Array.prototype.add=function(t){if(!this.contains(t))return this.push(t)},Array.prototype.insert=function(t,e){this.splice(t,0,e)},Array.prototype.remove=function(t){return this.removeAt(this.indexOf(t))},Array.prototype.removeAt=function(t){return t>-1&&this.splice(t,1),this},Array.prototype.replace=function(t,e,r){var n=this.indexOf(t);if(n>-1)if(!r&&e instanceof Array){for(var i=[n,1],o=0;o<e.length;o++)i.push(e[o]);this.splice.apply(this,i)}else this.splice(n,1,e);return this},Array.protoTypedArrays=function(){["Int8","Uint8","Uint8Clamped","Int16","Uint16","Int32","Uint32","Float32","Float64","BigInt64","BigUint64"].forEach((function(t){var e=globalThis[t+"Array"];e?(e.from?Array.prototype["to"+t+"Array"]=function(){return e.from(this)}:Array.prototype["to"+t+"Array"]=function(){return new e(this)},Array.from?e.prototype.toArray=function(){return Array.from(this)}:e.prototype.toArray=function(){return Array.prototype.slice.call(this)},e.prototype.clone=function(){return new e(this,this.byteOffset,this.length)},e.prototype.concat=function(){for(var t=this,e=this.length,r=this.length,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];i.forEach((function(r){if(t.constructor!=r.constructor)throw new Error("Concat array from wrong type detected - expected ".concat(t.constructor.name,", found ").concat(r.constructor.name));e+=r.length}));var a=new this.constructor(e);return a.set(this),i.forEach((function(t){a.set(t,r),r+=t.length})),a}):console.warn(t+"Array not found")}))},Array.protoTypedArrays(),delete Array.protoTypedArrays,ArrayBuffer.isTypedArray=function(t){return ArrayBuffer.isView(t)&&!(t instanceof DataView)},Function.name||(Function.name="Function"),Array.prototype.constructor.name||(Array.prototype.constructor.name="Array"),Function.create=function(t,e){e||(e=function(){});var r=e.getArguments(),n=new Function("body","return function "+t+"("+r+") {return body.apply(this, arguments);};")(e);return n.toString=function(){return e.toString()},n.toSource=function(){return e.toSource()},n},"name"in Function.prototype||Object.defineProperty(Function.prototype,"name",{configurable:!0,get:function(){var t=this.toString().match(/^function\s([\w$]+)/);return t?t[1]:""}}),Function.prototype.getArguments=function(){var t=this.toString().match(/\((.*?)\)/)[1].replace(/\s*/g,"");return 0==t.length?[]:t.split(",")},Function.prototype.getBody=function(){return this.toString().match(/\{([\s\S]*)\}/m)[1].replace(/^\s*\/\/.*$/gm,"")},Function.prototype.construct=function(t){var e=arguments.callee.caller.arguments;this.getArguments().forEach((function(t,r){this[t]=e[r]}),t)},Function.prototype.createEnum=function(t,e){var r=this;if(this[t])throw new Error("Already exists key: "+t);this[t]=new Object;for(var n=[],i=function(i){var o,a=t+"_"+e[i],s=r[t];s[e[i]]=(o=Object.create(Object.prototype,{constructor:{value:Function.create(a)},type:{value:t},name:{value:e[i]},value:{value:i}}),Object.defineProperty(s,i,{get:function(){return o}}),o),n.push(s[e[i]])},o=0;o<e.length;o++)i(o);Object.defineProperty(this[t],"values",{value:n})},Object.equals=function(t,e){if(t===e)return!0;if(!(t instanceof Object&&e instanceof Object))return!1;if(t.constructor!==e.constructor)return!1;if(t instanceof Array||ArrayBuffer.isTypedArray(t))return t.length==e.length&&t.every((function(t,r){return Object.equals(t,e[r])}));for(var r in t)if(t.hasOwnProperty(r)){if(!e.hasOwnProperty(r))return!1;if(t[r]!==e[r]){if("object"!==a(t[r]))return!1;if(!Object.equals(t[r],e[r]))return!1}}for(var n in e)if(e.hasOwnProperty(n)&&!t.hasOwnProperty(n))return!1;return!0},Object.clone=function(t,e){var r=new Array;return function t(n){if(null===n)return null;if("object"!==a(n)||n.mutable)return n;if("function"==typeof n.clone)return n.clone();for(var i=0;i<r.length;i++)if(r[i][0]===n)return r[i][1];var o=Object.create(Object.getPrototypeOf(n));for(var s in r.push([n,o]),n)e&&"function"==typeof n[s]||n.hasOwnProperty(s)&&(o[s]=t(n[s]));return o}(t)},Object.toSource=function(t,e){if(t&&"object"==a(t)){var r=[];for(var n in t)t.hasOwnProperty(n)&&r.push("".concat(n,": ").concat(Object.toSource(t[n])));return(e?"".concat(e," = "):"")+"{"+r.join(", ")+"};"}if("function"==typeof t){var i=t.toString();return 0!=i.indexOf("function")&&(i="function "+i),i}return t},Object.nameAnonymousFunctions=function(t,e){for(var r in t)"function"!=typeof t[r]||t[r].name||("constructor"==r&&e?Object.defineProperty(t[r],"name",{value:e}):Object.defineProperty(t[r],"name",{value:r}))},JSON.toBase64=function(t){return btoa(JSON.stringify(t))},JSON.fromBase64=function(t){return JSON.parse(atob(t))},JSON.encode=function(t){return JSON.toBase64(t).toCharArray(!0)},JSON.decode=function(t){var e=String.fromCharArray(t);return JSON.fromBase64(e)},Math.toDegrees=function(t){return t*(180/this.PI)},Math.toRadians=function(t){return t*(this.PI/180)},Math.randomInt=function(t,e){return Math.floor(this.random()*(e-t+1))+t},"object"===("undefined"==typeof window?"undefined":a(window))){if(HTMLElement.prototype.getInlineStyle=function(t){return this.style[t]||this.style["-webkit-"+t]||this.style["-khtml-"+t]||this.style["-moz-"+t]||this.style["-ms-"+t]||this.style["-o-"+t]||""},HTMLElement.prototype.setStyle=function(t,e){["-webkit","-khtml","-moz","-ms","-o"].forEach((function(r){this.style[r+"-"+t]=e}),this),this.style[t]=e},HTMLElement.prototype.getStyle=function(t){var e=t,r=t.startsWith("-");r&&(e=t.substring(1));for(var n=e.split("-"),i=n.length-1;i>0;i--)n[i]=n[i].substring(0,1).toUpperCase()+n[i].substring(1);e=n.join("");var o=this.style.display,a=this.style.visibility;"none"==o&&(this.style.visibility="hidden",this.style.display="");var s=window.getComputedStyle(this)[e];if(!r&&void 0===s)for(var u=["-webkit","-khtml","-moz","-ms","-o"],c=0;c<u.length&&"undefined"==(s=this.getStyle(u[c]+"-"+t));c++);return"none"==o&&(this.style.visibility=a,this.style.display="none"),s},HTMLElement.prototype.getMathStyle=function(t,e){var r=e?this.getInlineStyle(t):this.getStyle(t);return"auto"==r&&(r=0),parseFloat(r)},HTMLElement.prototype.getTransformStyle=function(){var t={translate:{x:0,y:0},scale:{x:1,y:1},rotate:{angle:0},skew:{angleX:0,angleY:0},matrix:{a:1,b:0,c:0,d:1,tx:0,ty:0}},e=this.getStyle("transform");if("none"!=e){var r=e.substring(e.indexOf("(")+1,e.indexOf(")")).split(/,\s*/g),n=parseFloat(r[0]),i=parseFloat(r[1]),o=parseFloat(r[2]),a=parseFloat(r[3]),s=parseFloat(r[4]),u=parseFloat(r[5]);t.scale={x:Math.sqrt(n*n+o*o),y:Math.sqrt(a*a+i*i)},t.skew={angleX:Math.tan(o),angleY:Math.tan(i)},t.rotate={angle:Math.atan2(i,n)},t.translate={x:s,y:u},t.matrix={a:n,b:i,c:o,d:a,tx:s,ty:u}}return t},HTMLElement.prototype.toRect=function(){var t=this.style.display,e=this.style.visibility;"none"==t&&(this.style.visibility="hidden",this.style.display="");var r=this.offsetWidth,n=this.offsetHeight,i=this.offsetLeft,o=this.offsetTop,a=i+r,s=o+n,u=(i+a)/2,c=(o+s)/2,l=r/2,h=n/2,f=r+this.getMathStyle("margin-left")+this.getMathStyle("margin-right"),d=n+this.getMathStyle("margin-top")+this.getMathStyle("margin-bottom");return"none"==t&&(this.style.visibility=e,this.style.display="none"),Object.defineProperties({},{left:{value:i,enumerable:!0},top:{value:o,enumerable:!0},right:{value:a,enumerable:!0},bottom:{value:s,enumerable:!0},x:{value:i,enumerable:!0},y:{value:o,enumerable:!0},width:{value:r,enumerable:!0},height:{value:n,enumerable:!0},center:{value:{x:u,y:c},enumerable:!0},origin:{value:{x:l,y:h},enumerable:!0},size:{value:{width:r,height:n},enumerable:!0},outerSize:{value:{width:f,height:d},enumerable:!0}})},HTMLImageElement.prototype.toDataURL=function(t){var e=document.createElement("canvas");return e.width=this.width,e.height=this.height,e.getContext("2d").drawImage(this,0,0),e.toDataURL(t||"image/png")},HTMLImageElement.prototype.toBlob=function(t){return new Blob([this.getBytes(t).buffer],{type:t||"image/png"})},HTMLImageElement.prototype.getBytes=function(t){var e=this.toDataURL(t).split(",")[1];return atob(e).toCharArray(!0)},Image.fromBytes=function(t,e,r){var n=new Image;return n.onload=function(){URL.revokeObjectURL(this.src),e&&e.call(this)},n.src=URL.createObjectURL(new Blob([t.buffer||t],{type:"image/"+(r||"png")})),n},CanvasRenderingContext2D.prototype.clearCanvas=function(t){this.clearRect(0,0,this.canvas.width,this.canvas.height),t&&(this.fillStyle=t,this.fillRect(0,0,this.canvas.width,this.canvas.height))},"undefined"==typeof OffscreenCanvas?(window.OffscreenCanvas=function(t,e){var r=document.createElement("canvas");return r.width=t,r.height=e,r},window.OffscreenCanvasRenderingContext2D=CanvasRenderingContext2D):"undefined"!=typeof OffscreenCanvasRenderingContext2D&&(OffscreenCanvasRenderingContext2D.prototype.clearCanvas=CanvasRenderingContext2D.prototype.clearCanvas),Object.defineProperty(Screen.prototype,"deviceWidth",{get:function(){if(90==window.orientation||-90==window.orientation){if(!this.orientation)return this.orientation=!0,this.deviceHeight;delete this.orientation}var t=this.width;return window.matchMedia("(-webkit-device-pixel-ratio)").matches||(t=Math.ceil(t*window.devicePixelRatio))%10!=0&&(t%10>5?t+=10-t%10:t-=t%10),t},configurable:!0}),Object.defineProperty(Screen.prototype,"deviceHeight",{get:function(){if(90==window.orientation||-90==window.orientation){if(!this.orientation)return this.orientation=!0,this.deviceWidth;delete this.orientation}var t=this.height;return window.matchMedia("(-webkit-device-pixel-ratio)").matches||(t=Math.ceil(t*window.devicePixelRatio))%10!=0&&(t%10>5?t+=10-t%10:t-=t%10),t},configurable:!0}),"undefined"==typeof PointerEvent){var v=function(t){o(n,t);var r=p(n);function n(){return e(this,n),r.apply(this,arguments)}return n}(d(Event));window.PointerEvent=v}if("undefined"==typeof TouchEvent){var g=function(t){o(n,t);var r=p(n);function n(){return e(this,n),r.apply(this,arguments)}return n}(d(Event));window.TouchEvent=g}}var m={init:function(){if(!this.type){var t,e="object"===("undefined"==typeof process?"undefined":a(process))&&!0;t="object"===("undefined"==typeof window?"undefined":a(window))?"WEB":"function"==typeof importScripts?"WORKER":e?"NODE":"SHELL";var r="undefined"==typeof OffscreenCanvas?"OFFSCREEN":"SCREEN",n="undefined"==typeof WebGLRenderingContext?"STACK":"WEB";Object.defineProperty(this,"commonJS",{value:e,enumerable:!0}),Object.defineProperty(this,"type",{value:m.Type[t],enumerable:!0}),Object.defineProperty(this,"type2D",{value:m.Type2D[r],enumerable:!0}),Object.defineProperty(this,"typeGL",{value:m.TypeGL[n],enumerable:!0})}}};Function.prototype.createEnum.call(m,"Type",["WEB","WORKER","NODE","SHELL"]),Function.prototype.createEnum.call(m,"Type2D",["SCREEN","OFFSCREEN"]),Function.prototype.createEnum.call(m,"TypeGL",["WEB","STACK"]),m.init();var b=function(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n};var x=function(t){if(Array.isArray(t))return b(t)};var E=function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)};var P=function(t,e){if(t){if("string"==typeof t)return b(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(r):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?b(t,e):void 0}};var k=function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")};var w=function(t){return x(t)||E(t)||P(t)||k()};function R(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var S,I=function(t,e,r){return e&&R(t.prototype,e),r&&R(t,r),t},T=function(){function t(){if(e(this,t),S)throw new Error("URIResolver instance already available");S=this,this.init()}return I(t,[{key:"init",value:function(){throw new Error("URIResolver: init should be implemented")}},{key:"get",value:function(t){return this[t]}},{key:"register",value:function(t,e){this[t]=e}},{key:"resolve",value:function(t){var e;if(t.includes("?")){var r=this[t.split("?")[0]];if(r){var n=t.split("?")[1],i=[];n.split("&").forEach((function(t){var e=t.split("=")[1],r=parseFloat(e);isFinite(r)?e=r:"true"==e?e=!0:"false"==e&&(e=!1),i.push(e)})),e=function(){return r.apply(void 0,w(Array.from(arguments).concat(i)))}}}else e=this[t];if(!e)throw new Error("Failed to resolve ".concat(t));return e}}]),t}();Object.defineProperty(T,"instance",{get:function(){return S},enumerable:!0});var A="undefined"!=typeof Float32Array?Float32Array:Array;function C(){var t=new A(16);return A!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function D(t,e,r){var n=e[0],i=e[1],o=e[2],a=e[3],s=e[4],u=e[5],c=e[6],l=e[7],h=e[8],f=e[9],d=e[10],p=e[11],y=e[12],v=e[13],g=e[14],m=e[15],b=r[0],x=r[1],E=r[2],P=r[3];return t[0]=b*n+x*s+E*h+P*y,t[1]=b*i+x*u+E*f+P*v,t[2]=b*o+x*c+E*d+P*g,t[3]=b*a+x*l+E*p+P*m,b=r[4],x=r[5],E=r[6],P=r[7],t[4]=b*n+x*s+E*h+P*y,t[5]=b*i+x*u+E*f+P*v,t[6]=b*o+x*c+E*d+P*g,t[7]=b*a+x*l+E*p+P*m,b=r[8],x=r[9],E=r[10],P=r[11],t[8]=b*n+x*s+E*h+P*y,t[9]=b*i+x*u+E*f+P*v,t[10]=b*o+x*c+E*d+P*g,t[11]=b*a+x*l+E*p+P*m,b=r[12],x=r[13],E=r[14],P=r[15],t[12]=b*n+x*s+E*h+P*y,t[13]=b*i+x*u+E*f+P*v,t[14]=b*o+x*c+E*d+P*g,t[15]=b*a+x*l+E*p+P*m,t}function O(t,e,r){var n,i,o,a,s,u,c,l,h,f,d,p,y=r[0],v=r[1],g=r[2];return e===t?(t[12]=e[0]*y+e[4]*v+e[8]*g+e[12],t[13]=e[1]*y+e[5]*v+e[9]*g+e[13],t[14]=e[2]*y+e[6]*v+e[10]*g+e[14],t[15]=e[3]*y+e[7]*v+e[11]*g+e[15]):(n=e[0],i=e[1],o=e[2],a=e[3],s=e[4],u=e[5],c=e[6],l=e[7],h=e[8],f=e[9],d=e[10],p=e[11],t[0]=n,t[1]=i,t[2]=o,t[3]=a,t[4]=s,t[5]=u,t[6]=c,t[7]=l,t[8]=h,t[9]=f,t[10]=d,t[11]=p,t[12]=n*y+s*v+h*g+e[12],t[13]=i*y+u*v+f*g+e[13],t[14]=o*y+c*v+d*g+e[14],t[15]=a*y+l*v+p*g+e[15]),t}function M(t,e,r,n,i,o,a){var s=1/(e-r),u=1/(n-i),c=1/(o-a);return t[0]=-2*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*u,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*c,t[11]=0,t[12]=(e+r)*s,t[13]=(i+n)*u,t[14]=(a+o)*c,t[15]=1,t}function N(t,e,r){var n=new A(3);return n[0]=t,n[1]=e,n[2]=r,n}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var L,_;L=new A(3),A!=Float32Array&&(L[0]=0,L[1]=0,L[2]=0),_=L;function B(){var t=new A(4);return A!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}function F(t,e,r,n){var i=new A(4);return i[0]=t,i[1]=e,i[2]=r,i[3]=n,i}function U(t,e,r,n,i){return t[0]=e,t[1]=r,t[2]=n,t[3]=i,t}function j(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}function G(t,e,r){var n=e[0],i=e[1],o=e[2],a=e[3];return t[0]=r[0]*n+r[4]*i+r[8]*o+r[12]*a,t[1]=r[1]*n+r[5]*i+r[9]*o+r[13]*a,t[2]=r[2]*n+r[6]*i+r[10]*o+r[14]*a,t[3]=r[3]*n+r[7]*i+r[11]*o+r[15]*a,t}!function(){var t=B()}();function X(t,e,r,n,i,o,a,s){var u=new A(8);return u[0]=t,u[1]=e,u[2]=r,u[3]=n,u[4]=i,u[5]=o,u[6]=a,u[7]=s,u}function Y(t,e){var r=new A(2);return r[0]=t,r[1]=e,r}function z(t,e,r){var n=e[0],i=e[1];return t[0]=r[0]*n+r[4]*i+r[12],t[1]=r[1]*n+r[5]*i+r[13],t}!function(){var t=function(){var t=new A(2);return A!=Float32Array&&(t[0]=0,t[1]=0),t}()}();var V=function(){function t(r,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;e(this,t),this.x=r,this.y=n,this.z=i}return I(t,[{key:"transform",value:function(e){if(!e)return this;var r=N(this.x,this.y,this.z||0);return function(t,e,r){var n=e[0],i=e[1],o=e[2],a=r[3]*n+r[7]*i+r[11]*o+r[15];a=a||1,t[0]=(r[0]*n+r[4]*i+r[8]*o+r[12])/a,t[1]=(r[1]*n+r[5]*i+r[9]*o+r[13])/a,t[2]=(r[2]*n+r[6]*i+r[10]*o+r[14])/a}(r,r,e.toFloat32Array()),new t(r[0],r[1],r[2])}},{key:"toString",value:function(){return"point(".concat(this.x,", ").concat(this.y,", ").concat(this.z||0,")")}},{key:"toJSON",value:function(){return{x:this.x,y:this.y,z:this.z}}}],[{key:"fromPoint",value:function(e){return new t(e.x,e.y,e.z)}}]),t}(),H={TRANSPERENT:{red:0,green:0,blue:0,alpha:0},BLACK:{red:0,green:0,blue:0,alpha:1},WHITE:{red:255,green:255,blue:255,alpha:1},RED:{red:255,green:0,blue:0,alpha:1},GREEN:{red:0,green:255,blue:0,alpha:1},BLUE:{red:0,green:0,blue:255,alpha:1},init:function(t){t.ready||(Object.defineProperty(t,"ready",{value:!0}),Object.defineProperty(t,"asRGB",{get:function(){return H.from(this.red,this.green,this.blue)}}),Object.defineProperty(t,"asHSLA",{get:function(){return H.toHSLA(this)}}),Object.defineProperty(t,"asHex",{get:function(){return H.toHex(this)}}),Object.defineProperty(t,"asArray",{get:function(){return H.toArray(this)}}))},from:function(t,e,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,i=t;if(t instanceof Array){var o=t;i=o[0],e=o[1],r=o[2],n=o[3]}var a={red:i,green:e,blue:r,alpha:n};return this.init(a),a},premultiply:function(t){return{red:t.red/255*t.alpha,green:t.green/255*t.alpha,blue:t.blue/255*t.alpha,alpha:t.alpha}},postdivide:function(t,e,r,n){var i=parseInt(255*t/n),o=parseInt(255*e/n),a=parseInt(255*r/n);return H.from(i,o,a,n)},equals:function(t,e){return!(!H.is(t)&&!H.is(e))&&(t.red==e.red&&t.green==e.green&&t.blue==e.blue&&t.alpha==e.alpha)},is:function(t){return t&&"red"in t&&"green"in t&&"blue"in t},toArray:function(t){return[t.red,t.green,t.blue,t.alpha]},fromHSLA:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3?arguments[3]:void 0;t/=60,e/=100,r/=100;var i=(1-Math.abs(2*r-1))*e,o=i*(1-Math.abs(t%2-1)),a=0,s=0,u=0;t>=0&&t<1?(a=i,s=o):t>=1&&t<2?(a=o,s=i):t>=2&&t<3?(s=i,u=o):t>=3&&t<4?(s=o,u=i):t>=4&&t<5?(a=o,u=i):(a=i,u=o);var c=r-i/2;return a+=c,s+=c,u+=c,H.from(Math.round(255*a),Math.round(255*s),Math.round(255*u),n)},toHSLA:function(t){var e=t.red/255,r=t.green/255,n=t.blue/255,i=Math.min(e,r,n),o=Math.max(e,r,n),a=0,s=0,u=(o+i)/2;if(o!=i){var c=o-i;switch(s=c/(1-Math.abs(2*u-1)),o){case e:a=(r-n)/c%6;break;case r:a=(n-e)/c+2;break;case n:a=(e-r)/c+4}}return(a*=60)<0&&(a+=360),{hue:parseFloat(a.toFixed(0)),saturation:parseFloat((100*s).toFixed(2)),lightness:parseFloat((100*u).toFixed(2)),alpha:t.alpha}},fromHex:function(t){return t=t.substring(1),H.from(parseInt(t.substring(0,2),16),parseInt(t.substring(2,4),16),parseInt(t.substring(4,6),16))},toHex:function(t){return"#"+t.red.toString(16).pad(2,"0")+t.green.toString(16).pad(2,"0")+t.blue.toString(16).pad(2,"0")},random:function(t){return H.from(Math.randomInt(0,255),Math.randomInt(0,255),Math.randomInt(0,255),t?Math.random():1)}};!function(){for(var t in H)"object"==a(H[t])&&H.init(H[t])}();var W=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=c(t)););return t},q=n((function(t){function e(r,n,i){return"undefined"!=typeof Reflect&&Reflect.get?t.exports=e=Reflect.get:t.exports=e=function(t,e,r){var n=W(t,e);if(n){var i=Object.getOwnPropertyDescriptor(n,e);return i.get?i.get.call(r):i.value}},e(r,n,i||r)}t.exports=e})),Z=function(){function t(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:C();e(this,t),this.value=r,Object.defineProperty(this,"a",{get:function(){return r[t.INDEX_2D.a]},enumerable:!0}),Object.defineProperty(this,"b",{get:function(){return r[t.INDEX_2D.b]},enumerable:!0}),Object.defineProperty(this,"c",{get:function(){return r[t.INDEX_2D.c]},enumerable:!0}),Object.defineProperty(this,"d",{get:function(){return r[t.INDEX_2D.d]},enumerable:!0}),Object.defineProperty(this,"tx",{get:function(){return r[t.INDEX_2D.tx]},enumerable:!0}),Object.defineProperty(this,"ty",{get:function(){return r[t.INDEX_2D.ty]},enumerable:!0}),Object.defineProperty(this,"m00",{get:function(){return r[t.INDEX.m00]},enumerable:!0}),Object.defineProperty(this,"m01",{get:function(){return r[t.INDEX.m01]},enumerable:!0}),Object.defineProperty(this,"m02",{get:function(){return r[t.INDEX.m02]},enumerable:!0}),Object.defineProperty(this,"m03",{get:function(){return r[t.INDEX.m03]},enumerable:!0}),Object.defineProperty(this,"m10",{get:function(){return r[t.INDEX.m10]},enumerable:!0}),Object.defineProperty(this,"m11",{get:function(){return r[t.INDEX.m11]},enumerable:!0}),Object.defineProperty(this,"m12",{get:function(){return r[t.INDEX.m12]},enumerable:!0}),Object.defineProperty(this,"m13",{get:function(){return r[t.INDEX.m13]},enumerable:!0}),Object.defineProperty(this,"m20",{get:function(){return r[t.INDEX.m20]},enumerable:!0}),Object.defineProperty(this,"m21",{get:function(){return r[t.INDEX.m21]},enumerable:!0}),Object.defineProperty(this,"m22",{get:function(){return r[t.INDEX.m22]},enumerable:!0}),Object.defineProperty(this,"m23",{get:function(){return r[t.INDEX.m23]},enumerable:!0}),Object.defineProperty(this,"m30",{get:function(){return r[t.INDEX.m30]},enumerable:!0}),Object.defineProperty(this,"m31",{get:function(){return r[t.INDEX.m31]},enumerable:!0}),Object.defineProperty(this,"m32",{get:function(){return r[t.INDEX.m32]},enumerable:!0}),Object.defineProperty(this,"m33",{get:function(){return r[t.INDEX.m33]},enumerable:!0})}return I(t,[{key:"isIdentity",value:function(){return 1==this.a&&0==this.b&&0==this.c&&1==this.d&&0==this.tx&&0==this.ty}},{key:"translate",value:function(e){return this.multiply(t.fromTranslate(e))}},{key:"rotate",value:function(e,r){return this.multiply(t.fromRotate(e,r))}},{key:"scale",value:function(e,r){return this.multiply(t.fromScale(e,r))}},{key:"multiply",value:function(e){var r=C();return D(r,e.toFloat32Array(),this.value),new t(r)}},{key:"invert",value:function(){var e=C();return function(t,e){var r=e[0],n=e[1],i=e[2],o=e[3],a=e[4],s=e[5],u=e[6],c=e[7],l=e[8],h=e[9],f=e[10],d=e[11],p=e[12],y=e[13],v=e[14],g=e[15],m=r*s-n*a,b=r*u-i*a,x=r*c-o*a,E=n*u-i*s,P=n*c-o*s,k=i*c-o*u,w=l*y-h*p,R=l*v-f*p,S=l*g-d*p,I=h*v-f*y,T=h*g-d*y,A=f*g-d*v,C=m*A-b*T+x*I+E*S-P*R+k*w;C&&(C=1/C,t[0]=(s*A-u*T+c*I)*C,t[1]=(i*T-n*A-o*I)*C,t[2]=(y*k-v*P+g*E)*C,t[3]=(f*P-h*k-d*E)*C,t[4]=(u*S-a*A-c*R)*C,t[5]=(r*A-i*S+o*R)*C,t[6]=(v*x-p*k-g*b)*C,t[7]=(l*k-f*x+d*b)*C,t[8]=(a*T-s*S+c*w)*C,t[9]=(n*S-r*T-o*w)*C,t[10]=(p*P-y*x+g*m)*C,t[11]=(h*x-l*P-d*m)*C,t[12]=(s*R-a*I-u*w)*C,t[13]=(r*I-n*R+i*w)*C,t[14]=(y*b-p*E-v*m)*C,t[15]=(l*E-h*b+f*m)*C)}(e,this.value),new t(e)}},{key:"disassemble",value:function(){return{translate:{x:this.tx,y:this.ty},rotate:{angle:Math.atan2(this.b,this.a)},skew:{angleX:Math.tan(this.c),angleY:Math.tan(this.b)},scale:{x:Math.sqrt(this.a*this.a+this.c*this.c),y:Math.sqrt(this.d*this.d+this.b*this.b)},matrix:this.toJSON()}}},{key:"toFloat32Array",value:function(){return this.value}},{key:"toJSON",value:function(){return{a:this.a,b:this.b,c:this.c,d:this.d,tx:this.tx,ty:this.ty}}},{key:"toString",value:function(){return"matrix(".concat(this.a,", ").concat(this.b,", ").concat(this.c,", ").concat(this.d,", ").concat(this.tx,", ").concat(this.ty,")")}}],[{key:"fromString",value:function(e){var r=C();return"none"!=e&&(e=e.substring(e.indexOf("(")+1,e.indexOf(")")).split(/,\s*/g),r[t.INDEX_2D.a]=parseFloat(e[0]),r[t.INDEX_2D.b]=parseFloat(e[1]),r[t.INDEX_2D.c]=parseFloat(e[2]),r[t.INDEX_2D.d]=parseFloat(e[3]),r[t.INDEX_2D.dx]=parseFloat(e[4]),r[t.INDEX_2D.dy]=parseFloat(e[5])),new t(r)}},{key:"create",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:C();if(Array.isArray(e)&&(e=new Float32Array(e)),e instanceof Float32Array)return new t(e);var r={a:1,b:0,c:0,d:1,tx:0,ty:0};isFinite(e.a)&&(r.a=e.a),isFinite(e.b)&&(r.b=e.b),isFinite(e.c)&&(r.c=e.c),isFinite(e.d)&&(r.d=e.d),r.tx=e.tx||e.dx||0,r.ty=e.ty||e.dy||0;var n=C();return n[t.INDEX_2D.a]=r.a,n[t.INDEX_2D.b]=r.b,n[t.INDEX_2D.c]=r.c,n[t.INDEX_2D.d]=r.d,n[t.INDEX_2D.tx]=r.tx,n[t.INDEX_2D.ty]=r.ty,new t(n)}},{key:"fromTranslate",value:function(e){var r=isFinite(e)?{tx:e,ty:e}:{tx:e.x,ty:e.y};return t.create(r)}},{key:"fromRotate",value:function(e,r){var n=Math.sin(e),i=Math.cos(e),o={a:i,b:n,c:-n,d:i};return r&&(o.tx=r.x-r.x*i+r.y*n,o.ty=r.y-r.x*n-r.y*i),t.create(o)}},{key:"fromScale",value:function(e,r){isFinite(e)&&(e={x:e,y:e});var n={a:e.x,d:e.y};return r&&(n.tx=r.x-r.x*e.x,n.ty=r.y-r.y*e.y),t.create(n)}}]),t}();function J(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}Z.INDEX={m00:0,m01:1,m02:2,m03:3,m10:4,m11:5,m12:6,m13:7,m20:8,m21:9,m22:10,m23:11,m30:12,m31:13,m32:14,m33:15},Z.INDEX_2D={a:0,b:1,c:4,d:5,tx:12,ty:13};var K=function(t){o(i,t);var r,n=(r=i,function(){var t,e=c(r);if(J()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function i(t,r,o){var a;return e(this,i),(a=n.call(this,t,r,o)).x=t,a.y=r,isFinite(o)&&(a.z=o),a.red,a.green,a.blue,a.alpha,a.size,a.rotation,a.scaleX,a.scaleY,a.scaleZ,a.offsetX,a.offsetY,a.offsetZ,a.dX,a.dY,a}return I(i,[{key:"fill",value:function(t,e){var r=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=t.length;t.forEach((function(t,o){return r.setProperty(t,e[n*i+o])}))}},{key:"getProperty",value:function(t){switch(t){case i.Property.X:return this.x;case i.Property.Y:return this.y;case i.Property.Z:return this.z;case i.Property.RED:return this.red;case i.Property.GREEN:return this.green;case i.Property.BLUE:return this.blue;case i.Property.ALPHA:return this.alpha;case i.Property.SIZE:return this.size;case i.Property.ROTATION:return this.rotation;case i.Property.SCALE_X:return this.scaleX;case i.Property.SCALE_Y:return this.scaleY;case i.Property.SCALE_Z:return this.scaleZ;case i.Property.OFFSET_X:return this.offsetX;case i.Property.OFFSET_Y:return this.offsetY;case i.Property.OFFSET_Z:return this.offsetZ;case i.Property.D_X:return this.dX;case i.Property.D_Y:return this.dY;default:throw console.warn(t),new Error("Invalid property found")}}},{key:"setProperty",value:function(t,e){switch(t){case i.Property.X:this.x=e;break;case i.Property.Y:this.y=e;break;case i.Property.Z:this.z=e;break;case i.Property.RED:this.red=e;break;case i.Property.GREEN:this.green=e;break;case i.Property.BLUE:this.blue=e;break;case i.Property.ALPHA:this.alpha=e;break;case i.Property.SIZE:this.size=e;break;case i.Property.ROTATION:this.rotation=e;break;case i.Property.SCALE_X:this.scaleX=e;break;case i.Property.SCALE_Y:this.scaleY=e;break;case i.Property.SCALE_Z:this.scaleZ=e;break;case i.Property.OFFSET_X:this.offsetX=e;break;case i.Property.OFFSET_Y:this.offsetY=e;break;case i.Property.OFFSET_Z:this.offsetZ=e;break;case i.Property.D_X:this.dX=e;break;case i.Property.D_Y:this.dY=e;break;default:throw console.warn(t),new Error("Invalid property found")}}},{key:"transform",value:function(t){t instanceof Z||(t=Z.create(t));var e=Math.pow(Math.pow(t.a,2)+Math.pow(t.c,2),.5),r=q(c(i.prototype),"transform",this).call(this,t);this.x=r.x,this.y=r.y,this.z=r.z||0,this.size*=e,this.scaleX*=e,this.scaleY*=e,this.scaleZ*=e,this.offsetX*=e,this.offsetY*=e,this.offsetZ*=e}},{key:"asArray",value:function(t){var e=this;return t.map((function(t){var r=e.getProperty(t);if(null==r||!isFinite(r))throw new Error("Property ".concat(t.name," has invalid value ").concat(r));return r}))}},{key:"debug",value:function(){var t=this,e=[];return i.Property.values.forEach((function(r){var n=t.getProperty(r);null!=n&&isFinite(n)&&e.push(r.name,t.getProperty(r))})),e}}],[{key:"createInstance",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=new i;return r.x=e.x,r.y=e.y,r.z=e.z,r.red=t.red,r.green=t.green,r.blue=t.blue,r.alpha=t.alpha,r.size=t.size,r.rotation=t.rotation||0,r.scaleX=t.scaleX||1,r.scaleY=t.scaleY||1,r.scaleZ=t.scaleZ||1,r.offsetX=t.offsetX||0,r.offsetY=t.offsetY||0,r.offsetZ=t.offsetZ||0,r}}]),i}(V);K.createEnum("Property",["X","Y","Z","RED","GREEN","BLUE","ALPHA","SIZE","ROTATION","SCALE_X","SCALE_Y","SCALE_Z","OFFSET_X","OFFSET_Y","OFFSET_Z","D_X","D_Y"]);var Q=function(){function t(r,n,i,o){e(this,t);var a=i-r,s=n-o,u=(r+i)/2,c=(o+n)/2;Object.defineProperties(this,{left:{value:r,enumerable:!0},x:{value:r,enumerable:!0},bottom:{value:n,enumerable:!0},y:{value:n,enumerable:!0},right:{value:i,enumerable:!0},top:{value:o,enumerable:!0},width:{value:i-r,enumerable:!0},height:{value:o-n,enumerable:!0},center:{value:{x:u,y:c},enumerable:!0},size:{value:{width:a,height:s},enumerable:!0}})}return I(t,[{key:"union",value:function(e){if(e&&!(e instanceof t))throw new TypeError("rect must be instance of GLRect");return e?new t(Math.min(this.left,e.left),Math.min(this.bottom,e.bottom),Math.max(this.right,e.right),Math.max(this.top,e.top)):this}},{key:"intersect",value:function(e){if(e&&!(e instanceof t))throw new TypeError("rect must be instance of GLRect");if(!e)return null;var r=new t(Math.max(this.left,e.left),Math.max(this.bottom,e.bottom),Math.min(this.right,e.right),Math.min(this.top,e.top));return r.width>0&&r.height>0?r:null}},{key:"ceil",value:function(){return new t(Math.floor(this.left),Math.floor(this.bottom),Math.ceil(this.right),Math.ceil(this.top))}},{key:"floor",value:function(){return new t(Math.ceil(this.left),Math.ceil(this.bottom),Math.floor(this.right),Math.floor(this.top))}},{key:"toQuad",value:function(t){var e;if(t){var r=V.fromPoint({x:this.left,y:this.bottom}).transform(t),n=V.fromPoint({x:this.right,y:this.bottom}).transform(t),i=V.fromPoint({x:this.left,y:this.top}).transform(t),o=V.fromPoint({x:this.right,y:this.top}).transform(t);e=X(r.x,r.y,n.x,n.y,i.x,i.y,o.x,o.y)}else e=X(this.left,this.bottom,this.right,this.bottom,this.left,this.top,this.right,this.top);return e}}],[{key:"makeWithSize",value:function(e,r,n,i){return new t(e,r,e+n,r+i)}},{key:"calculateBrushGLSegmentBounds",value:function(e,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:C(),i=[{x:-1,y:-1},{x:1,y:-1},{x:-1,y:1},{x:1,y:1}],o=.5*e.size,a=Math.abs(r*o),s=Y(e.x,e.y);z(s,s,n);var u=s[0],c=s[1],l=e.scaleX*o,h=e.scaleY*o,f=e.offsetX,d=-e.offsetY,p=Math.cos(e.rotation),y=Math.sin(e.rotation),v=Number.MAX_SAFE_INTEGER,g=Number.MIN_SAFE_INTEGER,m=Number.MAX_SAFE_INTEGER,b=Number.MIN_SAFE_INTEGER;return i.forEach((function(t){t.x=t.x*l+f,t.y=t.y*h+d;var e=p*t.x+y*t.y+u,r=-y*t.x+p*t.y+c,n=e-a;v=Math.min(v,n),g=Math.max(g,n),n=e+a,v=Math.min(v,n),g=Math.max(g,n);var i=r-a;m=Math.min(m,i),b=Math.max(b,i),i=r+a,m=Math.min(m,i),b=Math.max(b,i)})),t.makeWithSize(v,m,g-v,b-m)}}]),t}(),$=function(){function t(r,n,i,o){e(this,t);var a=i-r,s=o-n,u=(r+i)/2,c=(n+o)/2,l=a/2,h=s/2;Object.defineProperties(this,{left:{value:r,enumerable:!0},top:{value:n,enumerable:!0},right:{value:i,enumerable:!0},bottom:{value:o,enumerable:!0},x:{value:r,enumerable:!0},y:{value:n,enumerable:!0},width:{value:a,enumerable:!0},height:{value:s,enumerable:!0},center:{value:{x:u,y:c},enumerable:!0},origin:{value:{x:l,y:h},enumerable:!0},size:{value:{width:a,height:s},enumerable:!0}})}return I(t,[{key:"union",value:function(e){return e?new t(Math.min(this.left,e.left),Math.min(this.top,e.top),Math.max(this.right,e.right),Math.max(this.bottom,e.bottom)):this}},{key:"intersect",value:function(e){if(!e)return null;var r=new t(Math.max(this.left,e.left),Math.max(this.top,e.top),Math.min(this.right,e.right),Math.min(this.bottom,e.bottom));return r.width>0&&r.height>0?r:null}},{key:"ceil",value:function(e){var r=Math.floor(this.left),n=Math.floor(this.top),i=Math.ceil(this.right),o=Math.ceil(this.bottom);if(e){var a=i-r,s=o-n;i=r+(a+=a%2),o=n+(s+=s%2)}return new t(r,n,i,o)}},{key:"floor",value:function(e){var r=Math.ceil(this.left),n=Math.ceil(this.top),i=Math.floor(this.right),o=Math.floor(this.bottom);if(e){var a=i-r,s=o-n;i=r+(a-=a%2),o=n+(s-=s%2)}return new t(r,n,i,o)}},{key:"contains",value:function(t){return this.left<=t.x&&this.right>=t.x&&this.top<=t.y&&this.bottom>=t.y}},{key:"transform",value:function(t){if(!t)return this;var e=V.fromPoint({x:this.left,y:this.top}).transform(t),r=V.fromPoint({x:this.right,y:this.top}).transform(t),n=V.fromPoint({x:this.left,y:this.bottom}).transform(t),i=V.fromPoint({x:this.right,y:this.bottom}).transform(t),o=Math.min(e.x,r.x,n.x,i.x),a=Math.min(e.y,r.y,n.y,i.y),s=Math.max(e.x,r.x,n.x,i.x),u=Math.max(e.y,r.y,n.y,i.y);return DOMRect.ofEdges(o,a,s,u)}},{key:"toPath",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:H.BLACK,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return{layout:[K.Property.X,K.Property.Y],size:e,color:t,ts:0,tf:1,points:[this.left,this.top,this.left,this.top,this.right,this.top,this.right,this.bottom,this.left,this.bottom,this.left,this.top,this.left,this.top]}}},{key:"toGLRect",value:function(){return Q.makeWithSize(this.x,this.y,this.width,this.height)}},{key:"toString",value:function(){return"rect(".concat(this.x,", ").concat(this.y,", ").concat(this.width,", ").concat(this.height,")")}},{key:"toJSON",value:function(){return{x:this.left,y:this.top,width:this.width,height:this.height}}}],[{key:"fromGLRect",value:function(e){if(!e)return null;if(!(e instanceof Q))throw new TypeError("rect must be instance of GLRect");return t.makeWithSize(e.left,e.bottom,e.width,e.height)}},{key:"isRect",value:function(t){return t&&isFinite(t.left)&&isFinite(t.top)&&isFinite(t.width)&&isFinite(t.height)}},{key:"fromRect",value:function(e){return new t(e.left,e.top,e.right,e.bottom)}},{key:"ofPolygon",value:function(e){return t.ofPolygons([e])}},{key:"ofPolygons",value:function(e){if(!e.length)return null;var r=Number.MAX_SAFE_INTEGER,n=Number.MAX_SAFE_INTEGER,i=Number.MIN_SAFE_INTEGER,o=Number.MIN_SAFE_INTEGER;return e.forEach((function(t){for(var e=0;e<t.length;e+=2){var a=t[e],s=t[e+1];r=Math.min(r,a),n=Math.min(n,s),i=Math.max(i,a),o=Math.max(o,s)}})),t.make(r,n,i,o)}},{key:"ofSpline",value:function(e,r,n){for(var i,o=0;o<e.length;o++)i=Q.calculateBrushGLSegmentBounds(e.getPoint(o),r,n).union(i);return t.fromGLRect(i)}},{key:"ofEdges",value:function(e,r,n,i){return new t(e,r,n,i)}},{key:"create",value:function(e,r,n,i){return new t(e,r,e+n,r+i)}},{key:"make",value:function(e,r,n,i){return new t(e,r,n,i)}},{key:"makeWithSize",value:function(e,r,n,i){return new t(e,r,e+n,r+i)}},{key:"union",value:function(t,e){return t?e?t.union(e):t:e}},{key:"intersect",value:function(t,e){return t&&e?t.intersect(e):null}}]),t}(),tt=(m.commonJS,ClipperLib),et=tt.Clipper,rt=tt.Paths,nt=tt.Path,it=tt.ClipType,ot=tt.PolyType,at=tt.PolyFillType,st=function(){function t(r){e(this,t);var n=new rt;"number"==typeof r[0]&&(r=[r]);var i=$.ofPolygons(r),o=65534/(i.width+1e-16),a=65534/(i.height+1e-16),s=Math.floor(Math.min(o,a)),u=i.left+32767/s,c=i.top+32767/s;r.forEach((function(t){for(var e=new nt,r=0;r<t.length;r+=2){var i=(t[r]-u)*s,o=(t[r+1]-c)*s,a=i<0?Math.ceil(i):Math.floor(i),l=o<0?Math.ceil(o):Math.floor(o);e.push({X:a,Y:l})}n.push(e)})),this.subject=n,this.solution=new rt,this.bounds=i,this.transform={scale:s,offsetX:u,offsetY:c}}return I(t,[{key:"toPath2D",value:function(){var t=this;return this.lastPoint={},this.solution.map((function(e){return t.flatPath(e)}))}},{key:"flatPath",value:function(t){var e=this,r=[];return t.forEach((function(t){e.lastPoint.X==t.X&&e.lastPoint.Y==t.Y||(r.push(t.X/e.transform.scale+e.transform.offsetX,t.Y/e.transform.scale+e.transform.offsetY),e.lastPoint=t)})),r}},{key:"apply",value:function(t){var e=this,r=new rt;return"number"==typeof t[0]&&(t=[t]),t.forEach((function(t){for(var n=new nt,i=0;i<t.length;i+=2){var o=(t[i]-e.transform.offsetX)*e.transform.scale,a=(t[i+1]-e.transform.offsetY)*e.transform.scale,s=o<0?Math.ceil(o):Math.floor(o),u=a<0?Math.ceil(a):Math.floor(a);n.push({X:s,Y:u})}r.push(n)})),r}}]),t}(),ut=function(){function t(){e(this,t)}return I(t,null,[{key:"union",value:function(t){var e=new st(t),r=new et;return r.StrictlySimple=!0,r.AddPaths(e.subject,ot.ptSubject,!0),r.Execute(it.ctUnion,e.solution,at.pftNonZero,at.pftNonZero),e.toPath2D()}},{key:"intersection",value:function(t,e){t instanceof st||(t=new st(t)),t.clip=t.apply(e);var r=new et;return r.StrictlySimple=!0,r.AddPaths(t.subject,ot.ptSubject,!0),r.AddPaths(t.clip,ot.ptClip,!0),r.Execute(it.ctIntersection,t.solution,at.pftNonZero,at.pftNonZero),t.solution.length>0?t:null}},{key:"createClipperPath",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:32,r=new nt;r.scale=e;for(var n=0;n<t.length;n++){var i=n*t.stride;r.push({X:Math.round(t.points[i]*e),Y:Math.round(t.points[i+1]*e)})}return r}},{key:"containsPoint",value:function(t,e){var r={X:Math.round(e.x*t.scale),Y:Math.round(e.y*t.scale)};return 1==et.PointInPolygon(r,t)}}]),t}(),ct=n((function(t){var e=function(t){var e=Object.prototype,r=e.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},i=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",a=n.toStringTag||"@@toStringTag";function s(t,e,r,n){var i=e&&e.prototype instanceof l?e:l,o=Object.create(i.prototype),a=new P(n||[]);return o._invoke=function(t,e,r){var n="suspendedStart";return function(i,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===i)throw o;return w()}for(r.method=i,r.arg=o;;){var a=r.delegate;if(a){var s=b(a,r);if(s){if(s===c)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var l=u(t,e,r);if("normal"===l.type){if(n=r.done?"completed":"suspendedYield",l.arg===c)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(n="completed",r.method="throw",r.arg=l.arg)}}}(t,r,a),o}function u(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}t.wrap=s;var c={};function l(){}function h(){}function f(){}var d={};d[i]=function(){return this};var p=Object.getPrototypeOf,y=p&&p(p(k([])));y&&y!==e&&r.call(y,i)&&(d=y);var v=f.prototype=l.prototype=Object.create(d);function g(t){["next","throw","return"].forEach((function(e){t[e]=function(t){return this._invoke(e,t)}}))}function m(t,e){var n;this._invoke=function(i,o){function a(){return new e((function(n,a){!function n(i,o,a,s){var c=u(t[i],t,o);if("throw"!==c.type){var l=c.arg,h=l.value;return h&&"object"==typeof h&&r.call(h,"__await")?e.resolve(h.__await).then((function(t){n("next",t,a,s)}),(function(t){n("throw",t,a,s)})):e.resolve(h).then((function(t){l.value=t,a(l)}),(function(t){return n("throw",t,a,s)}))}s(c.arg)}(i,o,n,a)}))}return n=n?n.then(a,a):a()}}function b(t,e){var r=t.iterator[e.method];if(void 0===r){if(e.delegate=null,"throw"===e.method){if(t.iterator.return&&(e.method="return",e.arg=void 0,b(t,e),"throw"===e.method))return c;e.method="throw",e.arg=new TypeError("The iterator does not provide a 'throw' method")}return c}var n=u(r,t.iterator,e.arg);if("throw"===n.type)return e.method="throw",e.arg=n.arg,e.delegate=null,c;var i=n.arg;return i?i.done?(e[t.resultName]=i.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=void 0),e.delegate=null,c):i:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,c)}function x(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function E(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function P(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(x,this),this.reset(!0)}function k(t){if(t){var e=t[i];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var n=-1,o=function e(){for(;++n<t.length;)if(r.call(t,n))return e.value=t[n],e.done=!1,e;return e.value=void 0,e.done=!0,e};return o.next=o}}return{next:w}}function w(){return{value:void 0,done:!0}}return h.prototype=v.constructor=f,f.constructor=h,f[a]=h.displayName="GeneratorFunction",t.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===h||"GeneratorFunction"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,f):(t.__proto__=f,a in t||(t[a]="GeneratorFunction")),t.prototype=Object.create(v),t},t.awrap=function(t){return{__await:t}},g(m.prototype),m.prototype[o]=function(){return this},t.AsyncIterator=m,t.async=function(e,r,n,i,o){void 0===o&&(o=Promise);var a=new m(s(e,r,n,i),o);return t.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},g(v),v[a]="Generator",v[i]=function(){return this},v.toString=function(){return"[object Generator]"},t.keys=function(t){var e=[];for(var r in t)e.push(r);return e.reverse(),function r(){for(;e.length;){var n=e.pop();if(n in t)return r.value=n,r.done=!1,r}return r.done=!0,r}},t.values=k,P.prototype={constructor:P,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(E),!t)for(var e in this)"t"===e.charAt(0)&&r.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=void 0)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var e=this;function n(r,n){return a.type="throw",a.arg=t,e.next=r,n&&(e.method="next",e.arg=void 0),!!n}for(var i=this.tryEntries.length-1;i>=0;--i){var o=this.tryEntries[i],a=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),u=r.call(o,"finallyLoc");if(s&&u){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===t||"continue"===t)&&o.tryLoc<=e&&e<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=t,a.arg=e,o?(this.method="next",this.next=o.finallyLoc,c):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),c},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),E(r),c}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var i=n.arg;E(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,r){return this.delegate={iterator:k(t),resultName:e,nextLoc:r},"next"===this.method&&(this.arg=void 0),c}},t}(t.exports);try{regeneratorRuntime=e}catch(t){Function("r","regeneratorRuntime = r")(e)}}));function lt(t,e,r,n,i,o,a){try{var s=t[o](a),u=s.value}catch(t){return void r(t)}s.done?e(u):Promise.resolve(u).then(n,i)}var ht=function(t){return function(){var e=this,r=arguments;return new Promise((function(n,i){var o=t.apply(e,r);function a(t){lt(o,n,i,a,s,"next",t)}function s(t){lt(o,n,i,a,s,"throw",t)}a(void 0)}))}};function ft(t){if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(t=function(t,e){if(!t)return;if("string"==typeof t)return dt(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(r);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return dt(t,e)}(t))){var e=0,r=function(){};return{s:r,n:function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}},e:function(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,i,o=!0,a=!1;return{s:function(){n=t[Symbol.iterator]()},n:function(){var t=n.next();return o=t.done,t},e:function(t){a=!0,i=t},f:function(){try{o||null==n.return||n.return()}finally{if(a)throw i}}}}function dt(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function pt(t){return yt.apply(this,arguments)}function yt(){return(yt=ht(ct.mark((function t(e){var r,n,i,o,a=arguments;return ct.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=a.length>1&&void 0!==a[1]?a[1]:"binary",!(e instanceof Uint8Array)){t.next=3;break}return t.abrupt("return",e);case 3:return t.next=5,fetch(e,{mode:"no-cors"});case 5:if(i=t.sent,"json"!=r){t.next=12;break}return t.next=9,i.json();case 9:n=t.sent,t.next=28;break;case 12:if("text"!=r){t.next=18;break}return t.next=15,i.text();case 15:n=t.sent,t.next=28;break;case 18:if("blob"!=r){t.next=24;break}return t.next=21,i.blob();case 21:n=t.sent,t.next=28;break;case 24:return t.next=26,i.arrayBuffer();case 26:o=t.sent,n=new Uint8Array(o);case 28:return t.abrupt("return",n);case 29:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function vt(t){return new Promise((function(e,r){var n=new Image;n.crossOrigin="anonymous",n.onload=function(){if(m.type2D==m.Type2D.OFFSCREEN){var t=new OffscreenCanvas(n.width,n.height);t.getContext("2d").drawImage(n,0,0),e(t)}else e(n)},n.onerror=r,"string"==typeof t?n.src=t:m.type2D==m.Type2D.OFFSCREEN?t instanceof Uint8Array?n.src=Buffer.from(t):t instanceof OffscreenCanvas?e(t):n.src=t:n.src=URL.createObjectURL(t)}))}function gt(t){return mt.apply(this,arguments)}function mt(){return(mt=ht(ct.mark((function t(e){var r;return ct.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if("string"!=typeof e&&"undefined"!=typeof createImageBitmap){t.next=6;break}return t.next=3,vt(e);case 3:r=t.sent,t.next=15;break;case 6:if(!(e instanceof ArrayBuffer||e instanceof Uint8Array)){t.next=12;break}return t.next=9,createImageBitmap(new Blob([e],{type:"image/png"}));case 9:r=t.sent,t.next=15;break;case 12:return t.next=14,createImageBitmap(e);case 14:r=t.sent;case 15:return t.abrupt("return",r);case 16:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function bt(t){return xt.apply(this,arguments)}function xt(){return(xt=ht(ct.mark((function t(e){var r,n,i,o,a,s,u;return ct.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!Array.isArray(e.shape)){t.next=24;break}i=[],o=ft(e.shape),t.prev=3,o.s();case 5:if((a=o.n()).done){t.next=13;break}return s=a.value,t.next=9,pt(s);case 9:u=t.sent,i.push(u);case 11:t.next=5;break;case 13:t.next=18;break;case 15:t.prev=15,t.t0=t.catch(3),o.e(t.t0);case 18:return t.prev=18,o.f(),t.finish(18);case 21:r=i,t.next=27;break;case 24:return t.next=26,pt(e.shape);case 26:r=t.sent;case 27:return t.next=29,pt(e.fill);case 29:return n=t.sent,t.abrupt("return",{shape:r,fill:n});case 31:case"end":return t.stop()}}),t,null,[[3,15,18,21]])})))).apply(this,arguments)}var Et=Object.freeze({__proto__:null,loadFile:pt,loadImage:gt,loadBrushGLBinary:bt,saveAs:function(t,e){var r,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"application/octet-stream";if(t instanceof Blob)r=URL.createObjectURL(t);else{var i;t instanceof ArrayBuffer?i=[t]:t.buffer?(t.byteLength<t.buffer.byteLength&&(t=new Uint8Array(t)),i=[t.buffer]):t instanceof Array&&(i=t);var o=new Blob(i,{type:n});r=URL.createObjectURL(o)}var a=document.createElement("a");a.href=r,a.download=e,a.appendChild(document.createTextNode(e)),a.style.display="none",document.body.appendChild(a),a.click(),setTimeout((function(){URL.revokeObjectURL(r),a.remove()}),911)}});var Pt=Object.freeze({__proto__:null,vector:function(t,e){var r,n={};return Object.defineProperty(n,"x",{value:e.x-t.x,enumerable:!0}),Object.defineProperty(n,"y",{value:e.y-t.y,enumerable:!0}),Object.defineProperty(n,"length",{get:function(){return isNaN(r)&&(r=Math.sqrt(n.x*n.x+n.y*n.y)),r},enumerable:!0}),n},angle:function(t,e){var r=t.x*e.x+t.y*e.y,n=t.x*e.y-t.y*e.x;return Math.atan2(n,r)}}),kt={a:0,b:1,c:4,d:5,dx:12,dy:13};function wt(t,e){var r=C(),n=isNaN(t)?t.x:t,i=isNaN(t)?t.y:t;return r[kt.a]=n,r[kt.b]=0,r[kt.c]=0,r[kt.d]=i,r[kt.dx]=e.x-e.x*n,r[kt.dy]=e.y-e.y*i,r}function Rt(t,e){var r=C(),n=Math.sin(t),i=Math.cos(t);return r[kt.a]=i,r[kt.b]=n,r[kt.c]=-n,r[kt.d]=i,r[kt.dx]=e.x-e.x*i+e.y*n,r[kt.dy]=e.y-e.x*n-e.y*i,r}function St(t){return function(t,e,r,n,i,o){var a=new A(6);return a[0]=t,a[1]=e,a[2]=r,a[3]=n,a[4]=i,a[5]=o,a}(t[kt.a],t[kt.b],t[kt.c],t[kt.d],t[kt.dx],t[kt.dy])}var It=Object.freeze({__proto__:null,MAT4_INDEX:{m00:0,m01:1,m02:2,m03:3,m10:4,m11:5,m12:6,m13:7,m20:8,m21:9,m22:10,m23:11,m30:12,m31:13,m32:14,m33:15},MAT2D_INDEX:kt,makeScaleAtPoint:wt,makeRotationAroundPoint:Rt,makeTransformAroundPoint:function(t,e,r){var n=C();return D(n,wt(e,r),Rt(t,r)),n},disassemble:function(t){var e=t[kt.a],r=t[kt.b],n=t[kt.c],i=t[kt.d],o=t[kt.dx],a=t[kt.dy];return{translate:{x:o,y:a},rotate:{angle:Math.atan2(r,e)},skew:{angleX:Math.tan(n),angleY:Math.tan(r)},scale:{x:Math.sqrt(e*e+n*n),y:Math.sqrt(i*i+r*r)},matrix:{a:e,b:r,c:n,d:i,tx:o,ty:a}}},fromCSS:function(t){var e=C(),r=t.getStyle("transform");return"none"!=r&&(r=r.substring(r.indexOf("(")+1,r.indexOf(")")).split(/,\s*/g),e[kt.a]=parseFloat(r[0]),e[kt.b]=parseFloat(r[1]),e[kt.c]=parseFloat(r[2]),e[kt.d]=parseFloat(r[3]),e[kt.dx]=parseFloat(r[4]),e[kt.dy]=parseFloat(r[5])),e},toCSS:function(t){var e=St(t);return A==Float32Array&&(e=e.toArray()),"matrix("+e.join(", ")+")"},fromMat2D:function(t,e,r,n,i,o){var a=C();return a[kt.a]=t,a[kt.b]=e,a[kt.c]=r,a[kt.d]=n,a[kt.dx]=i,a[kt.dy]=o,a},toMat2D:St}),Tt=function(){function t(r){var n=this;e(this,t),this.header=[],this.table=[],r.forEach((function(t){"string"==typeof t&&(t={name:t,title:t}),t.size=t.title.length,n.header.push(t)}))}return I(t,[{key:"insert",value:function(t){this.table.push(t),this.header.forEach((function(e){var r=t[e.name];null!=r&&(e.size=Math.max(e.size,r.toString().length))}))}},{key:"build",value:function(){var t=this,e=[],r=this.header.length+1,n=[];this.header.forEach((function(e){r+=e.size+2;var i=e.size-e.title.length,o=Math.floor(i/2),a=Math.ceil(i/2);n.push(t.getRepetedValue(o)+e.title+t.getRepetedValue(a))})),this.table.forEach((function(r){var n=[];t.header.forEach((function(e){var i=null==r[e.name]?"":r[e.name],o=e.size-i.toString().length;n.push(i+t.getRepetedValue(o))})),e.push(n)}));var i="";return i+=this.getRepetedValue(r,"="),i+="\n",i+=this.getFormattedRow(n),i+="\n",i+=this.getRepetedValue(r,"="),i+="\n",e.forEach((function(e){i+=t.getFormattedRow(e),i+="\n"})),i}},{key:"getFormattedRow",value:function(t){var e="| ";return t.forEach((function(t){e+=t,e+=" | "})),e.trim()}},{key:"getRepetedValue",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:" ";return new Array(t+1).join(e)}}]),t}(),At={longToByteArray:function(t){for(var e=[0,0,0,0,0,0,0,0],r=0;r<e.length;r++){var n=255&t;e[r]=n,t=(t-n)/256}return e},byteArrayToLong:function(t){for(var e=0,r=t.length-1;r>=0;r--)e=256*e+t[r];return e},crc32:function(){for(var t=new Uint32Array(256),e=256;e--;){for(var r=e,n=8;n--;)r=1&r?3988292384^r>>>1:r>>>1;t[e]=r}return function(e){for(var r=-1,n=0,i=e.length;n<i;n++)r=r>>>8^t[255&r^e[n]];return(-1^r)>>>0}}(),mapTo:function(t,e,r){return r.min+(At.clamp(t,e)-e.min)/(e.max-e.min)*(r.max-r.min)},clamp:function(t,e){return Math.min(Math.max(t,e.min),e.max)},comparator:function(){var t=Array.prototype.slice.call(arguments),e=function(t,e,r){var n="asc"===r?1:-1;return t>e?1*n:t<e?-1*n:0},r=function(t,e,r){return e.replace("[",".").replace("]","").split(".").forEach((function(e){return t=t[e]})),r?t.toLowerCase():t};return function(n,i){return t.map((function(t){return e(r(n,t.sortBy,t.ignoreCase),r(i,t.sortBy,t.ignoreCase),t.sortOrder)})).reduceRight((function(t,e){return e||t}))}},getPropName:function(t,e){var r=t.split("_"),n=r.first.toLowerCase();e&&(n=n.substring(0,1).toUpperCase()+n.substring(1));for(var i=1;i<r.length;i++)n+=r[i].substring(0,1),n+=r[i].substring(1).toLowerCase();return n},getEnumValueName:function(t){for(var e="",r=0;r<t.length;r++)r>0&&t[r]!=t[r].toLowerCase()&&(e+="_"),e+=t[r];return e.toUpperCase()}};var Ct=function(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t},Dt=function(){function t(){e(this,t)}return I(t,[{key:"getInkBuilder",value:function(){throw new Error("InkController.getInkBuilder(changedTouches = []) should be implemented")}},{key:"registerTouches",value:function(t){throw new Error("InkController.registerTouches(changedTouches) should be implemented")}},{key:"reset",value:function(t){throw new Error("InkController.reset(sensorPoint) should be implemented")}},{key:"begin",value:function(t){throw new Error("InkController.begin(sensorPoint) should be implemented")}},{key:"move",value:function(t){throw new Error("InkController.move(sensorPoint) should be implemented")}},{key:"end",value:function(t){throw new Error("InkController.end(sensorPoint) should be implemented")}},{key:"abort",value:function(){throw new Error("InkController.abort(sensorPoint) should be implemented")}},{key:"resize",value:function(){throw new Error("InkController.resize(sensorPoint) should be implemented")}}]),t}(),Ot={pointers:{pointer:["down","move","up"],mouse:["down","move","up"],touch:["start","move","end"]},open:function(t){if(!(t instanceof Dt))throw new Error("Argument doesn't implement InkController interface");this.inkController=t,this.canvas=t.canvas.surface,this.mounted||(this.mounted=!0,this.begin=this.begin.bind(this),this.move=this.move.bind(this),this.end=this.end.bind(this),this.abort=this.abort.bind(this)),addEventListener("pointercancel",this.abort),this.attachResize(),this.start()},reset:function(t){for(var e in this.pointers){var r="touch"==e?{passive:!0}:void 0,n=e+this.pointers[e][0];this.canvas.removeEventListener(n,this.begin),t.canvas.surface.addEventListener(n,this.begin,r)}this.dettachResize(),this.inkController=t,this.canvas=t.canvas.surface,this.attachResize()},close:function(){this.stop(),this.dettachResize(),removeEventListener("pointercancel",this.abort),delete this.canvas,delete this.inkController},start:function(t){var e=t?Ct({},t,this.pointers[t]):this.pointers;for(t in e)for(var r="touch"==t?{passive:!0}:void 0,n=0;n<e[t].length;n++){var i=t+e[t][n];0==n?this.canvas.addEventListener(i,this.begin,r):addEventListener(i,2==n?this.end:this.move,r)}},stop:function(t){var e=t?Ct({},t,this.pointers[t]):this.pointers;for(t in t&&"mouse"!=t||clearTimeout(this.timeoutID),e)for(var r=0;r<e[t].length;r++){var n=t+e[t][r];0==r?this.canvas.removeEventListener(n,this.begin):removeEventListener(n,2==r?this.end:this.move)}},attachResize:function(){var t,e,r,n=this;this.inkController.resize&&(this.resize=(t=function(){return n.inkController.resize()},e=200,r=null,function(){var n=this,i=arguments;clearTimeout(r),r=setTimeout((function(){t.apply(n,i)}),e)}),addEventListener("resize",this.resize))},dettachResize:function(){this.inkController.resize&&removeEventListener("resize",this.resize)},isInputAllowed:function(t){return this.provider==this.getInputProvider(t)&&(!t.pointerType||"pen"==t.pointerType)},isInputExpected:function(t){var e=!1,r=this.inkController.getInkBuilder(t.changedTouches);return r&&(e=t.type.endsWith("down")||t.type.endsWith("start")?!r.phase:!!r.phase),e},getSensorPoint:function(t){var e=void 0,r=this.inkController.getInkBuilder(t.changedTouches);if(r){var n=this.getOffset(t);e=r.createSensorPoint(t,n.x,n.y)}return e},getOffset:function(t){if(t.changedTouches){var e=this.inkController.getInkBuilder(t.changedTouches);t=e.touchID!=t.changedTouches.item(0).identifier?Array.from(t.changedTouches).filter((function(t){return t.identifier==e.touchID})).first:t.changedTouches.item(0)}var r=this.canvas.offsetParent;if(!r)return{x:0,y:0};var n=r.getBoundingClientRect(),i={x:t.pageX-n.x,y:t.pageY-n.y};if(this.inkController.transform){var o=this.inkController.transform instanceof Z?this.inkController.transform:Z.create(this.inkController.transform);i=V.fromPoint(i).transform(o.invert())}return i},getInputProvider:function(t){return t.pointerType?t.pointerType:t.type.replace(/down|start|move|up|end/g,"")},begin:function(t){if(!(t instanceof MouseEvent&&0!=t.button)&&(this.provider||(this.provider=this.getInputProvider(t)),this.isInputAllowed(t)&&(t instanceof TouchEvent&&this.inkController.registerTouches(t.changedTouches),this.isInputExpected(t)))){var e=this.getSensorPoint(t);e&&this.inkController.begin(e)}},move:function(t){if(this.isInputAllowed(t)&&this.isInputExpected(t)){var e=this.getSensorPoint(t);e&&this.inkController.move(e)}},end:function(t){var e=this;if(this.isInputAllowed(t)&&this.isInputExpected(t)){var r=this.getSensorPoint(t);r&&(this.inkController.end(r),t instanceof MouseEvent||(this.stop("mouse"),this.timeoutID=setTimeout((function(){return e.start("mouse")}),500))),t.touches&&0!=t.touches.length||delete this.provider}},abort:function(t){delete this.provider,this.inkController.abort&&this.inkController.abort(t)}},Mt=96/("undefined"==typeof window?1:window.devicePixelRatio),Nt={METER:{METER:1,CENTIMETER:100,MILLIMETER:1e3,MICROMETER:1e6,INCH:39.3700787402,POINT:2834.6456692913,PICA:236.2204724409,DIP:39.3700787402*Mt},CENTIMETER:{METER:.01,CENTIMETER:1,MILLIMETER:10,MICROMETER:1e4,INCH:.3937007874,POINT:28.3464566929,PICA:2.3622047244,DIP:.3937007874*Mt},MILLIMETER:{METER:.001,CENTIMETER:.1,MILLIMETER:1,MICROMETER:1e3,INCH:.0393700787,POINT:2.8346456693,PICA:.2362204724,DIP:.0393700787*Mt},MICROMETER:{METER:1e-6,CENTIMETER:1e-4,MILLIMETER:.001,MICROMETER:1,INCH:393701e-10,POINT:.0028346457,PICA:.0002362205,DIP:393701e-10*Mt},INCH:{METER:.0254,CENTIMETER:2.54,MILLIMETER:25.4,MICROMETER:25400,INCH:1,POINT:72,PICA:6,DIP:1*Mt},POINT:{METER:.0003527778,CENTIMETER:.0352777778,MILLIMETER:.3527777778,MICROMETER:352.7777777778,INCH:.0138888889,POINT:1,PICA:.0833333333,DIP:.0138888889*Mt},PICA:{METER:.0042333333,CENTIMETER:.4233333333,MILLIMETER:4.2333333333,MICROMETER:4233.3333333333,INCH:.1666666667,POINT:12,PICA:1,DIP:.1666666667*Mt},DIP:{METER:.0254/Mt,CENTIMETER:2.54/Mt,MILLIMETER:25.4/Mt,MICROMETER:25400/Mt,INCH:1/Mt,POINT:72/Mt,PICA:6/Mt,DIP:1},SECOND:{SECOND:1,MILLISECOND:1e3,MICROSECOND:1e6,NANOSECOND:1e9},MILLISECOND:{SECOND:.001,MILLISECOND:1,MICROSECOND:1e3,NANOSECOND:1e6},MICROSECOND:{SECOND:1e-6,MILLISECOND:.001,MICROSECOND:1,NANOSECOND:1e3},NANOSECOND:{SECOND:1e-9,MILLISECOND:1e-6,MICROSECOND:.001,NANOSECOND:1},RADIAN:{RADIAN:1,DEGREE:57.2957795},DEGREE:{RADIAN:.0174532925,DEGREE:1},NEWTON:{NEWTON:1}};Function.createEnum.call(Nt,"Unit",["METER","CENTIMETER","MILLIMETER","MICROMETER","INCH","POINT","PICA","DIP","SECOND","MILLISECOND","MICROSECOND","NANOSECOND","RADIAN","DEGREE","NEWTON","NORMALIZED","LOGICAL"]),Function.createEnum.call(Nt,"Metric",["LENGTH","TIME","FORCE","ANGLE","NORMALIZED","LOGICAL","DIMENSIONLESS"]);var Lt=Object.freeze({LENGTH:Nt.Unit.METER,TIME:Nt.Unit.SECOND,FORCE:Nt.Unit.NEWTON,ANGLE:Nt.Unit.RADIAN,NORMALIZED:Nt.Unit.NORMALIZED,LOGICAL:Nt.Unit.LOGICAL});Nt.getChannelResolution=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=1,n=Nt.getUnitMetric(t);return n!=Nt.Metric.NORMALIZED&&n!=Nt.Metric.LOGICAL&&(r=Nt[Lt[n.name].name][t.name]/e),r},Nt.convert=function(t,e,r,n){return e?r*Nt[Lt[t.name].name][n.name]/e:r},Nt.convertAny=function(t,e,r,n){return t*Nt[e.name][r.name]/n},Nt.getUnitMetric=function(t){switch(t){case Nt.Unit.METER:case Nt.Unit.CENTIMETER:case Nt.Unit.MILLIMETER:case Nt.Unit.MICROMETER:case Nt.Unit.INCH:case Nt.Unit.POINT:case Nt.Unit.PICA:case Nt.Unit.DIP:return Nt.Metric.LENGTH;case Nt.Unit.SECOND:case Nt.Unit.MILLISECOND:case Nt.Unit.MICROSECOND:case Nt.Unit.NANOSECOND:return Nt.Metric.TIME;case Nt.Unit.RADIAN:case Nt.Unit.DEGREE:return Nt.Metric.ANGLE;case Nt.Unit.NEWTON:return Nt.Metric.FORCE;case Nt.Unit.NORMALIZED:return Nt.Metric.NORMALIZED;case Nt.Unit.LOGICAL:return Nt.Metric.LOGICAL;default:throw console.warn(t),new Error("Invalid unit found")}},Nt.getUnit=function(t){return Lt[t.name]},Nt.convertValue=function(t,e,r){return t*Nt[e.name][r.name]},Object.freeze(Nt);var _t=void 0;m.commonJS&&(_t=systeminformation);var Bt=_t,Ft=(m.commonJS,md5),Ut=(m.commonJS,Long),jt={mask:"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx",generate:function(){var t=Date.now();return this.mask.replace(/[xy]/g,(function(e){var r=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"==e?r:3&r|8).toString(16)}))},fromString:function(t){return this.fromBytes(new Uint8Array(Ft.arrayBuffer(t)))},toBytes:function(t){var e=[];return t.split("-").map((function(t,r){(r<3?t.match(/.{1,2}/g).reverse():t.match(/.{1,2}/g)).map((function(t){return e.push(parseInt(t,16))}))})),new Uint8Array(e)},fromBytes:function(t){var e=Array.from(t).map((function(t){return t.toString(16)})).map((function(t){return(1==t.length?"0":"")+t}));return e.slice(0,4).reverse().join("")+"-"+e.slice(4,6).reverse().join("")+"-"+e.slice(6,8).reverse().join("")+"-"+e.slice(8,10).join("")+"-"+e.slice(10).join("")},toUint32Array:function(t){var e=new Uint32Array(4),r=this.toBytes(t);return e[0]=new Uint32Array(r.slice(0,4).buffer)[0],e[1]=new Uint32Array(r.slice(4,8).buffer)[0],e[2]=new Uint32Array(r.slice(8,12).buffer)[0],e[3]=new Uint32Array(r.slice(12).buffer)[0],e},fromUint32Array:function(t){return this.fromBytes(new Uint8Array(t.buffer))},toUint64Array:function(t){var e=new BigUint64Array(2),r=this.toBytes(t);return e[0]=new BigUint64Array(r.slice(0,8).buffer)[0],e[1]=new BigUint64Array(r.slice(8).buffer)[0],e},fromUint64Array:function(t){return this.fromBytes(new Uint8Array(t.buffer))},toLongArray:function(t){var e=new Array(2),r=this.toBytes(t);return e[0]=Ut.fromBytes(r.slice(0,8)),e[1]=Ut.fromBytes(r.slice(8)),e},fromLongArray:function(t){var e=t[0].toBytes().concat(t[1].toBytes());return this.fromBytes(e)}};function Gt(t){if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(t=function(t,e){if(!t)return;if("string"==typeof t)return Xt(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(r);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return Xt(t,e)}(t))){var e=0,r=function(){};return{s:r,n:function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}},e:function(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,i,o=!0,a=!1;return{s:function(){n=t[Symbol.iterator]()},n:function(){var t=n.next();return o=t.done,t},e:function(t){a=!0,i=t},f:function(){try{o||null==n.return||n.return()}finally{if(a)throw i}}}}function Xt(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}var Yt=function(){function t(r){var n=this;e(this,t),Object.defineProperty(this,"id",{get:function(){return r||(r=this.resolveID()),r},set:function(t){var e=r;r=t,this.updateID(e,r)},enumerable:!0}),Object.defineProperty(this,"algorithm",{get:function(){return"function"==typeof n.getMD5Message?t.Algorithm.MD5:t.Algorithm.GUID},enumerable:!0})}return I(t,null,[{key:"SEPARATOR",get:function(){return"\n"}}]),I(t,[{key:"resolveID",value:function(){if(this.algorithm==t.Algorithm.MD5){var e,r="",n=Gt(this.getMD5Message());try{for(n.s();!(e=n.n()).done;){var i=e.value;if(Array.isArray(i)){var o,a=Gt(i);try{for(a.s();!(o=a.n()).done;){r+=o.value,r+="\n"}}catch(t){a.e(t)}finally{a.f()}}else r+=i;r+="\n"}}catch(t){n.e(t)}finally{n.f()}if(!r)throw new Error("Empty MD5 message container found");return Ft(r)}return jt.generate()}},{key:"updateID",value:function(t,e){}},{key:"invalidateID",value:function(){this.id=void 0}}],[{key:"getMD5Tokens",value:function(t){var e=[];return Object.keys(t).sort().forEach((function(r){return e.push(r,t[r])})),e}}]),t}();function zt(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}Yt.createEnum("Algorithm",["GUID","MD5"]);var Vt=function(t){o(a,t);var r,n,i=(r=a,function(){var t,e=c(r);if(zt()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function a(){var t;return e(this,a),(t=i.call(this)).props={},t}return I(a,[{key:"getMD5Message",value:function(){if(!Object.isFrozen(this))throw new Error("ID generation failed. Environment do not belongs to any InputContext yet");return["Environment",Yt.getMD5Tokens(this.props)]}}],[{key:"createInstance",value:(n=ht(ct.mark((function t(){var e,r,n,i=arguments;return ct.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e=i.length>0&&void 0!==i[0]?i[0]:{},(r=new a).props["env.name"]=m.type.name,void 0!==Bt){t.next=7;break}r.props["user.agent"]=navigator.userAgent,t.next=15;break;case 7:return t.next=9,Bt.osInfo();case 9:n=t.sent,r.props["os.id"]=n.serial.toLowerCase(),r.props["os.name"]=n.codename,r.props["os.version"]=n.release,r.props["os.build"]=n.build,r.props["os.platform"]="".concat(n.distro," (").concat(n.platform," ").concat(n.arch,")");case 15:return Object.keys(e).forEach((function(t){return r.props[t]=e[t]})),t.abrupt("return",r);case 17:case"end":return t.stop()}}),t)}))),function(){return n.apply(this,arguments)})}]),a}(Yt);function Ht(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var Wt=function(t){o(i,t);var r,n=(r=i,function(){var t,e=c(r);if(Ht()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function i(t){var r,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return e(this,i),(r=n.call(this)).type=t,r.props=Object.assign({},o),r}return I(i,[{key:"getMD5Message",value:function(){if(!Object.isFrozen(this))throw new Error("ID generation failed. InkInputProvider do not belongs to any SensorChannelsContext yet");return["InkInputProvider",this.type.name,Yt.getMD5Tokens(this.props)]}}]),i}(Yt);function qt(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}Wt.createEnum("Type",["PEN","TOUCH","MOUSE","CONTROLLER"]);var Zt=function(t){o(i,t);var r,n=(r=i,function(){var t,e=c(r);if(qt()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function i(t,r,o,a,u){var c;if(e(this,i),c=n.call(this),r==i.Metric.DIMENSIONLESS)o=1;else if(isNaN(o)){var l=Nt.getUnit(r);o=Nt.getChannelResolution(l)}return c.type=t,c.metric=r,c.resolution=o,c.min=a,c.max=u,t==i.Type.TIMESTAMP?c.precision=0:c.precision=2,Object.defineProperty(s(c),"name",{get:function(){return At.getEnumValueName(this.type.substring(this.type.lastIndexOf("/")+1))}}),c}return I(i,[{key:"getMD5Message",value:function(){if(!this.context)throw new Error("ID generation failed. This channel do not belongs to SensorChannelsContext yet");if(!Object.isFrozen(this.context)&&!Object.isFrozen(this))throw new Error("ID generation failed. Underlying SensorChannelsContext do not belongs to any SensorContext yet");var t=[];return t.push("SensorChannel"),t.push(this.context.inkProvider?this.context.inkProvider.id:""),t.push(this.context.device.id),t.push(this.type),t.push(this.metric.name),t.push(this.resolution.toFixed(4)),t.push((this.min||0).toFixed(4)),t.push((this.max||0).toFixed(4)),t.push(this.precision.toString()),t}}],[{key:"createCustomChannel",value:function(t,e,r,n,o,a){var s=new i(t,r,n,o,a);return s.precision=e,s}},{key:"createDefaultInstance",value:function(t,e){var r,n,o;switch(t){case i.Type.X:case i.Type.Y:case i.Type.Z:case i.Type.RADIUS_X:case i.Type.RADIUS_Y:r=Nt.Unit.DIP;break;case i.Type.TIMESTAMP:r=Nt.Unit.MILLISECOND;break;case i.Type.PRESSURE:r=Nt.Unit.NORMALIZED,n=0,o=1;break;case i.Type.ALTITUDE:case i.Type.AZIMUTH:case i.Type.ROTATION:r=Nt.Unit.RADIAN,n=0,o=2*Math.PI;break;default:console.error("SensorChannel: createDefaultInstance fails with ".concat(t," type"))}var a=Nt.getChannelResolution(r),s=new i(t,Nt.getUnitMetric(r),a,n,o);return s.unit=r,t!=i.Type.X&&t!=i.Type.Y||e.type!=Wt.Type.MOUSE||(s.precision=0),s}}]),i}(Yt);function Jt(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}Zt.defaults=Object.freeze({PEN:["X","Y","TIMESTAMP","PRESSURE","ALTITUDE","AZIMUTH","ROTATION"],TOUCH:["X","Y","TIMESTAMP","PRESSURE","RADIUS_X","RADIUS_Y","ROTATION"],MOUSE:["X","Y","TIMESTAMP"]}),Zt.Type={X:"will://input/3.0/channel/X",Y:"will://input/3.0/channel/Y",Z:"will://input/3.0/channel/Z",TIMESTAMP:"will://input/3.0/channel/Timestamp",PRESSURE:"will://input/3.0/channel/Pressure",RADIUS_X:"will://input/3.0/channel/RadiusX",RADIUS_Y:"will://input/3.0/channel/RadiusY",ALTITUDE:"will://input/3.0/channel/Altitude",AZIMUTH:"will://input/3.0/channel/Azimuth",ROTATION:"will://input/3.0/channel/Rotation"},Zt.Metric=Nt.Metric;var Kt=function(t){o(i,t);var r,n=(r=i,function(){var t,e=c(r);if(Jt()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function i(t,r){var o;e(this,i),(o=n.call(this)).device=t.freeze(),o.inkProvider=Object.freeze(r);var a,u,c=[];return Object.defineProperty(s(o),"channels",{get:function(){return c},set:function(t){var e=this;this.invalidateID(),c=[],t.forEach((function(t){return e.add(t)}))},enumerable:!0}),Object.defineProperty(s(o),"layout",{get:function(){return c.map((function(t){return t.name}))},set:function(t){this.invalidateID(),c=c.filter((function(e){return t.includes(e.name)}))},enumerable:!0}),Object.defineProperty(s(o),"samplingRate",{get:function(){return a},set:function(t){this.invalidateID(),a=t},enumerable:!0}),Object.defineProperty(s(o),"latency",{get:function(){return u},set:function(t){this.invalidateID(),u=t},enumerable:!0}),o}return I(i,[{key:"getMD5Message",value:function(){if(!Object.isFrozen(this))throw new Error("ID generation failed. SensorChannelsContext do not belongs to any SensorContext yet");var t=["SensorChannelsContext"].concat(w(this.channels.map((function(t){return t.id}))));return t.push(this.samplingRate||""),t.push(this.latency||""),t.push(this.inkProvider?this.inkProvider.id:""),t.push(this.device.id),t}},{key:"add",value:function(t){if((t.type==Zt.Type.X||t.type==Zt.Type.Y)&&!this.inkProvider)throw new Error("inkProvider is not found. Required for ink group.");t.context=this,Object.freeze(t),this.channels.push(t)}},{key:"get",value:function(t){return this.channels.filter((function(e){return e.id==t})).first}}],[{key:"createDefaultInstance",value:function(t,e){var r=new i(t,e);return r.channels=Zt.defaults[e.type.name].map((function(t){return Zt.createDefaultInstance(Zt.Type[t],e)})),r}}]),i}(Yt);function Qt(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var $t=function(t){o(i,t);var r,n=(r=i,function(){var t,e=c(r);if(Qt()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function i(){var t;e(this,i),t=n.call(this);var r=[];return Object.defineProperty(s(t),"channelsContexts",{get:function(){return r},set:function(t){this.invalidateID(),r=t},enumerable:!0}),t}return I(i,[{key:"getMD5Message",value:function(){if(!Object.isFrozen(this))throw new Error("ID generation failed. SensorContext do not belongs to any InputContext yet");return["SensorContext"].concat(w(this.channelsContexts.map((function(t){return t.id}))))}},{key:"addContext",value:function(t){if(!this.channelsContexts.includes(t)){if(this.channelsContexts.filter((function(e){return e.device==t.device})).length>0)throw new Error("Already exists channelsContext with device ".concat(t.device.id,". Device should be unique in scope of SensorContext."));t.inkProvider&&(this.inkChannelsContext=t),Object.freeze(t),this.channelsContexts.push(t)}}},{key:"getContext",value:function(t){return this.channelsContexts.filter((function(e){return e.id==t})).first}},{key:"getContextByChannelID",value:function(t){return this.channelsContexts.filter((function(e){return e.get(t)})).first}}],[{key:"createDefaultInstance",value:function(t,e){var r=new i;return r.addContext(Kt.createDefaultInstance(t,e)),r}}]),i}(Yt);function te(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var ee=function(t){o(i,t);var r,n=(r=i,function(){var t,e=c(r);if(te()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function i(t,r){var o;return e(this,i),(o=n.call(this)).environment=Object.freeze(t),o.sensorContext=Object.freeze(r),o}return I(i,[{key:"getMD5Message",value:function(){return["InputContext",this.environment.id,this.sensorContext.id]}},{key:"addChannelsContext",value:function(t){this.sensorContext.addContext(t)}}],[{key:"createDefaultInstance",value:function(t,e,r){return new i(t,$t.createDefaultInstance(e,r))}}]),i}(Yt);function re(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var ne=function(t){o(i,t);var r,n=(r=i,function(){var t,e=c(r);if(re()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function i(t){var r;return e(this,i),(r=n.call(this)).created=Date.now(),r.inkState=i.InkState.PLANE,r.context=t,r.streams=[],r}return I(i,[{key:"add",value:function(t){if(!this.context.sensorContext.getContextByChannelID(t.channels.first.id))throw new Error("SensorContext do not contains information about SensorChannelsContext corresponding with this stream");t.ink&&(this.inkStream=t),this.streams.push(t)}}]),i}(Yt);ne.createEnum("InkState",["PLANE","HOVERING","IN_VOLUME","VOLUME_HOVERING"]);var ie=function(){function t(r){e(this,t),this.channels=r,this.data=[],this.ignoredIndex=[],Object.defineProperty(this,"layout",{value:r.map((function(t){return t.name})),enumerable:!0}),Object.defineProperty(this,"stride",{value:this.layout.length,enumerable:!0}),Object.defineProperty(this,"length",{get:function(){return this.data.length/this.stride},enumerable:!0}),this.ink=this.layout.includes("X")&&this.layout.includes("Y")}return I(t,[{key:"add",value:function(t,e){var r=this;e&&this.ignoredIndex.push(this.length),this.channels.forEach((function(e){var n=At.getPropName(e.name),i=t[n];if(e.type==Zt.Type.ALTITUDE&&!("altitude"in t))throw new Error("SensorStream input data do not provides altitude");if(e.type==Zt.Type.AZIMUTH&&!("azimuth"in t))throw new Error("SensorStream input data do not provides azimuth");r.data.push(i)}))}},{key:"get",value:function(t){if(t>=this.length||t<0)throw new Error("Index ".concat(t," out of range - (0, ").concat(this.length-1,")"));for(var e={},r=0;r<this.stride;r++){var n=this.channels[r],i=At.getPropName(n.name),o=t*this.stride;"force"==i?(e.pressure=this.data[o+r],Object.defineProperty(e,"force",{value:this.pressure,enumerable:!0})):e[i]=this.data[o+r]}return e}},{key:"getPipelineMapping",value:function(){var t=[];if(this.ignoredIndex.length>0)for(var e=0;e<this.length;e++)this.ignoredIndex.includes(e)||t.push(e);return t}}]),t}();function oe(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var ae=function(t){o(a,t);var r,n,i=(r=a,function(){var t,e=c(r);if(oe()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function a(){var t;return e(this,a),(t=i.call(this)).props={},t.devices=[],t}return I(a,[{key:"freeze",value:function(){return Object.freeze(this.props),this}},{key:"getMD5Message",value:function(){if(!Object.isFrozen(this.props)&&!Object.isFrozen(this))throw new Error("ID generation failed. InputDevice do not belongs to any SensorChannelsContext yet");return["InputDevice",Yt.getMD5Tokens(this.props)]}},{key:"link",value:function(t){this.devices.push(t)}},{key:"getInkInputProvider",value:function(t){return new Wt(t)}},{key:"getInkSensorContext",value:function(t){var e=this.getInkInputProvider(t);return $t.createDefaultInstance(this,e)}},{key:"openStream",value:function(t){var e=this;if(!this.environment)throw new Error("Environment is not configured for current InputDevice instance");var r=Wt.Type[t.pointer.type.toUpperCase()],n=this.getInkSensorContext(r),i=new ee(this.environment,n);n.inkChannelsContext.layout=a.getLayout(t),this.sensorData=new ne(i),this.sensorData.add(new ie(n.inkChannelsContext.channels)),this.sampleTimestamp=t.timestamp,this.devices.forEach((function(t){return t.openStream(e.sensorData)}))}},{key:"add",value:function(t,e){if(!this.sensorData)throw new Error("Open ink stream not found");this.sensorData.inkStream.add(Object.assign({},t,{timestamp:t.timestamp-this.sampleTimestamp}),e)}},{key:"closeStream",value:function(t){var e=this.sensorData;return this.devices.forEach((function(e){return e.closeStream(t)})),this.sensorData=null,this.sampleTimestamp=0,t?null:e}}],[{key:"getLayout",value:function(t){var e=[];return Object.keys(Zt.Type).forEach((function(r){var n,i=Zt.Type[r];n=i==Zt.Type.ALTITUDE?"tiltX":i==Zt.Type.AZIMUTH?"tiltY":At.getPropName(r),isFinite(t[n])&&e.push(r)})),e}},{key:"createInstance",value:(n=ht(ct.mark((function t(e){var r,n,i,o,a,s,u=arguments;return ct.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=f(this,w(Array.from(u).slice(1))),void 0!==Bt){t.next=5;break}r.props["dev.graphics.resolution"]="".concat(screen.width,"x").concat(screen.height),t.next=22;break;case 5:return t.next=7,Bt.system();case 7:return n=t.sent,t.next=10,Bt.cpu();case 10:return i=t.sent,t.next=13,Bt.graphics();case 13:o=t.sent,a=o.displays.filter((function(t){return t.main}))[0],s=o.controllers[0],r.props["dev.id"]=n.uuid.toLowerCase(),r.props["dev.manufacturer"]=n.manufacturer,r.props["dev.model"]=n.model,r.props["dev.cpu"]="".concat(i.manufacturer," ").concat(i.brand," ").concat(i.speed," - ").concat(i.cores," core(s)"),r.props["dev.graphics.display"]="".concat(a.model," ").concat(a.currentResX,"x").concat(a.currentResY," (").concat(a.pixeldepth," bit)"),r.props["dev.graphics.adapter"]="".concat(s.model," ").concat(s.vram," GB");case 22:return t.next=24,Vt.createInstance(e);case 24:return r.environment=t.sent,t.abrupt("return",r);case 26:case"end":return t.stop()}}),t,this)}))),function(t){return n.apply(this,arguments)})}]),a}(Yt),se=function(){function t(r){var n,i=this;e(this,t),this.phase=r.phase,Object.defineProperty(this,"x",{value:r.x,enumerable:!0}),Object.defineProperty(this,"y",{value:r.y,enumerable:!0}),Object.defineProperty(this,"z",{value:r.z,enumerable:!0}),Object.defineProperty(this,"timestamp",{value:r.timestamp,enumerable:!0}),Object.defineProperty(this,"force",{value:r.pressure,enumerable:!0}),Object.defineProperty(this,"pressure",{value:r.pressure,enumerable:!0}),Object.defineProperty(this,"rotation",{value:r.rotation,enumerable:!0}),Object.defineProperty(this,"radiusX",{value:r.radiusX,enumerable:!0}),Object.defineProperty(this,"radiusY",{value:r.radiusY,enumerable:!0}),Object.defineProperty(this,"altitude",{get:function(){return n||(n=i.computeTilt(r.tiltX,r.tiltY)||{}),n.altitude},enumerable:!0}),Object.defineProperty(this,"azimuth",{get:function(){return n||(n=i.computeTilt(r.tiltX,r.tiltY)||{}),n.azimuth},enumerable:!0}),r.pointer&&Object.defineProperty(this,"pointer",{value:r.pointer,enumerable:!0}),this.computedAzimuth=void 0}return I(t,[{key:"createPathPoint",value:function(){return new K(this.x,this.y,this.z)}},{key:"computeTilt",value:function(t,e){if(isFinite(t)&&isFinite(e)){var r=Math.tan(Math.toRadians(t)),n=Math.tan(Math.toRadians(e)),i=Math.sqrt(r*r+n*n);return{altitude:Math.atan2(1,i),azimuth:Math.atan2(n,r)}}}},{key:"speed",value:function(e,r){var n={x:0,y:0,time:0};if((n=e&&!r?this.minus(e):r&&!e?r.minus(this):r.minus(e)).time>0)return t.getMagnitude(n.x,n.y)/(n.time/1e3);if(0==n.time)return 0;throw new Error("Out of range ".concat(n.time))}},{key:"computeNearestAzimuthAngle",value:function(t){var e;if(isNaN(this.azimuth))return 0;if(t){if(isNaN(t.azimuth))return 0;var r=2*Math.PI,n=t.computedAzimuth||t.azimuth,i=parseInt(n/r),o=(e=this.azimuth+i*r)-n;o>=Math.PI?e-=r:o<-Math.PI&&(e+=r)}else e=this.azimuth;return this.computedAzimuth=e,e}},{key:"minus",value:function(t){return{x:this.x-t.x,y:this.y-t.y,time:this.timestamp-t.timestamp}}}],[{key:"getMagnitude",value:function(t,e){return Math.sqrt(t*t+e*e)}}]),t}();se.createEnum("Property",["X","Y","Z","PHASE","TIMESTAMP","PRESSURE","RADIUS_X","RADIUS_Y","ALTITUDE","AZIMUTH","ROTATION"]);var ue=function(){function t(){e(this,t)}return I(t,null,[{key:"createCircle",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:20,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{x:0,y:0};return t.createEllipse(e,r,r,n)}},{key:"createEllipse",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:20,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.5,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{x:0,y:0},i=[],o=2*Math.PI/t,a=0;a<t;a++){var s=a*o,u=e*Math.cos(s),c=r*Math.sin(s);i.push(n.x+u,n.y+c)}return i.toFloat32Array()}},{key:"createStar",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,r=[],n=1,i=2*Math.PI/t,o=0;o<t;o++){var a=o*i,s=n*Math.cos(a),u=n*Math.sin(a),c=e*Math.cos(a+i/2),l=e*Math.sin(a+i/2);r.push(s,u,c,l)}return r.toFloat32Array()}}]),t}(),ce=function(){function t(){e(this,t)}return I(t,null,[{key:"encode",value:function(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t.Encoding.AUTO;if(n==t.Encoding.AUTO&&(n="undefined"==typeof Buffer?t.Encoding.ARRAY:t.Encoding.BUFFER),n==t.Encoding.NONE)r=e;else if(n==t.Encoding.ARRAY)r=e.toArray();else{if("undefined"==typeof Buffer)throw new Error("Buffer not found, unable to serialize. Please provide Buffer in global scope.");var i=Buffer.from(e.buffer);switch(n){case t.Encoding.BUFFER:r=i.toJSON();break;case t.Encoding.BASE64:r=i.toString("base64");break;default:throw new Error("Invalid encoding provided: ".concat(n.name))}}return{encoding:n.name,type:e.constructor.name,points:r}}},{key:"decode",value:function(e){var r,n=t.Encoding[e.encoding];if(n==t.Encoding.NONE)r=e.points;else if(n==t.Encoding.ARRAY)r=e.points.toFloat32Array();else{if("undefined"==typeof Buffer)throw new Error("Buffer not found, unable to deserialize. Please provide Buffer in global scope.");var i;switch(n){case t.Encoding.BUFFER:i=Buffer.from(e.points);break;case t.Encoding.BASE64:i=Buffer.from(e.points,"base64");break;default:throw new Error("Invalid encoding provided: ".concat(n.name))}var o=new Uint8Array(i);r=new globalThis[e.type](o.buffer)}return r}},{key:"isTypedArrayData",value:function(t){return t&&t.encoding&&t.type&&t.type.endsWith("Array")}}]),t}();ce.createEnum("Encoding",["AUTO","NONE","ARRAY","BUFFER","BASE64"]);var le=function(){function t(r,n){e(this,t),this.name=r,Object.defineProperty(this,"value",{get:function(){if(!n){if(!this.name)throw new Error("Resource descriptor identifier not found. Cannot resolve resource content.");if("function"==typeof this.resolve&&(n=this.resolve(this.name)),!n){if(!T.instance)throw new Error("Resource URI ".concat(this.name," cannot be resolved. URIResolver not implemented yet. Please implement and instantiate."));n=T.instance.resolve(this.name)}if(!n)throw new Error("Resource URI ".concat(this.name," cannot be resolved. Please provide resource definition in URIResolver init implementation."))}return n},set:function(t){n=t},enumerable:!0})}return I(t,[{key:"toJSON",value:function(){var t=this.value;return ArrayBuffer.isTypedArray(t)?t=ce.encode(t,this.encoding):"function"==typeof t&&(t=t()),{name:this.name,value:t}}}],[{key:"fromJSON",value:function(e){var r=e.value;return ce.isTypedArrayData(r)&&(r=ce.decode(r)),new t(e.name,r)}},{key:"getInstance",value:function(e,r){return new t(r,e)}}]),t}(),he=function(){function t(r){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;e(this,t),this.size=n,Object.defineProperty(this,"descriptor",{value:{shape:{}},enumerable:!0}),Object.defineProperty(this,"shape",{get:function(){return r||("function"==typeof(r=this.descriptor.shape.value)&&(r=r()),t.fitShape(r)),r},set:function(e){var n=this;if(!e)throw new Error("BrushPrototype: shape not found");Array.isArray(e)&&(e=e.toFloat32Array()),"string"==typeof e?e=new le(e):e instanceof Float32Array?e=le.getInstance(e):e instanceof le||(e=new le(e.name,e.value)),r=null,this.descriptor.shape=e,this.descriptor.shape.resolve=t.resolve,Object.defineProperty(this.descriptor.shape,"encoding",{get:function(){return n.encoding},enumerable:!0})},enumerable:!0}),this.shape=r}return I(t,[{key:"toJSON",value:function(){return{shape:this.descriptor.shape.toJSON(),size:this.size}}}],[{key:"fromJSON",value:function(e){return new t(le.fromJSON(e.shape),e.size)}},{key:"create",value:function(e){for(var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=e,o=arguments.length,a=new Array(o>2?o-2:0),s=2;s<o;s++)a[s-2]=arguments[s];switch(e){case t.Type.CIRCLE:r=ue.createCircle.apply(ue,a),i+="?precision=".concat(a[0]||"","&radius=").concat(a[1]||"");break;case t.Type.ELLIPSE:r=ue.createEllipse.apply(ue,a),i+="?precision=".concat(a[0]||"","&radiusX=").concat(a[1]||"","&radiusY=").concat(a[2]||"");break;case t.Type.STAR:r=ue.createStar.apply(ue,a),i+="?points=".concat(a[0]||"","&internalRadius=").concat(a[1]||"");break;default:console.error("Brush2D: createShape fails with ".concat(e," type"))}return new t({name:i,shape:r},n)}},{key:"resolve",value:function(e){var r,n=e.split("?"),i=n.first;if(Object.values(t.Type).includes(i)){var o=n.last.split("&"),a={};switch(o.forEach((function(t){a[t.substring(0,t.indexOf("="))]=t.substring(t.indexOf("=")+1)})),i){case t.Type.CIRCLE:var s=a.precision?parseInt(a.precision):void 0;r=ue.createCircle(s);break;case t.Type.ELLIPSE:var u=a.precision?parseInt(a.precision):void 0,c=a.radiusX?parseFloat(a.radiusX):void 0,l=a.radiusY?parseFloat(a.radiusY):void 0;r=ue.createEllipse(u,c,l);break;case t.Type.STAR:var h=a.points?parseInt(a.points):void 0,f=a.internalRadius?parseFloat(a.internalRadius):void 0;r=ue.createStar(h,f);break;default:console.error("Brush2D: createShape fails with ".concat(i," type"))}}return r}},{key:"fitShape",value:function(e){t.centerShape(e);for(var r=new $(-1,-1,1,1),n=$.ofPolygon(e),i=r.width/n.width,o=r.height/n.height,a=i>0&&o>0?Math.min(i,o):Math.max(i,o),s=0;s<e.length;s+=2)e[s]*=a,e[s+1]*=a}},{key:"centerShape",value:function(t){for(var e=$.ofPolygon(t),r=0;r<t.length;r+=2)t[r]-=e.center.x,t[r+1]-=e.center.y}}]),t}();function fe(t){if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(t=function(t,e){if(!t)return;if("string"==typeof t)return de(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(r);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return de(t,e)}(t))){var e=0,r=function(){};return{s:r,n:function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}},e:function(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,i,o=!0,a=!1;return{s:function(){n=t[Symbol.iterator]()},n:function(){var t=n.next();return o=t.done,t},e:function(t){a=!0,i=t},f:function(){try{o||null==n.return||n.return()}finally{if(a)throw i}}}}function de(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}he.Type={ELLIPSE:"will://brush/3.0/shape/Ellipse",CIRCLE:"will://brush/3.0/shape/Circle",STAR:"will://brush/3.0/shape/Star"};var pe=function(){function t(r,n,i){var o,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;e(this,t),isFinite(i)&&(a=i,i=void 0),a<=0&&(console.warn("Invalid spacing found ".concat(a,". It should be positive number.")),a=1),this.name=r,Object.defineProperty(this,"shape",{get:function(){return n},set:function(t){if(t instanceof Float32Array&&(t=new he(t)),!this.validate(t))throw console.warn(t),new Error("Brush2D: Invalid shape found");Array.isArray(t)&&(1==t.length?t=t.first:t.sort(At.comparator({sortBy:"size",sortOrder:"asc"}))),n=t},enumerable:!0}),this.shape=n,this.fill=i,this.spacing=a,Object.defineProperty(this,"encoding",{get:function(){return o},set:function(t){if(Array.isArray(this.shape)){var e,r=fe(this.shape);try{for(r.s();!(e=r.n()).done;){e.value.encoding=t}}catch(t){r.e(t)}finally{r.f()}}else this.shape.encoding=t},enumerable:!0})}var r;return I(t,[{key:"validate",value:function(t){var e=!1;if(Array.isArray(t)){var r,n=fe(t);try{for(n.s();!(r=n.n()).done;){if(!(e=r.value instanceof he))break}}catch(t){n.e(t)}finally{n.f()}}else e=t instanceof he;return e}},{key:"configure",value:(r=ht(ct.mark((function t(e){var r;return ct.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!this.pattern&&this.fill){t.next=2;break}return t.abrupt("return");case 2:if(e instanceof CanvasRenderingContext2D||e instanceof OffscreenCanvasRenderingContext2D){t.next=4;break}throw new Error("ctx is not instance of CanvasRenderingContext2D or OffscreenCanvasRenderingContext2D");case 4:return t.next=6,gt(this.fill);case 6:r=t.sent,this.pattern=e.createPattern(r,"repeat");case 8:case"end":return t.stop()}}),t,this)}))),function(t){return r.apply(this,arguments)})},{key:"selectShape",value:function(t){var e;if(Array.isArray(this.shape)){for(var r=1;r<this.shape.length;r++)if(this.shape[r].size>t){e=this.shape[r-1];break}e||(e=this.shape.last)}else e=this.shape;return e.shape}},{key:"toJSON",value:function(){var t=Array.isArray(this.shape)?this.shape:[this.shape];return{type:this.constructor.name,name:this.name,spacing:this.spacing,shape:t.map((function(t){return t.toJSON()}))}}}],[{key:"fromJSON",value:function(e){var r=1==e.shape.length?he.fromJSON(e.shape[0]):e.shape.map((function(t){return he.fromJSON(t)}));return new t(e.name,r,e.spacing)}}]),t}(),ye=function(){function t(){e(this,t),this.state={}}return I(t,null,[{key:"excludedProps",get:function(){return[K.Property.D_X,K.Property.D_Y]}},{key:"posProps",get:function(){return[K.Property.X,K.Property.Y,K.Property.Z]}},{key:"colorProps",get:function(){return[K.Property.RED,K.Property.GREEN,K.Property.BLUE,K.Property.ALPHA]}},{key:"transformProps",get:function(){return[K.Property.ROTATION,K.Property.SCALE_X,K.Property.SCALE_Y,K.Property.SCALE_Z,K.Property.OFFSET_X,K.Property.OFFSET_Y,K.Property.OFFSET_Z]}}]),I(t,[{key:"isLayoutPart",value:function(e){if(t.posProps.includes(e))return this.inputLayout.includes(e.name);if(this.brush instanceof pe&&t.colorProps.includes(e))return!1;if(t.excludedProps.includes(e))return!1;if(this.basicMode&&t.transformProps.includes(e))return!1;var r=!1,n=At.getPropName(e.name),i=this.dynamics[n];if(i&&!i.disabled)if(i.dependencies){var o=this.inputLayout.map((function(t){return Zt.Type[t]}));r=i.dependencies.filter((function(t){return o.includes(t)})).length>0}else r=!0;return r}},{key:"calculate",value:function(e,r,n){var i=this;for(var o in this.point=r.createPathPoint(),this.statics)this.point[o]=this.statics[o];return this.calculateProperty(K.Property.SIZE,e,r,n),t.colorProps.forEach((function(t){return i.calculateProperty(t,e,r,n)})),t.transformProps.forEach((function(t){return i.calculateTransform(t,e,r,n)})),this.point}},{key:"calculateProperty",value:function(e,r,n,i){if(this.layout.includes(e)){var o,a=At.getPropName(e.name),s=this.dynamics[a],u=this.state[a];if("function"==typeof u.resolve)o=u.resolve(r,n,i);else if(isFinite(n.pressure)||r&&isFinite(r.pressure)){var c=n.pressure||r.pressure/2;o=t.mapTo(c,u.pressure,s.value)}else{var l=n.speed(r,i);o=t.mapTo(l,u.velocity,s.value)}this.point[At.getPropName(e.name)]=o}}},{key:"calculateTransform",value:function(e,r,n,i){if(this.layout.includes(e)){var o,a=At.getPropName(e.name),s=this.dynamics[a],u=this.state[a];if("function"==typeof u.resolve)o=u.resolve(r,n,i);else if(s.dependencies)if(e==K.Property.ROTATION)isFinite(n.rotation)?o=n.rotation:isFinite(n.azimuth)&&(o=n.computeNearestAzimuthAngle(r));else if(s.dependencies.includes(Zt.Type.ALTITUDE)&&isFinite(n.altitude)){n.cosAltitude||(n.cosAltitude=Math.cos(n.altitude));var c=n.cosAltitude;o=t.mapTo(c,u.altitude,s.value)}else if((e==K.Property.SCALE_X||e==K.Property.SCALE_Y)&&(s.dependencies.includes(Zt.Type.RADIUS_X)||s.dependencies.includes(Zt.Type.RADIUS_Y)))if(isFinite(n.radiusX)&&isFinite(n.radiusY)){var l=e==K.Property.SCALE_X?"radiusX":"radiusY",h=n[l];o=t.mapTo(h,u[l],s.value)}else o=1;if(!isFinite(o))throw new Error("Property ".concat(e.name," has no value"));this.point[At.getPropName(e.name)]=o}}},{key:"reset",value:function(e,r,n){var i=this,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};if(this.brush=r,this.dynamics=o,this.statics={},this.color={},this.inputLayout=ae.getLayout(e),this.layout=K.Property.values.filter((function(t){return i.isLayoutPart(t)})),"size"in a){if(this.isLayoutPart(K.Property.SIZE))throw new Error("Size should exist only in dynamics or statics");this.statics.size=a.size}else if(!this.isLayoutPart(K.Property.SIZE))throw new Error("Size not found. Should be set through dynamics or statics.");t.colorProps.forEach((function(t){var e=At.getPropName(t.name);i.isLayoutPart(t)?i.color[e]=n[e]:(i.statics[e]=isFinite(a[e])?a[e]:n[e],i.color[e]=i.statics[e])})),H.init(this.color),t.transformProps.forEach((function(t){if(!i.isLayoutPart(t)){var e=At.getPropName(t.name);isFinite(a[e])&&(i.statics[e]=a[e])}})),this.resetState()}},{key:"resetState",value:function(){var e=this;this.state={},[K.Property.SIZE].concat(t.colorProps).forEach((function(r){if(e.layout.includes(r)){var n=At.getPropName(r.name),i=e.dynamics[n],o={};if(i.resolve)o.resolve=t.resolveAction(i.resolve);else{if(!i.value)throw new Error("PathPointContext: dynamics ".concat(n," value property not found"));var a=Object.clone(i.velocity)||{min:0,max:4e3};a.remap=t.resolveAction(a.remap||i.value.remap);var s=Object.clone(i.pressure)||{min:0,max:1};s.remap=t.resolveAction(s.remap||i.value.remap),o.velocity=t.validateRange(n,a,{min:0,max:3e4}),o.pressure=t.validateRange(n,s,{min:0,max:1})}e.state[n]=o}})),t.transformProps.forEach((function(r){if(e.layout.includes(r)){var n=At.getPropName(r.name),i=e.dynamics[n],o={};if(i.resolve)o.resolve=t.resolveAction(i.resolve);else if(i.dependencies){if(i.dependencies.includes(Zt.Type.ALTITUDE)){if(!i.value)throw new Error("PathPointContext: dynamics ".concat(n," value property not found"));var a=Object.clone(i.altitude)||{min:0,max:Math.PI/2};a.remap=t.resolveAction(a.remap||i.value.remap),o.altitude=t.validateRange(n,a,{min:0,max:Math.PI/2})}if(r==K.Property.SCALE_X&&i.dependencies.includes(Zt.Type.RADIUS_X)||r==K.Property.SCALE_Y&&i.dependencies.includes(Zt.Type.RADIUS_Y)){if(!i.value)throw new Error("PathPointContext: dynamics ".concat(n," value property not found"));var s=r==K.Property.SCALE_X?"radiusX":"radiusY",u=Object.clone(i[s])||{min:0,max:50};u.remap=t.resolveAction(u.remap||i.value.remap),o[s]=t.validateRange(n,u,{min:0,max:50})}}e.state[n]=o}}))}}],[{key:"resolveAction",value:function(t){if(t)return"string"==typeof t?t=new le(t):"function"==typeof t?t=le.getInstance(t):t instanceof le||(t=new le(t.name,t.value)),t.value}},{key:"validateRange",value:function(t,e,r){if(e.min<r.min||e.max>r.max)throw new Error("".concat(t," config is out of range - (").concat(e.min,", ").concat(e.max,"), expected values interval - (").concat(r.min,", ").concat(r.max,")"));if(e.min>e.max)throw new Error("".concat(t," min ").concat(e.min," exceeds max ").concat(e.max));return e}},{key:"mapTo",value:function(t,e,r){var n=(At.clamp(t,e)-e.min)/(e.max-e.min);return e.remap&&(n=e.remap(n)),r.min+n*(r.max-r.min)}}]),t}(),ve=function(){function t(){e(this,t),this.path=[],this.phase=t.Phase.END;var r=!1;Object.defineProperty(this,"keepAllData",{get:function(){return r},set:function(t){r=t,this.reset()},enumerable:!0}),Object.defineProperty(this,"allData",{get:function(){return this.getOutput(this.path.slice(),t.OutputType.ALL_DATA)},enumerable:!0})}return I(t,[{key:"add",value:function(e,r,n){var i;if(!this.move(e))throw new Error("Cannot move from phase ".concat(this.phase.name," to phase ").concat(e.name));var o=this.addImpl(r,n);return this.keepAllData&&(i=this.path).push.apply(i,w(o.added)),{added:this.getOutput(o.added,t.OutputType.ADDITION),predicted:this.getOutput(o.predicted,t.OutputType.PREDICTION)}}},{key:"addImpl",value:function(t,e){throw new Error("Abstract method addImpl of DataProcessor should be implemented")}},{key:"getOutput",value:function(t,e){return t}},{key:"move",value:function(e){return(this.phase!=t.Phase.END||e==t.Phase.BEGIN)&&((this.phase!=t.Phase.BEGIN||e==t.Phase.UPDATE||e==t.Phase.END)&&((this.phase!=t.Phase.UPDATE||e==t.Phase.UPDATE||e==t.Phase.END)&&(e==t.Phase.BEGIN&&this.reset(),this.phase=e,!0)))}},{key:"reset",value:function(){this.path.clear(),this.phase=t.Phase.END}}]),t}();ve.createEnum("Phase",["BEGIN","UPDATE","END"]),ve.createEnum("OutputType",["ADDITION","PREDICTION","ALL_DATA"]);var ge=function(){function t(){e(this,t),this.reset()}return I(t,[{key:"add",value:function(t,e,r){var n;t==ve.Phase.BEGIN?this.reset(!0):t==ve.Phase.END&&(this.last=!0),e&&(n=this.accumulatedAddition).push.apply(n,w(e)),r&&(this.lastPrediction=r)}},{key:"reset",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.first=t,this.last=!1,this.accumulatedAddition=[],this.lastPrediction=[]}}]),t}(),me=function(){function t(r,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;e(this,t),Array.isArray(n)&&(n=n.toFloat32Array()),Object.defineProperty(this,"layout",{value:r,enumerable:!0}),Object.defineProperty(this,"points",{get:function(){return n},enumerable:!0}),Object.defineProperty(this,"stride",{value:r.length,enumerable:!0}),Object.defineProperty(this,"length",{value:n.length/r.length,enumerable:!0}),Object.defineProperty(this,"segmentsCount",{value:this.length-3,configurable:!0,enumerable:!0}),Object.defineProperty(this,"pointProps",{value:i,enumerable:!0}),this.ts=o,this.tf=a,this.restoreBuffer=function(t){return n=new Float32Array(t)},Object.defineProperty(this,"color",{get:function(){var t=this.pointProps,e=t.red,r=t.green,n=t.blue,i=t.alpha;return isFinite(e)&&isFinite(r)&&isFinite(n)?H.from(e,r,n,i):void 0},set:function(t){t?(i.red=t.red,i.green=t.green,i.blue=t.blue,i.alpha=t.alpha):(i.red=void 0,i.green=void 0,i.blue=void 0,i.alpha=void 0)},enumerable:!0}),Object.defineProperty(this,"size",{get:function(){return i.size},set:function(t){i.size=t},enumerable:!0}),this.validate()}return I(t,[{key:"validate",value:function(){if(!this.layout.includes(K.Property.X))throw new Error("Layout doesn't contains required properties X");if(!this.layout.includes(K.Property.Y))throw new Error("Layout doesn't contains required properties Y");if(!this.layout.includes(K.Property.SIZE)&&isNaN(this.size))throw new Error("Size information is required. Please provide via layout or through pointProps property.");if(0==this.points.length)throw new Error("Empty spline is not allowed");if(this.points.length%this.stride!=0)throw new Error("Path length doesn't match the stride provided via the layout");this.validateSegmentsCount()}},{key:"validateSegmentsCount",value:function(){if(this.segmentsCount<1)throw new Error("Incompleted spline found. Spline is defined with at least 4 control points.")}},{key:"clone",value:function(){return new t(this.layout.slice(),this.points.clone(),Object.clone(this.pointProps),this.ts,this.tf)}},{key:"getPoint",value:function(t){if(t>=this.length||t<0)throw new Error("Index ".concat(t," out of range - (0, ").concat(this.length-1,")"));var e=K.createInstance(this.pointProps);return e.fill(this.layout,this.points,t),this.transform&&e.transform(this.transform),e}},{key:"getPath",value:function(){for(var t=[],e=this.layout.indexOf(K.Property.X),r=this.layout.indexOf(K.Property.Y),n=0;n<this.length;n++)t.push(this.points[n*this.stride+e],this.points[n*this.stride+r]);return t}},{key:"slice",value:function(e,r,n,i){if(e<0||e>this.length-4)throw new Error("Invalid fromIndex ".concat(e," found. Ensure that fromIndex range is {0, ").concat(this.length-4,"}."));if(r<1||r+1>this.length)throw new Error("Invalid toIndex ".concat(r," found. Ensure that fromIndex range is {1, ").concat(this.length,"}."));if(r+1-e<4)throw new Error("Invalid range {".concat(e,", ").concat(r,"} found. At least 4 points are needed to define spline."));var o=this.points.slice(e*this.stride,(r+1)*this.stride),a=new t(this.layout.slice(),o,Object.clone(this.pointProps),n,i);return a.randomSeed=this.randomSeed,a}},{key:"toJSON",value:function(){return{layout:this.layout.map((function(t){return t.name})),points:ce.encode(this.points,this.encoding),pointProps:this.pointProps,ts:this.ts,tf:this.tf,randomSeed:this.randomSeed}}}],[{key:"fromJSON",value:function(e){var r=ce.decode(e.points),n=new t(e.layout.map((function(t){return K.Property[t]})),r,e.pointProps,e.ts,e.tf);return n.randomSeed=e.randomSeed,n}},{key:"createRect",value:function(e,r,n){var i=e.toPath(r,n);return new t(i.layout,i.points,{size:i.size,red:r.red,green:r.green,blue:r.blue,alpha:r.alpha})}}]),t}();function be(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var xe=function(t){o(i,t);var r,n=(r=i,function(){var t,e=c(r);if(be()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function i(t,r,o){var a,u=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];return e(this,i),a=n.call(this,t,r,o),Object.defineProperty(s(a),"tValues",{value:Object.freeze(u),enumerable:!0}),Object.defineProperty(s(a),"ts",{get:function(){return u.first},enumerable:!0}),Object.defineProperty(s(a),"tf",{get:function(){return u.last},enumerable:!0}),delete a.segmentsCount,a}return I(i,[{key:"slice",get:function(){}}]),I(i,[{key:"validateSegmentsCount",value:function(){}},{key:"getPointT",value:function(t){return this.tValues[t]}},{key:"getBounds",value:function(t){return $.ofSpline(this,t)}},{key:"toJSON",value:function(){return{layout:this.layout.map((function(t){return t.name})),points:ce.encode(this.points,this.encoding),pointProps:this.pointProps,tValues:this.tValues}}}],[{key:"fromJSON",value:function(t){var e=ce.decode(t.points);return new i(t.layout.map((function(t){return K.Property[t]})),e,t.pointProps,t.tValues)}}]),i}(me),Ee={stride:2,sort:function(t,e){return this.sortArrayPart(t,0,t.length-this.stride,e),t},partition:function(t,e,r,n){for(var i=t[r],o=t[r+1],a=e-this.stride,s=e;s<r;s+=2)n?n(i,o,t[s],t[s+1])&&(a+=this.stride,this.swap(t,a,s)):(i>t[s]||i==t[s]&&o>t[s+1])&&(a+=this.stride,this.swap(t,a,s));return this.swap(t,a+this.stride,r),a+this.stride},swap:function(t,e,r){var n=t[e],i=t[e+1];return t[e]=t[r],t[e+1]=t[r+1],t[r]=n,t[r+1]=i,t},sortArrayPart:function(t,e,r,n){if(e<r){var i=this.partition(t,e,r,n);this.sortArrayPart(t,e,i-this.stride,n),this.sortArrayPart(t,i+this.stride,r,n)}}},Pe={monotoneChain:function(t){var e=Pe.ARRAY_TYPE;if(e||(e=Array),t.length<=0)return new e;Ee.sort(t);for(var r=new e(t.length),n=0,i=0;i<t.length;i+=2){for(;n>=4&&this.cross(r[n-4],r[n-3],r[n-2],r[n-1],t[i],t[i+1])<=0;)n-=2;r[n]=t[i],r[n+1]=t[i+1],n+=2}r=r.slice(0,n);var o,a=new e(t.length);n=0;for(var s=t.length-2;s>=0;s-=2){for(;n>=4&&this.cross(a[n-4],a[n-3],a[n-2],a[n-1],t[s],t[s+1])<=0;)n-=2;a[n]=t[s],a[n+1]=t[s+1],n+=2}return a=a.slice(0,n-2),e==Float32Array?((o=new Float32Array(a.length+r.length)).set(a),o.set(r,a.length)):o=a.concat(r),o},cross:function(t,e,r,n,i,o){return(r-t)*(o-e)-(n-e)*(i-t)}};function ke(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var we=function(t){o(i,t);var r,n=(r=i,function(){var t,e=c(r);if(ke()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function i(t,r){var o;return e(this,i),(o=n.call(this)).inputBuffer=[],o.hasPrediction=!0,Object.defineProperty(s(o),"layout",{get:function(){return t},set:function(e){t=e,this.reset()},enumerable:!0}),Object.defineProperty(s(o),"pathPointCalculator",{get:function(){return r},set:function(t){r=t,this.reset()},enumerable:!0}),o}return I(i,[{key:"togglePrediction",value:function(t){this.hasPrediction=t}},{key:"addImpl",value:function(t,e){if(t.phase!=this.phase)throw new Error("The phase of the addition (".concat(t.phase.name,") doesn't match the phase of the PathProducer (").concat(this.phase.name,")"));var r=[],n=[];t&&this.inputBuffer.push(t);var i=this.inputBuffer.length>=3?this.inputBuffer[this.inputBuffer.length-3]:null,o=this.inputBuffer.length>=2?this.inputBuffer[this.inputBuffer.length-2]:null,a=this.inputBuffer.length>=1?this.inputBuffer[this.inputBuffer.length-1]:null,s=this.calculate(i,o,a);return t&&s&&r.push.apply(r,w(s.asArray(this.layout))),this.phase==ve.Phase.END?(s=this.calculate(o,a,null))&&r.push.apply(r,w(s.asArray(this.layout))):!this.hasPrediction||this.phase!=ve.Phase.UPDATE&&null==e||(s=this.calculate(o,a,e))&&(n.push.apply(n,w(s.asArray(this.layout))),(s=this.calculate(a,e,null))&&n.push.apply(n,w(s.asArray(this.layout)))),{added:r,predicted:n}}},{key:"calculate",value:function(t,e,r){return e?this.pathPointCalculator(t,e,r):null}},{key:"reset",value:function(){q(c(i.prototype),"reset",this).call(this),this.inputBuffer.clear()}}]),i}(ve),Re=function(){function t(){e(this,t),this.path=[],this.firstSegment=!1,this.lastSegment=!0;var r=!1;Object.defineProperty(this,"keepAllData",{get:function(){return r},set:function(t){r=t,this.reset()},enumerable:!0}),Object.defineProperty(this,"allData",{get:function(){return this.getOutput(this.path.slice(),t.OutputType.ALL_DATA)},enumerable:!0})}return I(t,[{key:"add",value:function(e,r,n,i){var o;if(e&&!this.lastSegment)throw new Error("Cannot start new segment before the previous is ended");e&&this.path.clear(),this.firstSegment=e,this.lastSegment=r;var a=this.addImpl(n,i);return this.keepAllData&&(o=this.path).push.apply(o,w(a.added)),{added:this.getOutput(a.added,t.OutputType.ADDITION),predicted:this.getOutput(a.predicted,t.OutputType.PREDICTION)}}},{key:"get",value:function(e){this.reset(),this.firstSegment=!0,this.lastSegment=!0;var r=this.getImpl(e);return this.getOutput(r,t.OutputType.PROCESSOR)}},{key:"addImpl",value:function(t,e){throw new Error("Abstract method addImpl of DataSequenceProcessor should be implemented")}},{key:"getImpl",value:function(t){throw new Error("Abstract method getImpl of DataSequenceProcessor should be implemented")}},{key:"getOutput",value:function(t,e){return t}},{key:"reset",value:function(){this.path.clear(),this.firstSegment=!1,this.lastSegment=!0}}]),t}();function Se(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}Re.createEnum("OutputType",["ADDITION","PREDICTION","ALL_DATA","PROCESSOR"]);var Ie=[-6e-6,-139e-6,-185e-6,414e-6,.002357,.003357,-.003135,-.023928,-.042909,-.017858,.096525,.254692,.347072,.26881,.114933],Te=function(t){o(i,t);var r,n=(r=i,function(){var t,e=c(r);if(Se()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function i(t){var r,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:15;return e(this,i),(r=n.call(this)).buffer=[],r.pointsCount=0,r.filter=Ie.slice(),Object.defineProperty(s(r),"dimsCount",{get:function(){return t},set:function(e){t=e,this.reset()},enumerable:!0}),Object.defineProperty(s(r),"movingAverageWindowSize",{get:function(){return o},set:function(t){o=t,this.filter.length!=t&&(this.filter=i.resample(Ie,t)),this.predictionPointsCount=4*t/15,this.windowSize=this.filter.length,this.reset()},enumerable:!0}),r.movingAverageWindowSize=o,r}return I(i,[{key:"addImpl",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return{added:this.lastSegment?this.project(t):this.addSequence(t),predicted:this.project(e)}}},{key:"getImpl",value:function(t){return this.project(t)}},{key:"project",value:function(t){if(t.length%this.dimsCount!=0)throw new Error("Points size ('".concat(t.length,"') must be multiple of the dimensions count ('").concat(this.dimsCount,"')."));if(0==t.length)return[];var e=[],r=this.buffer.slice(),n=t.slice(0,t.length-this.dimsCount),i=this.addSequence(n);e.push.apply(e,w(i));for(var o=t.slice(t.length-this.dimsCount,t.length),a=this.predictionPointsCount,s=0;s<a;s++){var u=this.addPoint(o);a-s<=this.pointsCount&&e.push.apply(e,w(u))}return this.buffer=r,e}},{key:"addSequence",value:function(t){if(t.length%this.dimsCount!=0)throw new Error("Points size ('".concat(t.length,"') must be multiple of the dimensions count ('").concat(this.dimsCount,"')."));for(var e=[],r=t.length/this.dimsCount,n=0;n<r;n++){var i=this.addPoint(t.slice(n*this.dimsCount,(n+1)*this.dimsCount));e.push.apply(e,w(i))}return this.pointsCount+=r,e}},{key:"addPoint",value:function(t){var e;for((e=this.buffer).push.apply(e,w(t));this.buffer.length<this.windowSize*this.dimsCount;){var r;(r=this.buffer).unshift.apply(r,w(this.buffer.slice(0,this.dimsCount)))}for(;this.buffer.length>this.windowSize*this.dimsCount;)this.buffer=this.buffer.slice(this.dimsCount);return this.filterBuffer()}},{key:"filterBuffer",value:function(){for(var t=[],e=0;e<this.windowSize;e++)for(var r=0;r<this.dimsCount;r++)isNaN(t[r])&&(t[r]=0),t[r]+=this.buffer[e*this.dimsCount+r]*this.filter[e];return t}},{key:"reset",value:function(){q(c(i.prototype),"reset",this).call(this),this.pointsCount=0,this.buffer.clear()}}],[{key:"resample",value:function(t,e){for(var r=new Array(e),n=t.length/e,i=0;i<e;i++){var o=(t.length-1)*i/(e-1),a=Math.floor(o),s=Math.ceil(o),u=o-a,c=t[a]*(1-u)+t[s]*u;c*=n,r[i]=c}return r}}]),i}(Re);function Ae(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var Ce=function(t){o(i,t);var r,n=(r=i,function(){var t,e=c(r);if(Ae()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function i(t){var r;return e(this,i),(r=n.call(this)).pathPointProps={},r.lastSpline=[],Object.defineProperty(s(r),"layout",{get:function(){return t},set:function(e){t=e,this.reset()},enumerable:!0}),r}return I(i,[{key:"addImpl",value:function(t,e){0==this.lastSpline.length&&t.length>0&&t.unshift.apply(t,w(t.slice(0,this.layout.length))),this.lastSegment&&(t.length>=this.layout.length?t.push.apply(t,w(t.slice(t.length-this.layout.length,t.length))):t.push.apply(t,w(this.getLastPart())));var r=this.getFirstPart();return this.lastSpline=r.concat(t),{added:t,predicted:this.getPredictedSpline(e)}}},{key:"getImpl",value:function(t){var e=[];return t.length>0&&(e.push.apply(e,w(t.slice(0,this.layout.length))),e.push.apply(e,w(t)),t.length>=this.layout.length&&e.push.apply(e,w(t.slice(t.length-this.layout.length,t.length)))),t}},{key:"getOutput",value:function(t,e){var r=e==Re.OutputType.ADDITION?this.lastSpline.length>=4*this.layout.length?this.lastSpline:[]:t;return 0==r.length?void 0:new me(this.layout,r,this.pathPointProps,0,1)}},{key:"getFirstPart",value:function(){return this.lastSpline.slice(Math.max(0,this.lastSpline.length-3*this.layout.length),this.lastSpline.length)}},{key:"getLastPart",value:function(){return this.lastSpline.slice(this.lastSpline.length-this.layout.length,this.lastSpline.length)}},{key:"getPredictedSpline",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=[];if(t.length>0){var r=this.getFirstPart();for(e.push.apply(e,w(r)),e.push.apply(e,w(t)),e.push.apply(e,w(e.slice(e.length-this.layout.length,e.length)));e.length<4*this.layout.length;)e.unshift(e.slice(0,this.layout.length))}return e}},{key:"reset",value:function(){q(c(i.prototype),"reset",this).call(this),this.lastSpline.clear()}}]),i}(Re);function De(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var Oe=function(t,e,r,n,i,o,a,s,u,c,l,h,f,d,p,y){var v=new A(16);return v[0]=t,v[1]=e,v[2]=r,v[3]=n,v[4]=i,v[5]=o,v[6]=a,v[7]=s,v[8]=u,v[9]=c,v[10]=l,v[11]=h,v[12]=f,v[13]=d,v[14]=p,v[15]=y,v}(0,-.5,1,-.5,1,0,-2.5,1.5,0,.5,2,-1.5,0,0,-.5,.5),Me=function(t){o(i,t);var r,n=(r=i,function(){var t,e=c(r);if(De()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function i(){var t,r,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.1,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8,u=arguments.length>2&&void 0!==arguments[2]&&arguments[2],c=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return e(this,i),(t=n.call(this)).spacing=o,t.splitCount=a,t.interpolateByLength=u,t.calculateDerivates=c,t.sizeScaleFactor=1,t.lastPoint=[],Object.defineProperty(s(t),"inputLayout",{get:function(){return r},set:function(t){r=t,this.inputStride=t.length,this.layout=this.calculateDerivates?t.concat([K.Property.D_X,K.Property.D_Y]):t,this.layoutIndex={},this.layout.indexed||(this.layout=new Proxy(this.layout,{get:function(t,e,r){if("indexed"==e)return!0;if("target"==e)return t;if("getIndex"==e){var n=t.index;return n||(n={},t.forEach((function(t,e){return n[t.name]=e})),t.index=n),function(t){return t.name in n?n[t.name]:-1}}return Reflect.get.apply(Reflect,arguments)}})),this.polynomials=[];for(var e=0;e<this.inputStride;e++)this.polynomials.push(B())},enumerable:!0}),t.c=B(),t.coefficientsVector=B(),t.coefficientDerivatesVector=B(),t}return I(i,[{key:"addImpl",value:function(t,e){return{added:this.getDiscretizedPath(t,!0),predicted:this.getDiscretizedPath(e,!1)}}},{key:"getImpl",value:function(t){return this.getDiscretizedPath(t)}},{key:"getOutput",value:function(t){return 0==t.length?void 0:new xe(this.layout.target,t,this.pathPointProps,this.tValues)}},{key:"getDiscretizedPath",value:function(t,e){if(this.keepTValues&&(this.tValues=[]),!t)return[];var r=this.discretize(t);return e&&r.length>0&&(this.lastPoint=r.slice(r.length-this.layout.length,r.length)),r}},{key:"discretize",value:function(t){if(this.lastPoint.length>0&&this.lastPoint.length!=this.layout.length)throw new Error("Incorrect or missing last point");0==this.lastPoint.length&&(this.inputLayout=t.layout,this.pathPointProps=t.pointProps);for(var e=[],r=this.splitCount,n=Math.max(1,10*(this.spacing>1?1:this.spacing)),i=this.lastPoint,o=0;o<t.segmentsCount;o++){for(var a=this.inputStride*(o+0),s=this.inputStride*(o+1),u=this.inputStride*(o+2),c=this.inputStride*(o+3),l=0;l<this.inputStride;l++){var h=t.points[a+l],f=t.points[s+l],d=t.points[u+l],p=t.points[c+l];U(this.c,h,f,d,p),G(this.polynomials[l],this.c,Oe)}if(this.interpolateByLength){var y=t.points[s+this.layout.getIndex(K.Property.X)],v=t.points[s+this.layout.getIndex(K.Property.Y)],g=t.points[u+this.layout.getIndex(K.Property.X)],m=t.points[u+this.layout.getIndex(K.Property.Y)],b=Math.sqrt((g-y)*(g-y)+(m-v)*(m-v)),x=this.pathPointProps.size;if(-1!=this.layout.getIndex(K.Property.SIZE)){var E=t.points[s+this.layout.getIndex(K.Property.SIZE)],P=t.points[u+this.layout.getIndex(K.Property.SIZE)];x=Math.min(E,P)}r=Math.floor(n*(b/x)/this.spacing)+1}for(var k=1/r,R=0;R<=r;R++){var S=0==i.length,I=R/r;if(0==o&&I<t.ts){if(!(I+k>=t.ts))continue;I=t.ts,S=this.spacing<=1}if(o==t.segmentsCount-1&&I>=t.tf){if(!(I<t.tf+k))continue;I=t.tf,S=this.lastSegment&&this.spacing<=1}if(!(o>0&&0==I)){var T=this.samplePoint(I);if(!S&&i.length>0){var A=this.distanceSqrd(i,T,this.inputLayout),C=this.layout.getIndex(K.Property.SIZE),D=(-1==C?this.pathPointProps.size:(i[C]+T[C])/2)*this.spacing;S=A>=D*D}S&&(e.push.apply(e,w(T)),i=T,this.keepTValues&&this.tValues.push(I))}}}return this.keepTValues&&(0!=e.length&&this.tValues.first==t.ts||(e.unshift.apply(e,w(this.samplePoint(t.ts))),this.tValues.unshift(t.ts)),this.tValues.last!=t.tf&&(e.push.apply(e,w(this.samplePoint(t.tf))),this.tValues.push(t.tf))),e}},{key:"samplePoint",value:function(t){var e=[];U(this.coefficientsVector,1,t,t*t,t*t*t);for(var r=0;r<this.inputStride;r++){var n=j(this.polynomials[r],this.coefficientsVector);r==this.layout.getIndex(K.Property.SIZE)&&(n*=this.sizeScaleFactor),e.push(n)}return this.calculateDerivates&&(e.push(this.getDerivativeOf(this.polynomials[this.layout.getIndex(K.Property.X)])),e.push(this.getDerivativeOf(this.polynomials[this.layout.getIndex(K.Property.Y)]))),e}},{key:"getDerivativeOf",value:function(t){return U(this.coefficientDerivatesVector,t[1],2*t[2],3*t[3],0),j(this.coefficientDerivatesVector,this.coefficientsVector)}},{key:"distanceSqrd",value:function(t,e){var r=t[this.layout.getIndex(K.Property.X)]-e[this.layout.getIndex(K.Property.X)],n=t[this.layout.getIndex(K.Property.Y)]-e[this.layout.getIndex(K.Property.Y)];return r*r+n*n}},{key:"reset",value:function(){q(c(i.prototype),"reset",this).call(this),this.lastPoint.clear()}}]),i}(Re);function Ne(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var Le=function(t){o(i,t);var r,n=(r=i,function(){var t,e=c(r);if(Ne()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function i(t){var r;return e(this,i),r=n.call(this),Object.defineProperty(s(r),"brush",{get:function(){if(!t)throw new Error("brush not found");return t},set:function(e){t=e,this.reset()},enumerable:!0}),r}return I(i,[{key:"addImpl",value:function(t,e){return{added:this.generatePolygons(t),predicted:this.generatePolygons(e)}}},{key:"getImpl",value:function(t){return this.generatePolygons(t)}},{key:"generatePolygons",value:function(t){if(!t)return[];for(var e=[],r=0;r<t.length;r++){var n=t.getPoint(r),i=this.applyBrush(n);e.push(i)}return e}},{key:"applyBrush",value:function(t){for(var e=[],r=this.createTransform(t),n=this.brush.selectShape(r.maxScale),i=0;i<n.length;i+=2){var o=B();G(o,F(n[i],n[i+1],0,1),r),e.push(o[0]/o[3],o[1]/o[3])}return e}},{key:"createTransform",value:function(t){if(isNaN(t.size))throw new Error("Size information not found.");var e=C(),r=t.size*t.scaleX,n=t.size*t.scaleY,i=t.size*t.scaleZ;return e.maxScale=Math.max(r,n,i),O(e,e,N(t.x,t.y,t.z||0)),function(t,e,r){var n=Math.sin(r),i=Math.cos(r),o=e[0],a=e[1],s=e[2],u=e[3],c=e[4],l=e[5],h=e[6],f=e[7];e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*i+c*n,t[1]=a*i+l*n,t[2]=s*i+h*n,t[3]=u*i+f*n,t[4]=c*i-o*n,t[5]=l*i-a*n,t[6]=h*i-s*n,t[7]=f*i-u*n}(e,e,t.rotation),O(e,e,N(t.offsetX,t.offsetY,t.offsetZ)),function(t,e,r){var n=r[0],i=r[1],o=r[2];t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t[8]=e[8]*o,t[9]=e[9]*o,t[10]=e[10]*o,t[11]=e[11]*o,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]}(e,e,N(r,n,i)),e}}]),i}(Re);function _e(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var Be=function(t){o(i,t);var r,n=(r=i,function(){var t,e=c(r);if(_e()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function i(){var t;return e(this,i),(t=n.call(this)).lastPolygon=[],t}return I(i,[{key:"addImpl",value:function(t,e){return{added:this.getConvexHulls(t,!0),predicted:this.getConvexHulls(e)}}},{key:"getImpl",value:function(t){return this.getConvexHulls(t)}},{key:"getConvexHulls",value:function(t,e){var r=[],n=this.lastPolygon;return t.forEach((function(t){var e;(e=n).push.apply(e,w(t)),r.push(Pe.monotoneChain(n)),n=t})),e&&t.length>0&&(this.lastPolygon=t.last.slice()),r}},{key:"reset",value:function(){q(c(i.prototype),"reset",this).call(this),this.lastPolygon.clear()}}]),i}(Re);function Fe(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var Ue=function(t){o(i,t);var r,n=(r=i,function(){var t,e=c(r);if(Fe()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function i(){var t;return e(this,i),(t=n.call(this)).processPrediction=!1,t}return I(i,[{key:"addImpl",value:function(t,e){return{added:this.merge(t),predicted:this.processPrediction?this.merge(e):e}}},{key:"getImpl",value:function(t){return this.merge(t)}},{key:"merge",value:function(t){return t.length?ut.union(t):[]}}]),i}(Re);function je(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var Ge=function(t){o(i,t);var r,n=(r=i,function(){var t,e=c(r);if(je()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function i(){var t,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.1;return e(this,i),(t=n.call(this)).epsilon=r,t}return I(i,[{key:"addImpl",value:function(t,e){return{added:this.simplify(t),predicted:e}}},{key:"getImpl",value:function(t){return this.simplify(t)}},{key:"simplify",value:function(t){var e=this;return t.map((function(t){return e.simplifyPolygonDouglasPeucker(t)}))}},{key:"simplifyPolygonDouglasPeucker",value:function(t){if(t.length<6)return t;t instanceof Float32Array&&(t=t.toArray());var e=this.simplifyPolylineDouglasPeucker(t.concat([t[0],t[1]]));return e.length<8?t:e.slice(0,e.length-2)}},{key:"simplifyPolylineDouglasPeucker",value:function(t){if(this.epsilon<=0)return[];if(t.length<4)return t;for(var e,r=0,n=0,o=2;o<t.length-2;o+=2){var a=i.perpendicularDistance(t[o],t[o+1],t[0],t[1],t[t.length-2],t[t.length-1]);a>r&&(n=o,r=a)}if(r>this.epsilon){var s=this.simplifyPolylineDouglasPeucker(t.slice(0,n+2)),u=this.simplifyPolylineDouglasPeucker(t.slice(n,t.length));e=s.concat(u.slice(2,u.length))}else e=[t[0],t[1],t[t.length-2],t[t.length-1]];return e}}],[{key:"perpendicularDistance",value:function(t,e,r,n,i,o){var a=t-r,s=i-r,u=a*(o-n)-s*(e-n);u*=u;var c=(a=i-r)*a+(s=o-n)*s;return c>0?Math.sqrt(u/c):Math.sqrt((r-t)*(r-t)+(n-e)*(n-e))}}]),i}(Re),Xe=function(){function t(){var r=this;e(this,t),this.layout=[K.Property.X,K.Property.Y],this.pathSegment=new ge,this.pathProducer=new we(this.layout,(function(t,e,r){return e.createPathPoint()})),this.smoother=new Te(this.layout.length),this.splineProducer=new Ce(this.layout),this.splineInterpolator=new Me,this.brushApplier=new Le,this.polygonMerger=new Ue,this.polygonSimplifier=new Ge,this.splineProducer.keepAllData=!0,this.phase=null,this.raster=!1,this.pathPointProps={},this.queue=Promise.resolve(),Object.defineProperty(this,"settings",{get:function(){return{brush:r.brush,layout:r.layout,pathPointProps:r.pathPointProps,pathPointCalculator:r.calculator,movingAverageWindowSize:r.smoother.movingAverageWindowSize,splitCount:r.splineInterpolator.splitCount,epsilon:r.polygonSimplifier.epsilon,mergePrediction:r.polygonMerger.processPrediction}},enumerable:!0})}return I(t,[{key:"configure",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this.splineInterpolator.keepAllData=!1,this.brushApplier.keepAllData=!1,this.polygonSimplifier.keepAllData=!1,t.brush&&(this.brush=t.brush,this.raster=!(this.brush instanceof pe),this.splineInterpolator.calculateDerivates=this.raster,this.splineInterpolator.spacing=this.brush.spacing,this.splineInterpolator.interpolateByLength=this.raster,this.raster?this.splineInterpolator.keepAllData=!0:(this.brushApplier.brush=this.brush,this.brush.spacing>1?this.brushApplier.keepAllData=!0:this.polygonSimplifier.keepAllData=!0)),"basicMode"in t){if(t.basicMode&&this.raster)throw new Error("Basic mode is not supported for particles strokes");this.basicMode=t.basicMode}if(t.pathPointProps&&(this.pathPointProps=t.pathPointProps,this.splineProducer.pathPointProps=this.pathPointProps),t.pathPointCalculator&&(this.calculator=t.pathPointCalculator,this.pathProducer.pathPointCalculator=t.pathPointCalculator),t.layout){if(this.layout=t.layout,!this.raster){if(this.layout.includes(K.Property.RED))throw new Error("RED layout channel is not supported for non particles strokes");if(this.layout.includes(K.Property.GREEN))throw new Error("GREEN layout channel is not supported for non particles strokes");if(this.layout.includes(K.Property.BLUE))throw new Error("BLUE layout channel is not supported for non particles strokes");if(this.layout.includes(K.Property.ALPHA))throw new Error("ALPHA layout channel is not supported for non particles strokes")}if(!this.layout.includes(K.Property.RED)&&isNaN(this.pathPointProps.red))throw new Error("Stroke color red channel information is required. Please provide via layout or through configure settings via pathPointProps property.");if(!this.layout.includes(K.Property.GREEN)&&isNaN(this.pathPointProps.green))throw new Error("Stroke color green channel information is required. Please provide via layout or through configure settings via pathPointProps property.");if(!this.layout.includes(K.Property.BLUE)&&isNaN(this.pathPointProps.blue))throw new Error("Stroke color blue channel information is required. Please provide via layout or through configure settings via pathPointProps property.");if(!this.layout.includes(K.Property.ALPHA)&&isNaN(this.pathPointProps.alpha))throw new Error("Stroke color alpha channel information is required. Please provide via layout or through configure settings via pathPointProps property.");if(!this.layout.includes(K.Property.SIZE)&&isNaN(this.pathPointProps.size))throw new Error("Stroke size information is required. Please provide via layout or through configure settings via pathPointProps property.");this.pathProducer.layout=this.layout,this.smoother.dimsCount=this.layout.length,this.splineProducer.layout=this.layout}t.movingAverageWindowSize>0&&(this.smoother.movingAverageWindowSize=t.movingAverageWindowSize),t.splitCount>0&&(this.splineInterpolator.splitCount=t.splitCount),t.epsilon>0&&(this.polygonSimplifier.epsilon=t.epsilon),"interpolateByLength"in t&&(this.splineInterpolator.interpolateByLength=t.interpolateByLength),"mergePrediction"in t&&(this.polygonMerger.processPrediction=t.mergePrediction),t.onBuildComplete&&(this.onComplete=t.onBuildComplete),this.reset()}},{key:"createSensorPoint",value:function(e,r,n){var i={x:r,y:n,touchID:this.touchID};return t.createPoint(e,i)}},{key:"add",value:function(t,e){if(!this.brush)throw new Error("InkBuilder instance is not configured properly, brush is not found");if(!this.layout)throw new Error("InkBuilder instance is not configured properly, layout is not found");if(!this.calculator)throw new Error("InkBuilder instance is not configured properly, pathPointCalculator is not found");if(!t.phase)throw new Error("SensorPoint phase is not found");this.aborted=!1,this.phase=t.phase;var r=new se(t),n=e?new se(e):null;this.device&&(this.phase==ve.Phase.BEGIN&&this.device.openStream(t),this.device.add(r),this.phase==ve.Phase.END&&(this.sensorData=this.device.closeStream()));var i=this.pathProducer.add(this.phase,r,n);this.pathSegment.add(this.phase,i.added,i.predicted)}},{key:"ignore",value:function(t){if(!t.phase)throw new Error("SensorPoint phase is not found");this.device&&t&&t.phase==ve.Phase.UPDATE&&this.device.add(new se(t),!0)}},{key:"build",value:function(){throw new Error("Abstract method build of InkBuilderAbstract should be implemented")}},{key:"processSpline",value:function(t,e,r,n){throw new Error("Abstract method processSpline of InkBuilderAbstract should be implemented")}},{key:"mergeAndSimplify",value:function(t,e,r){return r=this.polygonMerger.add(t,e,r.added,r.predicted),r=this.polygonSimplifier.add(t,e,r.added,r.predicted)}},{key:"getSensorData",value:function(){return this.sensorData}},{key:"getSpline",value:function(){return new me(this.layout,this.splineProducer.allData.points,this.pathPointProps)}},{key:"getInkPath",value:function(t){var e;return this.raster?e=this.splineInterpolator.allData:this.basicMode||(this.splineInterpolator.spacing>1?e=this.brushApplier.allData:(e=this.polygonSimplifier.allData,t&&(e=this.polygonMerger.merge(e),e=this.polygonSimplifier.simplify(e)))),e}},{key:"abort",value:function(){this.aborted=!0,this.device&&this.device.closeStream(!0),this.reset(),this.restart()}},{key:"reset",value:function(){this.sensorData=null,this.pathProducer.reset(),this.smoother.reset(),this.splineProducer.reset(),this.splineInterpolator.reset(),this.brushApplier.reset(),this.convexHullChainProducer.reset(),this.polygonMerger.reset(),this.polygonSimplifier.reset()}},{key:"restart",value:function(){this.phase=void 0,this.touchID=void 0}}],[{key:"createPoint",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r={x:e.x||t.offsetX||t.clientX,y:e.y||t.offsetY||t.clientY,z:void 0,timestamp:Math.floor(t.timeStamp),pressure:void 0,radiusX:void 0,radiusY:void 0,tiltX:void 0,tiltY:void 0,rotation:void 0},n={id:void 0,type:void 0,button:void 0,buttons:void 0};if(Object.defineProperty(r,"phase",{value:ve.Phase[t.type.replace(/pointer|mouse|touch/g,"").replace(/down|start/,"BEGIN").replace(/move/,"UPDATE").replace(/up|end/,"END")],enumerable:!0}),Object.defineProperty(r,"force",{get:function(){return this.pressure},enumerable:!0}),Object.defineProperty(r,"pointer",{value:n,enumerable:!0}),Object.defineProperty(r.pointer,"provider",{get:function(){return Wt.Type[this.type.toUpperCase()]},enumerable:!0}),t instanceof PointerEvent)n.id=t.pointerId,n.type=t.pointerType,"pen"!=t.pointerType&&"mouse"!=t.pointerType||(n.button=t.button,n.buttons=t.buttons),"pen"!=t.pointerType&&"touch"!=t.pointerType||t.twist>0&&(r.rotation=Math.toRadians(t.twist)),"pen"==t.pointerType?(r.pressure=t.pressure,r.tiltX=t.tiltX,r.tiltY=t.tiltY):"touch"==t.pointerType&&t.pressure>0&&(r.pressure=t.pressure);else if(t instanceof MouseEvent)n.type="mouse",n.button=t.button,n.buttons=t.buttons;else{if(!(t instanceof TouchEvent))throw new Error("Unexpected event detected: ".concat(t.constructor.name,". Expected event should be instance of PointerEvent, MouseEvent or TouchEvent."));if(!("touchID"in e))throw new Error("props.touchID is required for touch event");if(!(t=Array.from(t.changedTouches).filter((function(t){return t.identifier==e.touchID})).first))return null;r.x||(r.x=t.offsetX||t.clientX),r.y||(r.y=t.offsetY||t.clientY),n.id=t.identifier,n.type="touch",t.force>0&&.5!==t.force&&(r.pressure=t.force),t.radiusX>0&&t.radiusY>0&&t.radiusX!=t.radiusY&&(r.radiusX=t.radiusX,r.radiusY=t.radiusY),t.rotationAngle>0&&(r.rotation=Math.toRadians(t.rotationAngle))}return r}}]),t}();function Ye(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}Xe.Phase=ve.Phase;var ze=function(t){o(i,t);var r,n=(r=i,function(){var t,e=c(r);if(Ye()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function i(){var t;return e(this,i),(t=n.call(this)).convexHullChainProducer=new Be,t}return I(i,[{key:"build",value:function(){var t=this.buildSegment();return t.phase=this.phase,t.predicted&&(t.predicted.predicted=!0),this.onComplete&&this.onComplete(t),this.phase==ve.Phase.END&&this.restart(),t}},{key:"buildSegment",value:function(){var t={added:this.pathSegment.accumulatedAddition,predicted:this.pathSegment.lastPrediction};return this.basicMode||(t=this.smoother.add(this.pathSegment.first,this.pathSegment.last,t.added,t.predicted)),t=this.splineProducer.add(this.pathSegment.first,this.pathSegment.last,t.added,t.predicted),t=this.processSegment(this.pathSegment.first,this.pathSegment.last,t.added,t.predicted),this.pathSegment.reset(),t}},{key:"processSegment",value:function(t,e,r,n){var i=this.splineInterpolator.add(t,e,r,n);return this.raster||this.basicMode||(i.added||i.predicted?(i=this.brushApplier.add(t,e,i.added,i.predicted),this.splineInterpolator.spacing<=1&&(i=this.convexHullChainProducer.add(t,e,i.added,i.predicted),i=this.mergeAndSimplify(t,e,i))):i={added:i.added?i.added.points:[],predicted:i.predicted?i.predicted.points:[]}),i}},{key:"processSpline",value:function(t){return this.processSegment(!0,!0,t).added}}]),i}(Xe),Ve=0,He=function(){function t(){e(this,t),this.results={},this.next=0,this.lastPolygon,this.init()}return I(t,[{key:"init",value:function(){var t=this,e=new Blob(['\n// let workerID;\n\nlet QuickSort;\nlet ConvexHullProducer;\n\nself.onmessage = function(e) {\n\tlet message = e.data;\n\n\tif (message.init) {\n\t\t// workerID = message.index;\n\t\timportClasses(message.imports);\n\n\t\tConvexHullProducer.ARRAY_TYPE = Float32Array;\n\n\t\treturn;\n\t}\n\n\tlet result = ConvexHullProducer.monotoneChain(message.data, message.type);\n\tself.postMessage({key: message.key, type: message.type, index: message.index, data: result}, [result.buffer]);\n}\n\nfunction importClasses(imports) {\n\tlet blob = new Blob(imports, {type: "application/javascript"});\n\tlet url = URL.createObjectURL(blob);\n\n\tself.importScripts(url);\n\n\tURL.revokeObjectURL(url);\n}\n'],{type:"application/javascript"}),r=URL.createObjectURL(e);this.workers=[new Worker(r),new Worker(r),new Worker(r),new Worker(r)],URL.revokeObjectURL(r);var n=[Object.toSource(Ee,"QuickSort"),Object.toSource(Pe,"ConvexHullProducer")];this.workers.forEach((function(e,r){e.addEventListener("message",(function(e){return t.recieve(e.data)})),e.addEventListener("error",(function(e){return t.recieveError(e,r)}),!1),e.postMessage({init:!0,index:r,imports:n})}))}},{key:"add",value:function(t,e){var r=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=Ve++,o=this.lastPolygon;return e.length>0&&(this.lastPolygon=e.last),t==ve.Phase.END&&(this.lastPolygon=null),this.results[i]={added:[],predicted:[],expected:e.length+n.length,processed:0},new Promise((function(t,a){r.results[i].resolve=t,r.send(i,"added",o,e),r.send(i,"predicted",e.last,n)}))}},{key:"reset",value:function(){this.lastPolygon=null}},{key:"send",value:function(t,e,r,n){var i=this,o=[];r&&(o=r),n.forEach((function(r,n){var a;(a=o).push.apply(a,w(r));var s=i.workers[i.next%i.workers.length];i.next++,s.postMessage({key:t,type:e,index:n,data:o}),o=r}))}},{key:"recieve",value:function(t){var e=this.results[t.key];e[t.type][t.index]=t.data,e.processed++,e.processed==e.expected&&(delete this.results[t.key],e.resolve({added:e.added,predicted:e.predicted}))}},{key:"recieveError",value:function(t,e){console.warn("worker ".concat(e)),console.error(t)}},{key:"close",value:function(){this.workers.forEach((function(t){return t.terminate()}))}}]),t}(),We=function(){function t(){e(this,t),this.queue=Promise.resolve(),this.thenables=[]}var r;return I(t,[{key:"then",value:function(t,e,r){var n=this;return this.thenables.push(t),this.queue=this.queue.then((function(){return n.thenables.shift(),t.canceled?Promise.resolve():t.apply(void 0,arguments)})),e&&this.then((function(t){return e(t,r)})),this}},{key:"catch",value:function(t){return this.queue=this.queue.catch(t),this}},{key:"cancel",value:function(){this.thenables.forEach((function(t){return t.canceled=!0}))}},{key:"isEmpty",value:function(){return 0==this.thenables.length}}],[{key:"serial",value:(r=ht(ct.mark((function e(r,n){var i;return ct.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=new t,r.forEach((function(t,e){return i.then(t,n,e)})),e.abrupt("return",i.queue);case 3:case"end":return e.stop()}}),e)}))),function(t,e){return r.apply(this,arguments)})}]),t}();function qe(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var Ze=[],Je=function(t){o(a,t);var r,n,i=(r=a,function(){var t,e=c(r);if(qe()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function a(){var t;return e(this,a),(t=i.call(this)).convexHullChainProducer=new He,Ze.push(t.convexHullChainProducer),t.queue=Promise.resolve(),t.chainQueue=new We,t}return I(a,[{key:"add",value:function(t,e){if(!this.onComplete)throw new Error("InkBuilder instance is not configured properly, onBuildComplete is not found");this.pathProducer.togglePrediction(this.chainQueue.isEmpty()),q(c(a.prototype),"add",this).call(this,t,e)}},{key:"configure",value:function(t){var e=this;this.chainQueue.isEmpty()?q(c(a.prototype),"configure",this).call(this,t):this.chainQueue.then((function(){return q(c(a.prototype),"configure",e).call(e,t)}))}},{key:"build",value:function(){var t=this;if(this.phase){var e=this.phase;this.phase==ve.Phase.END&&this.restart();var r=function(){return Promise.resolve().then((function(){return t.buildPhase=e,t.buildSegment()})).then((function(r){t.building=!1,t.aborted||(r.phase=e,r.predicted.predicted=!0,t.onComplete(r))}))};e==ve.Phase.END?this.queue=this.queue.then(r):this.building?this.queue=Promise.resolve():(this.building=!0,this.queue=r())}}},{key:"buildChain",value:function(){var t=this;if(this.phase){var e=this.phase,r=this.getLastPathSegment();this.phase==ve.Phase.END&&this.restart(),this.chainQueue.then((function(){return t.buildPhase=e,t.buildSegment(r)})).then((function(r){r.phase=e,r.predicted.predicted=!0,t.onComplete(r)}))}return this.chainQueue}},{key:"getLastPathSegment",value:function(){var t=this.pathSegment;return this.pathSegment=new ge,t}},{key:"buildSegment",value:function(t){var e;t||(t=this.pathSegment),e=this.smoother.add(t.first,t.last,t.accumulatedAddition,t.lastPrediction),e=this.splineProducer.add(t.first,t.last,e.added,e.predicted);var r=t.first,n=t.last;return t.reset(),this.processSegment(r,n,e.added,e.predicted)}},{key:"processSegment",value:function(t,e,r,n){var i=this,o=this.splineInterpolator.add(t,e,r,n);return this.raster?Promise.resolve(o):o.added||o.predicted?(o=this.brushApplier.add(t,e,o.added,o.predicted),this.splineInterpolator.spacing<=1?this.convexHullChainProducer.add(this.phase,o.added,o.predicted).then((function(r){return i.mergeAndSimplify(t,e,r)})):Promise.resolve(o)):Promise.resolve({added:o.added?o.added.points:[],predicted:o.predicted?o.predicted.points:[]})}},{key:"processSpline",value:(n=ht(ct.mark((function t(e){return ct.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.processSegment(!0,!0,e).added;case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t,this)}))),function(t){return n.apply(this,arguments)})},{key:"abort",value:function(){q(c(a.prototype),"abort",this).call(this),this.buildPhase=null,this.chainQueue.cancel()}}],[{key:"closeAll",value:function(){Ze.forEach((function(t){return t.close()})),Ze.clear()}}]),a}(Xe);function Ke(){}Ke.BlendMode={SOURCE_OVER:"source-over",DESTINATION_OVER:"destination-over",DESTINATION_IN:"destination-in",DESTINATION_OUT:"destination-out",LIGHTER:"lighter",COPY:"copy",MIN:"MIN",MAX:"MAX"};var Qe=Ke.BlendMode;function $e(t){if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(t=function(t,e){if(!t)return;if("string"==typeof t)return tr(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(r);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return tr(t,e)}(t))){var e=0,r=function(){};return{s:r,n:function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}},e:function(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,i,o=!0,a=!1;return{s:function(){n=t[Symbol.iterator]()},n:function(){var t=n.next();return o=t.done,t},e:function(t){a=!0,i=t},f:function(){try{o||null==n.return||n.return()}finally{if(a)throw i}}}}function tr(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}var er,rr,nr={createTexture:function(t,e,r){e||(e=t.CLAMP_TO_EDGE),r||(r=t.NEAREST);var n=t.createTexture();return t.bindTexture(t.TEXTURE_2D,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,r),t.bindTexture(t.TEXTURE_2D,null),n},fillTexture:function(t,e,r){return ht(ct.mark((function n(){var i,o,a,s,u,c,l;return ct.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!Array.isArray(r)){n.next=26;break}i=[],o=$e(r),n.prev=4,o.s();case 6:if((a=o.n()).done){n.next=14;break}return s=a.value,n.next=10,gt(s);case 10:u=n.sent,i.push(u);case 12:n.next=6;break;case 14:n.next=19;break;case 16:n.prev=16,n.t0=n.catch(4),o.e(n.t0);case 19:return n.prev=19,o.f(),n.finish(19);case 22:nr.completeMipMap(i),nr.initTexture(t,e,i),n.next=31;break;case 26:return c=r,n.next=29,gt(c);case 29:l=n.sent,nr.initTexture(t,e,l);case 31:case"end":return n.stop()}}),n,null,[[4,16,19,22]])})))()},completeMipMap:function(t){if(t.sort((function(t,e){return e.width-t.width})),1!=t.last.width)for(var e=t.last.width;e>1;){e/=2;var r=new OffscreenCanvas(t.last.width/2,t.last.height/2);r.getContext("2d").drawImage(t.last,0,0,r.width,r.height),t.push(r)}},initTexture:function(t,e,r){if(t.bindTexture(t.TEXTURE_2D,e),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),Array.isArray(r)){var n=r;e.size=[],n.forEach((function(r,n){t.texImage2D(t.TEXTURE_2D,n,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r),e.size.push({width:r.width,height:r.height}),r.close&&r.close()})),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR)}else t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r),e.size={width:r.width,height:r.height},r.close&&r.close();t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.bindTexture(t.TEXTURE_2D,null),this.logGLError(t,e.name)},readTexturePixels:function(t,e,r){var n=new Uint8Array(r.width*r.height*4),i=t.createFramebuffer();return t.bindFramebuffer(t.FRAMEBUFFER,i),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,e,0),t.readPixels(r.left,r.top,r.width,r.height,t.RGBA,t.UNSIGNED_BYTE,n),t.deleteFramebuffer(i),n},logGLError:function(t,e){var r=t.getError();r>0&&console.error("WebGL error - "+e+": "+r)}},ir=function(){function t(r,n,i){var o=this,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};e(this,t),this.name=r,this.spacing=a.spacing||.15,this.scattering=a.scattering||0,this.blendMode=a.blendMode||Qe.SOURCE_OVER,this.rotationMode=a.rotationMode||t.RotationMode.RANDOM,Object.defineProperty(this,"particleSettings",{get:function(){return{spacing:o.spacing,scattering:o.scattering,blendMode:o.blendMode,rotationMode:o.rotationMode}},enumerable:!0}),Object.defineProperty(this,"fillTextureSettings",{get:function(){return{randomize:o.randomizeFill,size:o.fillTextureSize,offset:o.fillTextureOffset}},enumerable:!0}),Object.defineProperty(this,"descriptor",{value:{shape:{},fill:{}},enumerable:!0}),Object.defineProperty(this,"shape",{get:function(){return Array.isArray(o.descriptor.shape)?o.descriptor.shape.map((function(t){return t.value})):o.descriptor.shape.value},enumerable:!0}),Object.defineProperty(this,"fill",{get:function(){return o.descriptor.fill.value},enumerable:!0}),this.updateShape(n),this.updateFill(i,s)}var r,n,i,o,a;return I(t,[{key:"updateShape",value:(a=ht(ct.mark((function t(e){return ct.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(Array.isArray(e)?e=e.map((function(t){return"string"==typeof t?le.getInstance(t):t instanceof le?t:new le(t.name,t.src)})):"string"==typeof e?e=le.getInstance(e):e instanceof le||(e=new le(e.name,e.value)),this.descriptor.shape=e,!this.ctx){t.next=5;break}return t.next=5,this.configureShape();case 5:case"end":return t.stop()}}),t,this)}))),function(t){return a.apply(this,arguments)})},{key:"updateFill",value:(o=ht(ct.mark((function t(e){var r,n=arguments;return ct.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=n.length>1&&void 0!==n[1]?n[1]:{},this.randomizeFill=!("randomize"in r)||r.randomize,this.fillTextureSize=r.size,this.fillTextureOffset=r.offset||{x:0,y:0},!Array.isArray(e)){t.next=6;break}throw new Error("Mipmap is not compatible whith fill texture");case 6:if("string"==typeof e?e=le.getInstance(e):e instanceof le||(e=new le(e.name,e.value)),this.descriptor.fill=e,!this.ctx){t.next=11;break}return t.next=11,this.configureFill();case 11:case"end":return t.stop()}}),t,this)}))),function(t){return o.apply(this,arguments)})},{key:"configure",value:(i=ht(ct.mark((function t(e){return ct.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.ctx=e,t.next=3,this.configureShape();case 3:return t.next=5,this.configureFill();case 5:case"end":return t.stop()}}),t,this)}))),function(t){return i.apply(this,arguments)})},{key:"configureShape",value:(n=ht(ct.mark((function t(){return ct.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.shapeTexture||(this.shapeTexture=nr.createTexture(this.ctx,this.ctx.CLAMP_TO_EDGE,this.ctx.LINEAR)),t.next=3,nr.fillTexture(this.ctx,this.shapeTexture,this.shape);case 3:case"end":return t.stop()}}),t,this)}))),function(){return n.apply(this,arguments)})},{key:"configureFill",value:(r=ht(ct.mark((function t(){return ct.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.fillTexture||(this.fillTexture=nr.createTexture(this.ctx,this.ctx.REPEAT,this.ctx.NEAREST)),t.next=3,nr.fillTexture(this.ctx,this.fillTexture,this.fill);case 3:this.fillTextureSize||(this.fillTextureSize=this.fillTexture.size);case 4:case"end":return t.stop()}}),t,this)}))),function(){return r.apply(this,arguments)})},{key:"toJSON",value:function(){return{type:this.constructor.name,name:this.name,shape:Array.isArray(this.descriptor.shape)?this.descriptor.shape.map((function(t){return t.toJSON()})):this.descriptor.shape.toJSON(),fill:this.descriptor.fill.toJSON(),particleSettings:{spacing:this.spacing,scattering:this.scattering,blendMode:this.blendMode.name,rotationMode:this.rotationMode.name},fillTextureSettings:{randomize:this.randomizeFill,size:this.fillTextureSize,offset:this.fillTextureOffset}}}},{key:"equals",value:function(t){return t==this&&t.shapeTexture==this.shapeTexture&&t.fillTexture==this.fillTexture}},{key:"delete",value:function(){this.deleteShape(),this.deleteFill()}},{key:"deleteShape",value:function(){this.shapeTexture&&(this.ctx.deleteTexture(this.shapeTexture),delete this.shapeTexture)}},{key:"deleteFill",value:function(){this.fillTexture&&(this.ctx.deleteTexture(this.fillTexture),delete this.fillTexture)}}],[{key:"fromJSON",value:function(e){e.particleSettings.blendMode=Qe[e.particleSettings.blendMode],e.particleSettings.rotationMode=t.RotationMode[e.particleSettings.rotationMode];var r=Array.isArray(e.shape)?e.shape.map((function(t){return le.fromJSON(t)})):le.fromJSON(e.shape),n=le.fromJSON(e.fill);return new t(e.name,r,n,e.particleSettings,e.fillTextureSettings)}}]),t}();function or(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}ir.createEnum("RotationMode",["NONE","RANDOM","TRAJECTORY"]);var ar=function(t){o(a,t);var r,n,i=(r=a,function(){var t,e=c(r);if(or()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function a(t,r,n,o){var u,c;return e(this,a),u=i.call(this,r.id),Object.defineProperty(s(u),"layout",{value:r.layout,enumerable:!0}),Object.defineProperty(s(u),"points",{get:function(){return r.points},enumerable:!0}),Object.defineProperty(s(u),"pointProps",{value:r.pointProps,enumerable:!0}),Object.defineProperty(s(u),"ts",{value:r.ts,enumerable:!0}),Object.defineProperty(s(u),"tf",{value:r.tf,enumerable:!0}),Object.defineProperty(s(u),"stride",{value:r.stride,enumerable:!0}),Object.defineProperty(s(u),"length",{value:r.length,enumerable:!0}),Object.defineProperty(s(u),"segmentsCount",{value:r.segmentsCount,enumerable:!0}),r.randomSeed&&Object.defineProperty(s(u),"randomSeed",{value:r.randomSeed,enumerable:!0}),Object.defineProperty(s(u),"color",{get:function(){return r.color},set:function(t){r.color=t,n&&(n.color=t)},enumerable:!0}),Object.defineProperty(s(u),"sensorData",{value:o,enumerable:!0}),Object.defineProperty(s(u),"spline",{value:r,enumerable:!0}),Object.defineProperty(s(u),"path",{get:function(){return n||this.buildPath(),n},set:function(t){n=t},enumerable:!0}),Object.defineProperty(s(u),"bounds",{get:function(){return c||(c=(c=this.brush instanceof ir?this.path.getBounds(this.brush.scattering):$.ofPolygons(this.path)).ceil()),this.matrix?c.transform(this.matrix):c},enumerable:!0}),u.reset=function(){n=null,c=null},Object.defineProperty(s(u),"descriptor",{value:{brush:{}},enumerable:!0}),Object.defineProperty(s(u),"brush",{get:function(){return t||(t=this.descriptor.brush.value),t},set:function(e){if(this.reset(),"string"==typeof e?e=new le(e):e instanceof pe||e instanceof ir?e=new le(e.name,e):e instanceof le||(e=new le(e.name,e.value)),e instanceof ir&&!r.randomSeed)throw new Error("Spline do not provides randomSeed. Raster rendering requires it.");t=null,this.descriptor.brush=e},enumerable:!0}),u.brush=t,u.renderMode=void 0,u.sensorDataOffset=0,u.sensorDataMapping=[],u}return I(a,[{key:"clone",value:function(){var t=new a(this.descriptor.brush,this.spline.clone(),void 0,this.sensorData);return t.renderMode=this.renderMode,t.sensorDataOffset=this.sensorDataOffset,t.sensorDataMapping=this.sensorDataMapping.clone(),t}},{key:"init",value:(n=ht(ct.mark((function t(e){return ct.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.pathProceessInProgress=!0,rr||(rr=new Je),rr.configure({brush:this.brush,layout:this.layout,pathPointProps:this.pointProps}),e&&rr.configure(e),t.next=6,rr.processSpline(this.spline);case 6:this.path=t.sent,delete this.pathProceessInProgress;case 8:case"end":return t.stop()}}),t,this)}))),function(t){return n.apply(this,arguments)})},{key:"buildPath",value:function(t){if(this.pathProceessInProgress)throw new Error("Init process in progress. Await init stroke.");er||(er=new ze),er.configure({brush:this.brush,layout:this.layout,pathPointProps:this.pointProps}),t&&er.configure(t),this.path=er.processSpline(this.spline)}},{key:"getSegment",value:function(t){var e=t,r=t+3,n=0==e?this.ts:0,i=r+1==this.length?this.tf:1;return this.spline.slice(e,r,n,i)}},{key:"getSensorPoint",value:function(t){if(t>=this.length||t<0)throw new Error("Index ".concat(t," out of range - (0, ").concat(this.length-1,")"));var e;if(this.sensorData){var r,n=this.sensorData.inkStream;if(n)this.sensorDataMapping.length>0?r=t>=this.sensorDataMapping.length?this.sensorDataMapping.last:this.sensorDataMapping[t]:(r=this.sensorDataOffset+t)>=n.length&&(r=n.length-1),(e=n.get(r)).index=r}return e}},{key:"getPoint",value:function(t){return this.spline.getPoint(t)}},{key:"setPoint",value:function(t,e){var r=this,n=t*this.stride;this.layout.forEach((function(t,i){return r.points[n+i]=e.getProperty(t)}))}},{key:"pointAt",value:function(t){return this.getPoint(t)}},{key:"getAverageWidth",value:function(){var t=0;if(this.layout.includes(K.Property.SIZE)){for(var e=0,r=0;r<this.length;r++)e+=this.getPoint(r).size;t=e/this.length}else t=this.pointProps.size;return t}},{key:"split",value:function(t){var e=this,r=t.map((function(t){return e.subStroke(t)}));return r.includes(this)||0==r.length?void 0:r}},{key:"subStroke",value:function(t){var e=t.fromIndex,r=t.toIndex,n=t.fromTValue,i=t.toTValue;if(0==e&&r+1==this.length&&n==this.ts&&i==this.tf)return this;var o=this.spline.slice(e,r,n,i),s=new a(this.descriptor.brush,o,void 0,this.sensorData);return s.renderMode=this.renderMode,this.sensorData&&(s.sensorDataOffset=this.sensorDataOffset+e,this.sensorDataMapping.length>0?s.sensorDataMapping=this.sensorDataMapping.slice(e,r+1):s.sensorDataMapping=[]),s}},{key:"transform",value:function(t){if(t||(t=this.matrix,delete this.matrix),t){for(var e=0;e<this.length;e++){var r=this.getPoint(e);r.transform(t),this.setPoint(e,r)}this.reset()}}},{key:"updateTransform",value:function(t){this.matrix||(this.matrix=new Z),t instanceof Z||(t=Z.create(t)),this.matrix=this.matrix.multiply(t)}},{key:"setTransform",value:function(t){t instanceof Z||(t=Z.create(t)),this.matrix=t}}],[{key:"createInstance",value:function(t,e,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i=arguments.length>4?arguments[4]:void 0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,u=n.color;u&&(delete(n=Object.assign({},n)).color,n.red=u.red,n.green=u.green,n.blue=u.blue,n.alpha=u.alpha);var c=new me(r,e,n,o,s);return c.randomSeed=i,new a(t,c)}},{key:"validatePath",value:function(t){if(!t)return!1;if(0==t.length)return!1;if(Array.isArray(t))return!0;var e=!1,r=0,n=!1,i=t.pointProps,o=i.size,a=i.red,s=i.green,u=i.blue,c=i.alpha;if(!(t instanceof xe)){var l=t.points.length,h=t.layout.length;n=0==l||l<4*h,r=l%h}return 0!=r?console.error("The points array (length: ".concat(t.points.length,") does not refer to provided layout (").concat(t.layout.map((function(t){return t.name})).join(", "),")")):n?console.error("Less than needed minimum of points passed (At least 4 points are needed to define a path)!"):!t.layout.includes(K.Property.SIZE)&&isNaN(o)?console.error("Either the size property must be set or the path layout must include a SIZE property"):!t.layout.includes(K.Property.RED)&&isNaN(a)?console.error("Either the color property must be set or the path layout must include a RED property"):!t.layout.includes(K.Property.GREEN)&&isNaN(s)?console.error("Either the color property must be set or the path layout must include a GREEN property"):!t.layout.includes(K.Property.BLUE)&&isNaN(u)?console.error("Either the color property must be set or the path layout must include a BLUE property"):!t.layout.includes(K.Property.ALPHA)&&isNaN(c)?console.error("Either the color property must be set or the path layout must include a ALPHA property"):e=!0,e}}]),a}(Yt);if(ar.RenderMode=Object.assign.apply(Object,[{}].concat(w(Object.keys(Qe).map((function(t){return Ct({},t,"will://rasterization/3.0/blend-mode/".concat(At.getPropName(t,!0)))}))))),ar.RenderMode.get=function(t){return ar.RenderMode[At.getEnumValueName(t.replace(/-/g,"_"))]},ar.RenderMode.getBlendMode=function(t){return Qe[Object.keys(ar.RenderMode).filter((function(e){return ar.RenderMode[e]==t})).first]},m.type2D==m.Type2D.OFFSCREEN){var sr=canvas,ur=sr.Canvas,cr=sr.ImageData,lr=sr.Image;global.OffscreenCanvas=ur,global.ImageData=cr,global.Image=lr}var hr=function(){function t(r,n){e(this,t);var i={};"undefined"==typeof screen?(i.width=r,i.height=n):(i.width=Math.max(screen.width,screen.height),i.height=i.width),Object.defineProperty(this,"defaultSize",{value:i,enumerable:!0})}var r,n;return I(t,[{key:"getExportCanvas",value:function(t){throw new Error("Abstract method getExportCanvas of Layer inheritor should be implemented")}},{key:"toBlob",value:(n=ht(ct.mark((function t(e){var r,n,i,o=arguments;return ct.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=o.length>1&&void 0!==o[1]?o[1]:"image/png",n=o.length>2&&void 0!==o[2]?o[2]:.92,"undefined"!=typeof Blob){t.next=8;break}if("undefined"!=typeof Buffer){t.next=7;break}throw new Error("Current environment do not have neither Blob nor Buffer support.");case 7:throw new Error("This method is not compliant in underlying environment. Use `toBuffer` instead.");case 8:if(!(i=this.getExportCanvas(e)).toBlob){t.next=13;break}return t.abrupt("return",new Promise((function(t,e){return i.toBlob(t,r,n)})));case 13:return t.abrupt("return",i.convertToBlob({type:r,quality:n}));case 14:case"end":return t.stop()}}),t,this)}))),function(t){return n.apply(this,arguments)})},{key:"toBuffer",value:(r=ht(ct.mark((function t(e){var r,n,i,o,a,s=arguments;return ct.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=s.length>1&&void 0!==s[1]?s[1]:"image/png",n=s.length>2&&void 0!==s[2]?s[2]:{},"undefined"!=typeof Buffer){t.next=8;break}if("undefined"!=typeof Blob){t.next=7;break}throw new Error("Current environment do not have neither Blob nor Buffer support.");case 7:throw new Error("This method is not compliant in underlying environment. Use `toBlob` instead.");case 8:return i=this.getExportCanvas(e),n.filters&&(o=Array.isArray(n.filters)?n.filters.slice():[n.filters],a=0,o.forEach((function(t){a|=i["PNG_FILTER_".concat(t.name)]})),Object.assign({},n,{filters:a})),t.abrupt("return",new Promise((function(t,e){return i.toBuffer((function(r,n){return r?e(r):t(n)}),r,n)})));case 11:case"end":return t.stop()}}),t,this)}))),function(t){return r.apply(this,arguments)})}]),t}();function fr(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}hr.createEnum("PNGFilterType",["NO","ALL","NONE","SUB","UP","AVG","PAETH"]);var dr=function(t){o(i,t);var r,n=(r=i,function(){var t,e=c(r);if(fr()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function i(t){var r;return e(this,i),r=n.call(this,t.canvas.width,t.canvas.height),Object.defineProperty(s(r),"surface",{value:t.canvas}),Object.defineProperty(s(r),"ctx",{value:t}),Object.defineProperty(s(r),"bounds",{get:function(){return $.create(0,0,r.width,r.height)},enumerable:!0}),r}return I(i,[{key:"width",get:function(){return this.surface.width}},{key:"height",get:function(){return this.surface.height}}]),I(i,[{key:"clear",value:function(t,e){if(e){if(H.is(t))throw new Error("`clear` first argument should be Rectangle")}else H.is(t)&&(e=t,t=null);t||(t=this.bounds),this.ctx.clearRect(t.left,t.top,t.width,t.height),e&&(this.ctx.fillStyle="rgba(".concat(e.red,", ").concat(e.green,", ").concat(e.blue,", ").concat(e.alpha,")"),this.ctx.fillRect(t.left,t.top,t.width,t.height))}},{key:"draw",value:function(t){return this.drawStroke(t.brush,t.path,t.color,t.matrix)}},{key:"drawStroke",value:function(t,e,r,n){if(e instanceof xe)return this.drawSpline(e,r);if(!ar.validatePath(e))return null;!n||n instanceof Z||(n=Z.create(n));var i=$.ofPolygons(e);return(i=this.bounds.intersect(i))&&(i=i.ceil(),this.ctx.save(),n?(i=i.transform(n),this.ctx.setTransform(n.a,n.b,n.c,n.d,n.tx,n.ty)):(this.ctx.rect(i.left,i.top,i.width,i.height),this.ctx.clip()),e.holesClockwise=!0,this.drawPath(e,"rgb(".concat(r.red,", ").concat(r.green,", ").concat(r.blue,")")),t.pattern&&this.drawPath(e,t.pattern),this.ctx.restore()),i}},{key:"drawPath",value:function(t,e){var r=this;this.ctx.beginPath(),t.forEach((function(e,n){if(r.ctx.moveTo(e[0],e[1]),t.holesClockwise||0==n)for(var i=2;i<e.length;i+=2)r.ctx.lineTo(e[i],e[i+1]);else for(var o=e.length-2;o>=0;o-=2)r.ctx.lineTo(e[o],e[o+1]);r.ctx.closePath()})),e&&(this.ctx.fillStyle=e),this.ctx.fill()}},{key:"drawSpline",value:function(t,e){var r;e||(e=t.color),this.ctx.save(),this.ctx.fillStyle="rgb(".concat(e.red,", ").concat(e.green,", ").concat(e.blue,")");for(var n=0;n<t.length;n++){var i=t.getPoint(n),o=i.size/2;this.ctx.beginPath(),this.ctx.arc(i.x,i.y,o,0,2*Math.PI),this.ctx.closePath(),this.ctx.fill(),r=$.create(i.x-o,i.y-o,i.size,i.size).union(r)}return this.ctx.restore(),r.ceil()}},{key:"fill",value:function(t,e){var r;return $.isRect(t)?r=t:("number"==typeof t[0]&&(t=[t]),r=$.ofPolygons(t)),(r=this.bounds.intersect(r))&&(r=r.ceil(),this.ctx.fillStyle="rgba(".concat(e.red,", ").concat(e.green,", ").concat(e.blue,", ").concat(e.alpha,")"),$.isRect(t)?this.ctx.fillRect(t.left,t.top,t.width,t.height):(this.ctx.save(),this.ctx.rect(r.left,r.top,r.width,r.height),this.ctx.clip(),this.drawPath(t),this.ctx.restore())),r}},{key:"blend",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e.mode||(e.mode=Qe.SOURCE_OVER),e.transform&&e.destinationRect)throw new Error("`destinationRect` is not applicable with `transform`");if(e.sourceRect&&!e.destinationRect)throw new Error("With `sourceRect`, `destinationRect` is required");if(e.destinationRect&&!e.sourceRect)throw new Error("With `destinationRect`, `sourceRect`is required");if(e.rect&&(e.sourceRect=e.rect,e.destinationRect=e.rect),this.ctx.save(),e.transform){var r=e.transform instanceof Z?e.transform:Z.create(e.transform);this.ctx.setTransform(r.a,r.b,r.c,r.d,r.tx,r.ty)}else e.clipRect&&(this.ctx.rect(e.clipRect.left,e.clipRect.top,e.clipRect.width,e.clipRect.height),this.ctx.clip());this.ctx.globalCompositeOperation=e.mode,e.sourceRect&&e.destinationRect?this.ctx.drawImage(t.ctx.canvas,e.sourceRect.left,e.sourceRect.top,e.sourceRect.width,e.sourceRect.height,e.destinationRect.left,e.destinationRect.top,e.destinationRect.width,e.destinationRect.height):this.ctx.drawImage(t.ctx.canvas,0,0),this.ctx.restore()}},{key:"createImageData",value:function(t,e,r){return new ImageData(t,e,r)}},{key:"getImageData",value:function(t){return t||(t=this.bounds),this.ctx.getImageData(t.x,t.y,t.width,t.height)}},{key:"putImageData",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(!(t instanceof ImageData))throw new Error("putImageData 'imageData' parameter is not instance of ImageData");this.ctx.putImageData(t,e,r)}},{key:"readPixels",value:function(t){return this.getImageData(t).data}},{key:"writePixels",value:function(t,e){if(!(t instanceof Uint8Array||t instanceof Uint8ClampedArray))throw new Error("writePixels 'data' parameter is not instance of Uint8Array or Uint8ClampedArray");e||(e=this.bounds),this.putImageData(this.createImageData(t,e.width,e.height),e.x,e.y)}},{key:"getExportCanvas",value:function(t){var e=this.surface;return t&&(t=t.intersect(this.bounds).ceil(),(e=new OffscreenCanvas(t.width,t.height)).getContext("2d").putImageData(this.getImageData(t),0,0)),e}},{key:"resize",value:function(t,e){this.surface.width=t,this.surface.height=e}}]),i}(hr);function pr(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var yr=function(t){o(i,t);var r,n=(r=i,function(){var t,e=c(r);if(pr()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function i(t){return e(this,i),n.call(this,t)}return I(i,[{key:"createLayer",value:function(t,e){if(!t||!e){var r=this.defaultSize;t=r.width,e=r.height}var n=new OffscreenCanvas(t,e);return new dr(n.getContext("2d"))}}],[{key:"createInstance",value:function(t,e,r){if(!t||"function"!=typeof t.getContext)throw new Error("CanvasRenderingContext2D context provider is required");if(e>0&&r>0&&(t.width=e,t.height=r),!(t.width>0&&t.width>0))throw new Error("width and height are required and should be positive whole numbers");return new i(t.getContext("2d"))}}]),i}(dr),vr=function(){function t(r,n){var i=this;e(this,t),this.canvas=r,this.layer=n||r.createLayer(),this.ownLayer=!n,this.restart=!0,this.brush=void 0,this.color=void 0,this.backgroundColor=H.TRANSPERENT,this.blendMode=Qe.SOURCE_OVER,this.preliminaryLayer=void 0,this.strokeBounds=void 0,this.updatedArea=void 0,Object.defineProperty(this,"settings",{get:function(){return{brush:i.brush,color:i.color,backgroundColor:i.backgroundColor,blendMode:i.blendMode}},enumerable:!0})}return I(t,[{key:"configure",value:function(t){t.brush&&(this.brush=t.brush),t.color&&(this.color=t.color),t.backgroundColor&&(this.backgroundColor=t.backgroundColor),t.blendMode&&(this.blendMode=t.blendMode),this.restart=!0}},{key:"draw",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(t instanceof ar){var r=t,n=Qe.SOURCE_OVER;if(r.renderMode&&!(n=ar.RenderMode.getBlendMode(r.renderMode)))return void console.warn("Cannot process ".concat(r.renderMode," render mode. Requres custom processing."));this.color=r.color,this.blendMode=n,this.reset();var i=this.layer.draw(r);this.strokeBounds=i,this.updatedArea=i,this.restart=!0}else{if(!this.color)throw new Error("StrokeRenderer requires 'color' to be configured");if(this.restart&&this.reset(),this.validate(t)){var o=this.layer.drawStroke(this.brush,t,this.color);o&&(this.incompleteStrokeBounds=o.union(this.incompleteStrokeBounds),this.strokeBounds=o.union(this.strokeBounds),this.updatedArea=this.incompleteStrokeBounds.union(this.preliminaryDirtyArea))}else this.updatedArea=this.preliminaryDirtyArea;this.blendWithPreliminaryLayer=!1,this.preliminaryDirtyArea=null,e&&(this.strokeBounds=this.strokeBounds.ceil(),this.restart=!0)}}},{key:"drawPreliminary",value:function(t){if(this.validate(t)){var e=null;this.ownLayer?(this.preliminaryLayer||(this.preliminaryLayer=this.canvas.createLayer(),this.preliminaryLayer.clear()),e=this.preliminaryLayer):e=this.preliminaryLayer||this.canvas,this.updatedArea&&this.preliminaryLayer&&(this.preliminaryLayer.clear(this.updatedArea),this.preliminaryLayer.blend(this.layer,{mode:Qe.SOURCE_OVER,rect:this.updatedArea})),this.preliminaryDirtyArea=e.drawStroke(this.brush,t,this.color),this.updatedArea=$.union(this.preliminaryDirtyArea,this.updatedArea),this.preliminaryLayer&&(this.blendWithPreliminaryLayer=!0)}}},{key:"abort",value:function(){this.restart=!0}},{key:"reset",value:function(){this.incompleteStrokeBounds=null,this.strokeBounds=null,this.updatedArea=null,this.preliminaryDirtyArea=null,this.ownLayer&&(this.layer.clear(this.backgroundColor),this.preliminaryLayer&&this.preliminaryLayer.clear(this.backgroundColor)),this.color.alpha<1&&(this.alphaLayer||(this.alphaLayer=this.canvas.createLayer())),this.restart=!1}},{key:"validate",value:function(t){return t&&t.length>0}},{key:"blendUpdatedArea",value:function(t){if(this.updatedArea){var e=t||this.canvas,r=this.blendWithPreliminaryLayer?this.preliminaryLayer:this.layer,n=e.bounds.intersect(this.updatedArea);if(n){var i=this.color.alpha;i<1?(this.alphaLayer.clear(),this.alphaLayer.ctx.globalAlpha=1,this.alphaLayer.blend(e,{rect:n}),this.alphaLayer.ctx.globalAlpha=i,this.alphaLayer.blend(r,{mode:this.blendMode,rect:n}),e.clear(n),e.blend(this.alphaLayer,{rect:n})):e.blend(r,{mode:this.blendMode,rect:n.ceil()})}this.incompleteStrokeBounds=null,this.updatedArea=null}}},{key:"blendStroke",value:function(t,e,r){if(this.strokeBounds){r||(r=this.blendMode);var n=this.layer,i=t||this.canvas;if(e=i.bounds.intersect(e||this.strokeBounds)){var o=this.color.alpha;o<1?(this.alphaLayer.clear(),this.alphaLayer.ctx.globalAlpha=o,this.alphaLayer.blend(n,{rect:e}),i.blend(this.alphaLayer,{mode:r,rect:e})):i.blend(n,{mode:r,rect:e.ceil()})}}}},{key:"toStroke",value:function(t,e){if(!this.brush)throw new Error("StrokeRenderer brush is not configured");var r=t.getSensorData(),n=t.getSpline(),i=t.getInkPath(e),o=new ar(this.brush,n,i,r);return r&&(o.sensorDataMapping=r.inkStream.getPipelineMapping()),this.blendMode!=Qe.SOURCE_OVER&&(o.renderMode=ar.RenderMode.get(this.blendMode)),o}},{key:"delete",value:function(){console.warn("Not applicable with 2D API")}}]),t}(),gr=void 0;m.typeGL==m.TypeGL.STACK&&(gr=gl);var mr=gr,br=function(){function t(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:300,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:150;e(this,t),this.width=r,this.height=n}return I(t,[{key:"getContext",value:function(){var t=arguments.length>1?arguments[1]:void 0;if(!this.context){var e=this.width,r=this.height;this.context=mr(e,r,t),this.context.canvas=this;var n=this.context.getExtension("STACKGL_resize_drawingbuffer");Object.defineProperty(this,"width",{get:function(){return e},set:function(t){e=t,n.resize(e,r)},enumerable:!0}),Object.defineProperty(this,"height",{get:function(){return e},set:function(t){r=t,n.resize(e,r)},enumerable:!0})}return this.context}},{key:"destroy",value:function(){this.context&&(this.context.getExtension("STACKGL_destroy_context").destroy(),delete this.context)}}]),t}(),xr=mr?br:void 0;function Er(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var Pr=function(t){o(i,t);var r,n=(r=i,function(){var t,e=c(r);if(Er()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function i(t){var r,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e(this,i),(r=n.call(this,t.gl.canvas.width,t.gl.canvas.height)).inkGLContext=t,r.gl=t.gl,r.scaleFactor=o.scaleFactor||1,r.flipY=!!o.flipY,r.useTextureStorage=!1,o.renderbuffer){if(!o.framebuffer)throw new Error("`framebuffer` is required when `renderbuffer` available");var a=r.initWithGLBuffers(o.framebuffer,o.renderbuffer);r.flipY=!0,r.ownGLResources=!!o.ownGLResources,r.setDimensions(a.width,a.height)}else if(o.framebuffer){var s=r.initWithGLFramebuffer(o.framebuffer);r.flipY=!0,r.ownGLResources=!!o.ownGLResources,r.setDimensions(s.width,s.height)}else if(o.texture){if(!(o.texture instanceof WebGLTexture))throw new Error("`texture` is not instance of WebGLTexture");var u;if(r.texture=o.texture,r.useTextureStorage=!0,o.width>0&&o.height>0)u={width:o.width,height:o.height};else{if(!r.texture.image)throw new Error("`width` and `height` are required when `texture` is available");u={width:r.texture.image.width,height:r.texture.image.height}}r.ownGLResources=!!o.ownGLResources,r.setDimensions(u.width,u.height)}else{var c=Math.min(o.width||r.defaultSize.width,4e3),l=Math.min(o.height||r.defaultSize.height,4e3);if(r.setDimensions(c,l),o.display)r.framebuffer=null,r.renderbuffer=null,r.texture=null;else if(r.useTextureStorage=!o.useBuffersStorage,r.ownGLResources=!0,r.useTextureStorage){var h=r.inkGLContext.generateBuffersExt(r.storageWidth,r.storageHeight,r.gl.LINEAR,r.gl.UNSIGNED_BYTE);r.framebuffer=h.framebuffer,r.texture=h.texture}else{var f=r.inkGLContext.genFrameAndRenders(r.gl.RGBA8||r.gl.RGBA4,r.storageWidth,r.storageHeight);r.framebuffer=f.framebuffer,r.renderbuffer=f.renderbuffer}}return r.releaseRenderbuffer=!1,r.deleted=!1,r}return I(i,[{key:"initWithGLFramebuffer",value:function(t){if(!(t instanceof WebGLFramebuffer))throw new Error("`framebuffer` is not instance of WebGLFramebuffer");var e,r=this.gl.getParameter(this.gl.RENDERBUFFER_BINDING);if(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,t),this.gl.getError()==this.gl.INVALID_OPERATION)throw new Error("Invalid framebuffer");if(this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER)!=this.gl.FRAMEBUFFER_COMPLETE)throw new Error("Incomplete framebuffer");if(this.gl.getFramebufferAttachmentParameter(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE)!=this.gl.RENDERBUFFER)throw new Error("Renderbuffer attachment not found");return e=this.gl.getFramebufferAttachmentParameter(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,r),this.initWithGLBuffers(t,e)}},{key:"initWithGLBuffers",value:function(t,e){if(!(t instanceof WebGLFramebuffer))throw new Error("`framebuffer` is not instance of WebGLFramebuffer");if(!(e instanceof WebGLRenderbuffer))throw new Error("`renderbuffer` is not instance of WebGLRenderbuffer");var r=this.gl.getParameter(this.gl.RENDERBUFFER_BINDING);this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,e);var n=this.gl.getRenderbufferParameter(this.gl.RENDERBUFFER,this.gl.RENDERBUFFER_WIDTH),i=this.gl.getRenderbufferParameter(this.gl.RENDERBUFFER,this.gl.RENDERBUFFER_HEIGHT);return this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,r),this.framebuffer=t,this.renderbuffer=e,{width:n,height:i}}},{key:"setDimensions",value:function(t,e){var r=Math.ceil(t*this.scaleFactor),n=Math.ceil(e*this.scaleFactor),i=Q.makeWithSize(0,0,t,e),o=Q.makeWithSize(0,0,r,n);Object.defineProperties(this,{width:{value:t,enumerable:!0,configurable:!0},height:{value:e,enumerable:!0,configurable:!0},graphicsBounds:{value:i,enumerable:!0,configurable:!0},storageWidth:{value:r,enumerable:!0,configurable:!0},storageHeight:{value:n,enumerable:!0,configurable:!0},storageBounds:{value:o,enumerable:!0,configurable:!0}})}},{key:"resize",value:function(t,e){t>0&&e>0&&(this.width!=t||this.height!=e)&&(this.setDimensions(t,e),this.useTextureStorage?(this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.storageWidth,this.storageHeight,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null)):this.renderbuffer&&(this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.renderbuffer),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.RGBA8||this.gl.RGBA4,this.storageWidth,this.storageHeight)))}},{key:"delete",value:function(){this.ownGLResources&&(this.useTextureStorage?this.inkGLContext.deleteBuffers(this.framebuffer,this.texture):this.inkGLContext.deleteFrameAndRender(this.framebuffer,this.renderbuffer)),this.releaseRenderbuffer&&this.renderbuffer&&(this.gl.deleteRenderbuffer(this.renderbuffer),this.renderbuffer=null,this.releaseRenderbuffer=!1),this.deleted=!0}},{key:"deleteLater",value:function(){var t=this;setTimeout((function(){return t.delete()}),0)}},{key:"isDeleted",value:function(){return this.deleted}}]),i}(hr),kr=function(){function t(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Date.now();e(this,t),this.randomSeed=r}return I(t,[{key:"copyTo",value:function(t){t.randomSeed=this.randomSeed}}]),t}();function wr(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var Rr=function(t){o(i,t);var r,n=(r=i,function(){var t,e=c(r);if(wr()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function i(t,r){var o;return e(this,i),(o=n.call(this,t.inkGLContext,r)).convexHullChainProducer=new Be,o.polygonSimplifier=new Ge,Object.defineProperty(s(o),"inkContext",{value:t,enumerable:!0}),Object.defineProperty(s(o),"bounds",{get:function(){return $.fromGLRect(o.graphicsBounds)},enumerable:!0}),o}return I(i,[{key:"clear",value:function(t,e){if(e){if(H.is(t))throw new Error("`clear` first argument should be Rect")}else H.is(t)?(e=t,t=null):e=H.TRANSPERENT;var r;if($.isRect(t)){if(!t.intersect(this.bounds))return;r=$.fromRect(t).toGLRect()}Array.isArray(t)||t instanceof Float32Array?this.fill(t,e,!1):(this.inkContext.setTarget(this,r),this.inkContext.clearColor(e)),r&&this.inkContext.disableTargetClipRect()}},{key:"draw",value:function(t){var e,r=t.brush;return r instanceof ir?isFinite(t.randomSeed)&&(e=new kr(t.randomSeed)):e=t.color,this.drawStroke(r,t.path,e)}},{key:"drawStroke",value:function(t,e,r){if(!ar.validatePath(e))return null;this.inkContext.setTarget(this);var n=this.inkContext.drawStroke(t,e,r);return t instanceof ir?$.fromGLRect(n):$.ofPolygons(e).ceil()}},{key:"fill",value:function(t,e){var r,n,i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if($.isRect(t)?(r=[t.toPath().points],n=t):("number"==typeof t[0]&&(t=[t]),r=t,n=$.ofPolygons(r)),n=this.bounds.intersect(n)){var o=r;Array.isArray(t)&&(o=this.convexHullChainProducer.get(o)),o=this.polygonSimplifier.get(o);var a=this.inkContext.triangulate(o);a.length>0?(this.inkContext.setTarget(this),this.inkContext.fill(a,e,i)):n=void 0}return n?n.ceil():void 0}},{key:"blend",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e.mode||(e.mode=Qe.SOURCE_OVER),e.rect&&!e.transform&&(e.sourceRect=e.rect,e.destinationRect=e.rect),e.transform&&e.destinationRect)throw new Error("`destinationRect` is not applicable with `transform`");if(e.sourceRect&&!e.destinationRect)throw new Error("With `sourceRect`, `destinationRect` is required");if(e.destinationRect&&!e.sourceRect)throw new Error("With `destinationRect`, `sourceRect`is required");if(this.inkContext.setTarget(this,$.isRect(e.clipRect)?$.fromRect(e.clipRect).toGLRect():void 0),"boolean"==typeof e.flipY&&(t.flipY=e.flipY),e.transform&&e.rect){var r=$.fromRect(e.rect).toGLRect().toQuad(),n=$.fromRect(e.rect).toGLRect().toQuad(e.transform);this.inkContext.drawLayer(t,r,n,e.mode)}else e.transform?this.inkContext.drawLayerWithTransform(t,e.transform,e.mode):e.sourceRect&&e.destinationRect?this.inkContext.drawLayer(t,$.fromRect(e.sourceRect).toGLRect().toQuad(),$.fromRect(e.destinationRect).toGLRect().toQuad(),e.mode):this.inkContext.drawLayerWithTransform(t,null,e.mode)}},{key:"createImageData",value:function(t,e,r){return t instanceof Uint8Array&&(t=new Uint8ClampedArray(t.buffer)),new ImageData(t,e,r)}},{key:"getImageData",value:function(t){return t||(t=this.bounds),this.createImageData(this.readPixels(t,!0),t.width,t.height)}},{key:"putImageData",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(!(t instanceof ImageData))throw new Error("putImageData 'imageData' parameter is not instance of ImageData");this.writePixels(t.data,$.create(e,r,t.width,t.height))}},{key:"readPixels",value:function(t,e){t&&(t=$.fromRect(t).toGLRect()),this.inkContext.setTarget(this);var r=this.inkContext.readPixels(t);if(e)for(var n=0;n<r.length;n+=4){var i=r[n+3];r[n]=parseInt(255*r[n]/i),r[n+1]=parseInt(255*r[n+1]/i),r[n+2]=parseInt(255*r[n+2]/i)}return r}},{key:"writePixels",value:function(t,e){if(!(t instanceof Uint8Array||t instanceof Uint8ClampedArray))throw new Error("writePixels 'data' parameter is not instance of Uint8Array or Uint8ClampedArray");e&&(e=$.fromRect(e).toGLRect()),this.inkContext.setTarget(this),this.inkContext.writePixels(e,t)}},{key:"getExportCanvas",value:function(t){t=t?t.intersect(this.bounds).ceil():this.bounds;var e=new OffscreenCanvas(t.width,t.height);return e.getContext("2d").putImageData(this.getImageData(t),0,0),e}}]),i}(Pr),Sr=(m.commonJS,poly2tri),Ir=Sr.SweepContext,Tr=Sr.Point,Ar=function(){function t(r){if(e(this,t),!r)throw new Error("GL context is not available in current environment");this.gl=r,this.currentProgram=null,this.programs=[],Object.defineProperty(t,"VERTEX_SHADER_PRECISION",{value:this.getSupportedFloatPrecision(this.gl.VERTEX_SHADER),enumerable:!0,configurable:!0}),Object.defineProperty(t,"FRAGMENT_SHADER_PRECISION",{value:this.getSupportedFloatPrecision(this.gl.FRAGMENT_SHADER),enumerable:!0,configurable:!0})}return I(t,[{key:"init",value:function(t,e){this.gl.disable(this.gl.DITHER),this.gl.disable(this.gl.BLEND),this.gl.disable(this.gl.STENCIL_TEST),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.SCISSOR_TEST),this.gl.activeTexture(this.gl.TEXTURE0),this.bUseStencilBufferForBlending=!1,this.currentBlendMode=Qe.COPY,this.resize(t,e),this.scatterMethodRandomSeed=parseInt(Date.now()/1e3),this.blendMinMaxExt=this.gl.getExtension("EXT_blend_minmax"),this.genStaticVBOs(),this.onChange();for(var r=0;r<this.programs.length;r++)this.programs[r].init()}},{key:"getSupportedFloatPrecision",value:function(t){return this.gl.getShaderPrecisionFormat(t,this.gl.HIGH_FLOAT).precision>0?"highp":this.gl.getShaderPrecisionFormat(t,this.gl.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}},{key:"random",value:function(){return this.scatterMethodRandomSeed=1103515245*this.scatterMethodRandomSeed+12345&2147483647,this.scatterMethodRandomSeed/2147483647}},{key:"setUniforms",value:function(t){var e=C();this._scaleVectorAbs=new Float32Array([this.bounds.width/this.graphicsBox.width,this.bounds.height/this.graphicsBox.height]),t?M(e,this.graphicsBox.left,this.graphicsBox.right,this.graphicsBox.top,this.graphicsBox.bottom,1,-1):M(e,this.graphicsBox.left,this.graphicsBox.right,this.graphicsBox.bottom,this.graphicsBox.top,1,-1),this._graphicsSpaceToFramebufferSpaceT=e,this.onChange()}},{key:"resize",value:function(t,e){this.textureWidth=parseInt(Math.ceil(t.width)),this.textureHeight=parseInt(Math.ceil(t.height)),this.gl.viewport(t.x,t.y,t.width,t.height),this.bounds=t,this.graphicsBox=e,this._clipRect=this.graphicsBox}},{key:"genStaticVBOs",value:function(){this.fullScreenQuad2dBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.fullScreenQuad2dBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),this.gl.STATIC_DRAW);for(var t=[],e=0;e<=1024;e++)t.push(e,1,1),t.push(e,-1,1);for(var r=0;r<=1024;r++)t.push(r,1,1),t.push(r,1,0);for(var n=0;n<=1024;n++)t.push(n,-1,1),t.push(n,-1,0);this.strokeSegmentBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.strokeSegmentBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(t),this.gl.STATIC_DRAW),t=[-1,1];for(var i=0;i<=1024;i++)t.push(i,1);for(var o=0;o<=1024;o++)t.push(o,1),t.push(o,0);this.circleBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.circleBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(t),this.gl.STATIC_DRAW),this.destBuffer=this.gl.createBuffer(),this.srcBuffer=this.gl.createBuffer(),this.vertsBuffer=this.gl.createBuffer(),this.colorsBuffer=this.gl.createBuffer()}},{key:"blendMode",value:function(t){if(t!=this.currentBlendMode){switch(t){case Qe.COPY:this.gl.disable(this.gl.BLEND);break;case Qe.SOURCE_OVER:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA);break;case Qe.DESTINATION_OVER:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE_MINUS_DST_ALPHA,this.gl.ONE);break;case Qe.DESTINATION_IN:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ZERO,this.gl.SRC_ALPHA);break;case Qe.DESTINATION_OUT:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ZERO,this.gl.ONE_MINUS_SRC_ALPHA);break;case Qe.DESTINATION_IN_NO_ALPHA:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ZERO,this.gl.SRC_COLOR);break;case Qe.DESTINATION_OUT_NO_ALPHA:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ZERO,this.gl.ONE_MINUS_SRC_COLOR);break;case Qe.LIGHTER:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE,this.gl.ONE);break;case Qe.MIN:this.gl.enable(this.gl.BLEND),this.blendMinMaxExt?this.gl.blendEquation(this.blendMinMaxExt.MIN_EXT):(this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA));break;case Qe.MAX:this.gl.enable(this.gl.BLEND),this.gl.MAX?this.gl.blendEquation(this.gl.MAX):this.blendMinMaxExt?this.gl.blendEquation(this.blendMinMaxExt.MAX_EXT):(this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA));break;case Qe.SUBTRACT:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_SUBTRACT),this.gl.blendFunc(this.gl.ONE,this.gl.ONE);break;case Qe.SUBTRACT_REVERSE:this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_REVERSE_SUBTRACT),this.gl.blendFunc(this.gl.ONE,this.gl.ONE);break;default:throw new Error("Unsupported blend mode: ".concat(t))}this.currentBlendMode=t}}},{key:"clearColorbuffer",value:function(t){this.gl.clearColor(t.red*t.alpha/255,t.green*t.alpha/255,t.blue*t.alpha/255,t.alpha),this.gl.clear(this.gl.COLOR_BUFFER_BIT)}},{key:"scissors",value:function(t){if(t&&!(t instanceof Q))throw new TypeError("rect must be undefined or instanceof GLRect");var e=this.gl.isEnabled(this.gl.SCISSOR_TEST);t?(e||this.gl.enable(this.gl.SCISSOR_TEST),this.gl.scissor(t.x,t.y,t.width,t.height)):e&&this.gl.disable(this.gl.SCISSOR_TEST)}},{key:"isProgramActive",value:function(t){return this.currentProgram==t}},{key:"activateProgram",value:function(t){this.isProgramActive(t)?t.contextChanged&&(t.onContextChange(),t.contextChanged=!1):(this.currentProgram&&this.currentProgram.onDeactivate(),this.gl.useProgram(t.program),this.currentProgram=t,t.onActivate(),t.onContextChange(),t.contextChanged=!1)}},{key:"generateBuffersExt",value:function(t,e,r,n){var i=this.gl,o=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,o);var a=i.createTexture();return i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,a),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,r),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,r),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,t,e,0,i.RGBA,n,null),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,a,0),i.clearColor(0,0,0,0),i.clear(i.COLOR_BUFFER_BIT),{framebuffer:o,texture:a}}},{key:"genFrameAndRenders",value:function(t,e,r){var n=this.gl.createFramebuffer(),i=this.gl.createRenderbuffer();return this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,n),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,i),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,t,e,r),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.RENDERBUFFER,i),{framebuffer:n,renderbuffer:i}}},{key:"deleteBuffers",value:function(t,e){e&&this.gl.deleteTexture(e),t&&this.gl.deleteFramebuffer(t)}},{key:"deleteFrameAndRender",value:function(t,e){e&&this.gl.deleteRenderbuffer(e),t&&this.gl.deleteFramebuffer(t)}},{key:"onChange",value:function(){for(var t=0;t<this.programs.length;t++)this.programs[t].contextChanged=!0}},{key:"isStencilBufferAvailable",value:function(){return this.gl.getFramebufferAttachmentParameter(this.gl.FRAMEBUFFER,this.gl.STENCIL_ATTACHMENT,this.gl.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE)==this.gl.RENDERBUFFER}},{key:"enableStencilBufferForBlending",value:function(){this.bUseStencilBufferForBlending=!0,this.gl.enable(this.gl.STENCIL_TEST),this.gl.stencilMask(4294967295),this.gl.clearStencil(0),this.gl.clear(this.gl.STENCIL_BUFFER_BIT)}},{key:"disableStencilBufferForBlending",value:function(){this.bUseStencilBufferForBlending=!1}},{key:"shouldUseStencilBufferForBlending",value:function(){return this.bUseStencilBufferForBlending}},{key:"drawArrays",value:function(t,e,r){this.currentBlendMode!=Qe.MAX||this.blendMinMaxExt?this.gl.drawArrays(t,e,r):(this.shouldUseStencilBufferForBlending()&&(this.gl.enable(this.gl.STENCIL_TEST),this.gl.stencilFunc(this.gl.NOTEQUAL,1,1),this.gl.stencilOp(this.gl.REPLACE,this.gl.REPLACE,this.gl.REPLACE)),this.gl.blendFunc(this.gl.ONE,this.gl.ONE),this.gl.blendEquation(this.gl.FUNC_REVERSE_SUBTRACT),this.gl.drawArrays(t,e,r),this.shouldUseStencilBufferForBlending()&&(this.gl.stencilFunc(this.gl.NOTEQUAL,2,1),this.gl.stencilOp(this.gl.REPLACE,this.gl.REPLACE,this.gl.REPLACE)),this.gl.blendFunc(this.gl.ONE,this.gl.ONE),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.drawArrays(t,e,r),this.shouldUseStencilBufferForBlending()&&this.gl.disable(this.gl.STENCIL_TEST))}}],[{key:"random",value:function(t){return(1103515245*t+12345&2147483647)/2147483647}}]),t}(),Cr=function(){function t(r){e(this,t),Object.defineProperties(this,{inkGLContext:{value:r},gl:{value:r.gl}}),this.program=this.createProgram(this.compileShader(this.constructor.getVertexShader(),this.gl.VERTEX_SHADER),this.compileShader(this.constructor.getFragmentShader(this.gl.getContextAttributes().premultipliedAlpha),this.gl.FRAGMENT_SHADER)),this.contextChanged=!0}return I(t,[{key:"init",value:function(){}},{key:"compileShader",value:function(t,e){var r=this.inkGLContext.gl,n=r.createShader(e);if(r.shaderSource(n,t),r.compileShader(n),!r.getShaderParameter(n,r.COMPILE_STATUS))throw new Error("could not compile shader:"+r.getShaderInfoLog(n));return n}},{key:"createProgram",value:function(t,e){var r=this.inkGLContext.gl,n=r.createProgram();if(r.attachShader(n,t),r.attachShader(n,e),r.linkProgram(n),!r.getProgramParameter(n,r.LINK_STATUS))throw new Error("program filed to link:"+r.getProgramInfoLog(n));return n}},{key:"onActivate",value:function(){}},{key:"onDeactivate",value:function(){}},{key:"onContextChange",value:function(){}},{key:"activate",value:function(){this.inkGLContext.activateProgram(this)}}]),t}();function Dr(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var Or=function(t){o(i,t);var r,n=(r=i,function(){var t,e=c(r);if(Dr()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function i(){return e(this,i),n.apply(this,arguments)}return I(i,[{key:"init",value:function(){this.a_position=this.gl.getAttribLocation(this.program,"a_position"),this.a_color=this.gl.getAttribLocation(this.program,"a_color"),this.u_projectionMatrix=this.gl.getUniformLocation(this.program,"u_projectionMatrix")}},{key:"onContextChange",value:function(){this.gl.uniformMatrix4fv(this.u_projectionMatrix,!1,this.inkGLContext._graphicsSpaceToFramebufferSpaceT)}},{key:"onDeactivate",value:function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)}},{key:"drawVertices",value:function(t,e,r){this.activate(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.inkGLContext.vertsBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_position),this.gl.vertexAttribPointer(this.a_position,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.inkGLContext.colorsBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,e,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_color),this.gl.vertexAttribPointer(this.a_color,4,this.gl.FLOAT,!1,0,0),t.length&&this.inkGLContext.drawArrays(this.gl.TRIANGLES,0,t.length/2)}}],[{key:"getVertexShader",value:function(){return"\n\t\t\tprecision ".concat(Ar.VERTEX_SHADER_PRECISION," float;\n\n\t\t\tuniform mat4 u_projectionMatrix;\n\n\t\t\tattribute highp vec4 a_position;\n\t\t\tattribute lowp vec4 a_color;\n\n\t\t\tvarying lowp vec4 v_color;\n\n\t\t\tvoid main() {\n\t\t\t\tgl_Position = u_projectionMatrix * a_position;\n\t\t\t\tv_color = a_color;\n\t\t\t}\n\t\t")}},{key:"getFragmentShader",value:function(){return"\n\t\t\tvarying lowp vec4 v_color;\n\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = v_color;\n\t\t\t}\n\t\t"}}]),i}(Cr);function Mr(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var Nr=function(t){o(i,t);var r,n=(r=i,function(){var t,e=c(r);if(Mr()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function i(){return e(this,i),n.apply(this,arguments)}return I(i,[{key:"init",value:function(){this.a_position=this.gl.getAttribLocation(this.program,"a_position"),this.a_srcPosition=this.gl.getAttribLocation(this.program,"a_srcPosition"),this.u_texture=this.gl.getUniformLocation(this.program,"u_texture"),this.u_projectionMatrix=this.gl.getUniformLocation(this.program,"u_projectionMatrix"),this.u_textureMatrix=this.gl.getUniformLocation(this.program,"u_textureMatrix")}},{key:"onDeactivate",value:function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)}},{key:"drawTexture",value:function(t,e,r,n,i){this.activate(),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.STENCIL_TEST),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,t),this.gl.uniform1i(this.u_texture,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.inkGLContext.destBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,e,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_position),this.gl.vertexAttribPointer(this.a_position,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.inkGLContext.srcBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,r,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(this.a_srcPosition),this.gl.vertexAttribPointer(this.a_srcPosition,2,this.gl.FLOAT,!1,0,0),this.gl.uniformMatrix4fv(this.u_projectionMatrix,!1,n),this.gl.uniformMatrix4fv(this.u_textureMatrix,!1,i),this.inkGLContext.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}}],[{key:"getVertexShader",value:function(){return"\n\t\t\tprecision ".concat(Ar.VERTEX_SHADER_PRECISION," float;\n\n\t\t\tuniform mat4 u_projectionMatrix;\n\t\t\tuniform mat4 u_textureMatrix;\n\t\t\tattribute highp vec4 a_position;\n\t\t\tattribute highp vec4 a_srcPosition;\n\t\t\tvarying highp vec2 v_textureCoordinate;\n\n\t\t\tvoid main() {\n\t\t\t\tgl_Position = u_projectionMatrix * a_position;\n\t\t\t\tv_textureCoordinate = (u_textureMatrix * a_srcPosition).xy;\n\t\t\t}\n\t\t")}},{key:"getFragmentShader",value:function(){return"\n\t\t\tprecision ".concat(Ar.FRAGMENT_SHADER_PRECISION," float;\n\n\t\t\tvarying vec2 v_textureCoordinate;\n\t\t\tuniform lowp sampler2D u_texture;\n\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = texture2D(u_texture, v_textureCoordinate);\n\t\t\t}\n\t\t")}}]),i}(Cr);function Lr(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var _r=function(t){o(i,t);var r,n=(r=i,function(){var t,e=c(r);if(Lr()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function i(){return e(this,i),n.apply(this,arguments)}return I(i,[{key:"init",value:function(){this.a_coordinates=this.gl.getAttribLocation(this.program,"a_coordinates"),this.a_xys=this.gl.getAttribLocation(this.program,"a_xys"),this.a_transformParams=this.gl.getAttribLocation(this.program,"a_transformParams"),this.a_velocity=this.gl.getAttribLocation(this.program,"a_velocity"),this.a_color=this.gl.getAttribLocation(this.program,"a_color"),this.a_spriteRotation=this.gl.getAttribLocation(this.program,"a_spriteRotation"),this.a_spriteScaleAndOffset=this.gl.getAttribLocation(this.program,"a_spriteScaleAndOffset"),this.u_projectionMatrix=this.gl.getUniformLocation(this.program,"u_projectionMatrix"),this.u_fillTextureSize=this.gl.getUniformLocation(this.program,"u_fillTextureSize"),this.u_fillTextureOffset=this.gl.getUniformLocation(this.program,"u_fillTextureOffset"),this.u_shapeTexture=this.gl.getUniformLocation(this.program,"u_shapeTexture"),this.u_fillTexture=this.gl.getUniformLocation(this.program,"u_fillTexture")}},{key:"setBrush",value:function(t){this.brush=t,this.brushChanged=!0}},{key:"onActivate",value:function(){this.brushChanged=!0,this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.inkGLContext.fullScreenQuad2dBuffer),this.gl.vertexAttribPointer(this.a_coordinates,2,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.a_coordinates),this.gl.disableVertexAttribArray(this.a_velocity),this.gl.disableVertexAttribArray(this.a_transformParams),this.gl.disableVertexAttribArray(this.a_spriteRotation),this.gl.disableVertexAttribArray(this.a_spriteScaleAndOffset),this.gl.disableVertexAttribArray(this.a_xys),this.gl.disableVertexAttribArray(this.a_color)}},{key:"onContextChange",value:function(){this.gl.uniformMatrix4fv(this.u_projectionMatrix,!1,this.inkGLContext._graphicsSpaceToFramebufferSpaceT)}},{key:"onDeactivate",value:function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)}},{key:"drawSprite",value:function(t){this.activate(),this.brushChanged&&(this.gl.uniform2f(this.u_fillTextureOffset,this.brush.fillTextureOffset.x,this.brush.fillTextureOffset.y),this.gl.uniform2f(this.u_fillTextureSize,this.brush.fillTextureSize.width,this.brush.fillTextureSize.height),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.brush.shapeTexture),this.gl.uniform1i(this.u_shapeTexture,0),this.gl.activeTexture(this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_2D,this.brush.fillTexture),this.gl.uniform1i(this.u_fillTexture,1),this.brushChanged=!1);var e=t.red/255*t.alpha,r=t.green/255*t.alpha,n=t.blue/255*t.alpha;this.gl.vertexAttrib4f(this.a_color,e,r,n,t.alpha),0==t.dX&&0==t.dY&&(t.dX=2*this.inkGLContext.random()-1,t.dY=2*this.inkGLContext.random()-1),this.gl.vertexAttrib2f(this.a_velocity,t.dX,t.dY);var i=this.brush.rotationMode==ir.RotationMode.TRAJECTORY?1:0,o=this.brush.rotationMode==ir.RotationMode.RANDOM?2*this.inkGLContext.random()*Math.PI:0,a=(2*this.inkGLContext.random()-1)*this.brush.scattering;this.gl.vertexAttrib3f(this.a_transformParams,i,o,a),this.gl.vertexAttrib1f(this.a_spriteRotation,t.rotation),this.gl.vertexAttrib4f(this.a_spriteScaleAndOffset,t.scaleX,t.scaleY,t.offsetX,t.offsetY),this.gl.vertexAttrib3f(this.a_xys,t.x,t.y,t.size),this.inkGLContext.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}}],[{key:"getVertexShader",value:function(){return"\n\t\t\tprecision ".concat(Ar.VERTEX_SHADER_PRECISION," float;\n\n\t\t\tuniform mat4 u_projectionMatrix;\n\t\t\tuniform vec2 u_fillTextureSize;\n\t\t\tuniform vec2 u_fillTextureOffset;\n\n\t\t\tattribute lowp vec4 a_color;\n\t\t\t/* (x,y) is the center. z is the offset by x, w is the offset by y */\n\t\t\tattribute highp vec2 a_coordinates;\n\t\t\t/* the velocity at that point. It is the derivative of the function */\n\t\t\tattribute vec2 a_velocity;\n\t\t\t/* 1-shape trajectory rotation coficient, 2-shape randrom rotation angle, 3-scattering value */\n\t\t\tattribute vec3 a_transformParams;\n\n\t\t\t/* sprite rotation angle */\n\t\t\tattribute highp float a_spriteRotation;\n\t\t\t/* sprite's: 1-scaleX, 2-scaleY, 3-offsetX, 4-offsetY */\n\t\t\tattribute highp vec4 a_spriteScaleAndOffset;\n\n\t\t\tvarying lowp vec4 v_color;\n\t\t\tattribute vec3 a_xys;\n\t\t\tvarying highp vec2 v_shapeTexturePosition;\n\t\t\tvarying highp vec2 v_fillTexturePosition;\n\n\t\t\tmat2 trajectoryRotate(vec2 vNormal, float value) {\n\t\t\t\tvec2 base = vec2(1.0, 0.0);\n\n\t\t\t\tvec2 vNormalR = mix(base, vNormal, value);\n\t\t\t\tvNormalR = normalize(vNormalR);\n\n\t\t\t\tfloat cosfi = dot(vNormalR, base);\n\t\t\t\tfloat sinfi = vNormalR.x * base.y - vNormalR.y * base.x;\n\n\t\t\t\treturn mat2(\n\t\t\t\t\tcosfi, -sinfi,\n\t\t\t\t\tsinfi, cosfi\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tmat2 angleRotate2(float fi) {\n\t\t\t\tfloat sinfi = sin(fi);\n\t\t\t\tfloat cosfi = cos(fi);\n\n\t\t\t\treturn mat2(\n\t\t\t\t\tcosfi, -sinfi,\n\t\t\t\t\tsinfi, cosfi\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tmat2 scale2(float sx, float sy) {\n\t\t\t\treturn mat2(sx, 0.0, 0.0, sy);\n\t\t\t}\n\n\t\t\tmat3 rotate2h(float fi) {\n\t\t\t\tfloat sinfi = sin(fi);\n\t\t\t\tfloat cosfi = cos(fi);\n\n\t\t\t\treturn mat3(\n\t\t\t\t\tcosfi, -sinfi, 0.0,\n\t\t\t\t\tsinfi, cosfi, 0.0,\n\t\t\t\t\t0.0, 0.0, 1.0\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tmat3 scale2h(float sx, float sy) {\n\t\t\t\treturn mat3(\n\t\t\t\t\tsx, 0.0, 0.0,\n\t\t\t\t\t0.0, sy, 0.0,\n\t\t\t\t\t0.0, 0.0, 1.0\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tmat3 translate2h(float tx, float ty) {\n\t\t\t\treturn mat3(\n\t\t\t\t\t1.0, 0.0, 0.0,\n\t\t\t\t\t0.0, 1.0, 0.0,\n\t\t\t\t\ttx, ty, 1.0\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tvec2 orthoOffset(vec2 vNormal, float value) {\n\t\t\t\tvec2 vno = vec2(vNormal.y * value, vNormal.x * value);\n\t\t\t\treturn vno;\n\t\t\t}\n\n\t\t\tvoid main() {\n\t\t\t\tfloat halfSize = a_xys.z / 2.0;\n\t\t\t\tvec2 vNormal = normalize(a_velocity);\n\n\t\t\t\t// Because this applied to the texture, the y reversed because the texture coordinate system y is increasing downwards.\n\t\t\t\tvNormal.y = -vNormal.y;\n\n\t\t\t\tfloat spriteRotation = a_spriteRotation;\n\t\t\t\tvec4 spriteScaleAndOffset = a_spriteScaleAndOffset;\n\t\t\t\tspriteScaleAndOffset.y = -spriteScaleAndOffset.y;\n\t\t\t\tspriteScaleAndOffset.w = -spriteScaleAndOffset.w;\n\n\t\t\t\tmat2 productRotateMatrix = angleRotate2(a_transformParams.y) * trajectoryRotate(vNormal, a_transformParams.x);\n\t\t\t\tvec2 scatterOffset = orthoOffset(vNormal, a_transformParams.z * halfSize);\n\t\t\t\tvec2 transformedCoordinates = productRotateMatrix * a_coordinates;\n\n\t\t\t\tvec3 coordinatesH = vec3(transformedCoordinates.x, transformedCoordinates.y, 1.0);\n\t\t\t\tcoordinatesH = rotate2h(spriteRotation) * translate2h(spriteScaleAndOffset.z, spriteScaleAndOffset.w) * scale2h(spriteScaleAndOffset.x * halfSize, spriteScaleAndOffset.y * halfSize) * coordinatesH;\n\t\t\t\tvec2 coordinates = coordinatesH.xy;\n\n\t\t\t\tvec2 offset = coordinates + scatterOffset;\n\t\t\t\tvec4 position = vec4(a_xys.x + offset.x, a_xys.y + offset.y, 0.0, 1.0);\n\n\t\t\t\tv_color = a_color;\n\t\t\t\tgl_Position = u_projectionMatrix * position;\n\t\t\t\tv_fillTexturePosition = position.xy / u_fillTextureSize + u_fillTextureOffset;\n\t\t\t\tv_shapeTexturePosition = (a_coordinates + 1.0) * 0.5; /* [-1;1] -> [0;1] */\n\t\t\t}\n\t\t")}},{key:"getFragmentShader",value:function(t){return"\n\t\t\tuniform lowp sampler2D u_shapeTexture;\n\t\t\tuniform lowp sampler2D u_fillTexture;\n\n\t\t\t/* lowp seems to lead to an overflow on PowerVR SGX540, so use mediump instead :)*/\n\t\t\tvarying mediump vec4 v_color;\n\t\t\tvarying highp vec2 v_shapeTexturePosition;\n\t\t\tvarying highp vec2 v_fillTexturePosition;\n\n\t\t\tvoid main() {\n\t\t\t\tlowp vec4 c = v_color * texture2D(u_shapeTexture, v_shapeTexturePosition) * texture2D(u_fillTexture, v_fillTexturePosition);\n\n\t\t\t\tgl_FragColor = ".concat(t?"c":"vec4(c.x / c.w, c.y / c.w, c.z / c.w, c.w * 255.0)",";\n\n\t\t\t}\n\t\t")}}]),i}(Cr),Br=function(){function t(r,n){e(this,t);var i=r.getContext("webgl2",n)||r.getContext("webgl",n);this.inkGLContext=new Ar(i),this.gl=this.inkGLContext.gl,this.simpleProgram=new Or(this.inkGLContext),this.textureProgram=new Nr(this.inkGLContext),this.spriteProgram=new _r(this.inkGLContext),this.inkGLContext.programs=[this.simpleProgram,this.textureProgram,this.spriteProgram],this.currentTarget=null,this.inkGLContext.init(new Q(0,0,0,0),new Q(0,0,0,0))}return I(t,[{key:"createLayer",value:function(t,e){return new Pr(this.inkGLContext,t,e)}},{key:"drawLayerWithTransform",value:function(t,e,r){if(this.currentTarget){var n=t.graphicsBounds.toQuad(),i=t.graphicsBounds.toQuad(e);this.drawLayer(t,n,i,r)}}},{key:"drawLayer",value:function(t,e,r,n){if(this.currentTarget&&t.useTextureStorage){var i=C(),o=C(),a=this.currentTarget;a.flipY?M(o,0,a.width,a.height,0,1,-1):M(o,0,a.width,0,a.height,1,-1),t.flipY?M(i,-t.width,t.width,2*t.height,0,0,1):M(i,-t.width,t.width,-t.height,t.height,0,1),this.inkGLContext.blendMode(n),this.textureProgram.drawTexture(t.texture,r,e,o,i)}}},{key:"setTarget",value:function(t,e){var r=this.inkGLContext,n=r.gl;if(t&&!(t instanceof Pr))throw new TypeError("layer must be unset or instanceof InkLayer");if(e&&!(e instanceof Q))throw new TypeError("clipRect must be unset or instanceof GLRect");if(t){this.currentTarget=t;var i=new Q(0,0,t.storageWidth,t.storageHeight),o=new Q(0,0,t.width,t.height);r.resize(i,o),r.setUniforms(t.flipY),e?this.setTargetClipRect(e):this.disableTargetClipRect(),n.bindFramebuffer(n.FRAMEBUFFER,t.framebuffer)}}},{key:"clearColor",value:function(t){this.inkGLContext.clearColorbuffer(t)}},{key:"setTargetClipRect",value:function(t){var e=this.inkGLContext;t=t.floor().intersect(this.currentTarget.graphicsBounds),e._clipRect=t;var r=this.currentTarget.scaleFactor;t=this.currentTarget.flipY?Q.makeWithSize(t.x,this.currentTarget.storageHeight-t.top,t.width,t.height):Q.makeWithSize(t.x*r,t.y*r,t.width*r,t.height*r),e.scissors(t)}},{key:"disableTargetClipRect",value:function(){var t=this.inkGLContext;t.scissors(null),t._clipRect=t.graphicsBox}},{key:"drawStroke",value:function(t,e,r){return this.currentTarget?0==e.length?null:t instanceof ir?this.drawGL(t,e,r):this.draw2D(t,e,r):null}},{key:"drawGL",value:function(t,e,r){var n,i=null,o=this.inkGLContext._clipRect;r&&(n=this.inkGLContext.scatterMethodRandomSeed,this.inkGLContext.scatterMethodRandomSeed=r.randomSeed),t.randomizeFill&&(t.fillTextureOffset={x:this.inkGLContext.random(),y:this.inkGLContext.random()}),t.blendMode?this.inkGLContext.blendMode(t.blendMode):this.inkGLContext.blendMode(Qe.SOURCE_OVER),this.spriteProgram.setBrush(t);for(var a=0;a<e.length;a++){var s=e.getPoint(a),u=Q.calculateBrushGLSegmentBounds(s,t.scattering).intersect(o);u&&(this.spriteProgram.drawSprite(s),i=u.union(i))}return r&&(r.randomSeed=this.inkGLContext.scatterMethodRandomSeed,this.inkGLContext.scatterMethodRandomSeed=n),i?i.ceil():null}},{key:"draw2D",value:function(t,e,r){var n=this;if(t.spacing>1)e.forEach((function(t){var e=n.triangulate([t]);n.fillStroke(e,r)}));else{var i=this.triangulate(e);this.fillStroke(i,r)}}},{key:"triangulate",value:function(t){var e=[],r=[];t.forEach((function(t){for(var e=[],n=0;n<t.length;n+=2)e.push(new Tr(t[n],t[n+1]));r.push(e)}));var n=new Ir(r.shift());r.forEach((function(t){return n.addHole(t)}));var i=[];try{n.triangulate(),i=n.getTriangles()}catch(t){console.warn(t)}return i.forEach((function(t){t.getPoints().forEach((function(t){e.push(t.x,t.y)}))})),e}},{key:"fillStroke",value:function(t,e){this.fill(t,e,!0,!0)}},{key:"fill",value:function(t,e,r,n){e=H.premultiply(e);for(var i=r?4:1,o=i*i,a=1.01/o,s=1.25/i,u=new Float32Array(t.length*o),c=new Float32Array(2*t.length*o),l=0,h=0,f=0;f<i;f++)for(var d=0;d<i;d++)for(var p=a,y={x:f*s-(1.25-s)/2,y:d*s-(1.25-s)/2},v=0;v<t.length;v+=6)for(var g=[{x:t[v],y:t[v+1]},{x:t[v+2],y:t[v+3]},{x:t[v+4],y:t[v+5]}],m=0;m<3;m++)u[l++]=g[m%3].x+y.x,u[l++]=g[m%3].y+y.y,c[h++]=p*e.red,c[h++]=p*e.green,c[h++]=p*e.blue,c[h++]=p*e.alpha;var b=Qe.SOURCE_OVER;n?b=Qe.MAX:r?b=Qe.LIGHTER:H.equals(e,H.TRANSPERENT)&&(b=Qe.COPY),this.inkGLContext.gl.bindFramebuffer(this.inkGLContext.gl.FRAMEBUFFER,this.currentTarget.framebuffer),this.inkGLContext.blendMode(b),this.simpleProgram.drawVertices(u,c)}},{key:"readPixels",value:function(t){var e=this.currentTarget,r=this.inkGLContext.gl;if(t){if(!(t instanceof Q))throw new TypeError("box must be instance of GLRect")}else t=e.graphicsBounds;e.flipY&&(t=Q.makeWithSize(t.x,e.height-t.y-t.height,t.width,t.height)),this.setTarget(e);var n=new Uint8Array(t.width*t.height*4);return r.readPixels(parseInt(t.x*e.scaleFactor),parseInt(t.y*e.scaleFactor),parseInt(t.width*e.scaleFactor),parseInt(t.height*e.scaleFactor),r.RGBA,r.UNSIGNED_BYTE,n),n}},{key:"writePixels",value:function(t,e){if(t&&!(t instanceof Q))throw new TypeError("rect must be instance of GLRect");var r=this.currentTarget,n=this.inkGLContext.gl;if(t||(t=Q.makeWithSize(0,0,r.width,r.height)),!r.useTextureStorage)throw new Error("writePixels layer without texture is not supported!");r.flipY&&(t=Q.makeWithSize(t.x,r.height-t.y-t.height,t.width,t.height));var i=Q.makeWithSize(t.x*r.scaleFactor,t.y*r.scaleFactor,t.width*r.scaleFactor,t.height*r.scaleFactor);n.finish(),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,r.texture),n.texSubImage2D(n.TEXTURE_2D,0,parseInt(i.x),parseInt(i.y),parseInt(i.width),parseInt(i.height),n.RGBA,n.UNSIGNED_BYTE,e)}}]),t}();function Fr(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var Ur=function(t){o(a,t);var r,n,i=(r=a,function(){var t,e=c(r);if(Fr()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function a(t){var r;if(e(this,a),r=i.call(this,t,{display:!0,width:t.inkGLContext.gl.canvas.width,height:t.inkGLContext.gl.canvas.height,flipY:m.typeGL==m.TypeGL.WEB}),Object.defineProperty(s(r),"surface",{value:t.inkGLContext.gl.canvas,enumerable:!0}),Object.defineProperty(s(r),"ctx",{value:t.inkGLContext.gl,enumerable:!0}),"function"==typeof requestAnimationFrame&&!t.attributes.preserveDrawingBuffer){var n=r.createLayer();Object.defineProperty(s(r),"backbuffer",{value:n,enumerable:!0});r.frameID=requestAnimationFrame((function t(e){r.present&&(delete r.present,q(c(a.prototype),"blend",s(r)).call(s(r),n,{mode:Qe.COPY})),r.frameID=requestAnimationFrame(t)}))}return r}return I(a,[{key:"test",value:function(){var t=this;this.testBuffer||(this.testCnt=0,this.testBuffer=this.ctx.createBuffer()),this.ctx.bindBuffer(this.ctx.ARRAY_BUFFER,this.testBuffer);var e=Date.now();this.ctx.bufferData(this.ctx.ARRAY_BUFFER,new Float32Array([0,0,0,0,0,0,0,0]),this.ctx.DYNAMIC_DRAW),(e=Date.now()-e)>5&&this.testCnt<100?setTimeout((function(){t.testCnt++,t.test()}),100):(this.ctx.deleteBuffer(this.testBuffer),delete this.testBuffer,delete this.testCnt)}},{key:"createLayer",value:function(t){return new Rr(this.inkContext,t)}},{key:"clear",value:function(t,e){this.backbuffer?(this.backbuffer.clear(t,e),this.present=!0):q(c(a.prototype),"clear",this).call(this,t,e)}},{key:"draw",value:function(t,e){var r;return this.backbuffer?(r=this.backbuffer.draw(t,e),this.present=!0):r=q(c(a.prototype),"draw",this).call(this,t,e),r}},{key:"drawStroke",value:function(t,e,r){var n;return this.backbuffer?(n=this.backbuffer.drawStroke(t,e,r),this.present=!0):n=q(c(a.prototype),"drawStroke",this).call(this,t,e,r),n}},{key:"fill",value:function(t,e,r){var n;return this.backbuffer?(n=this.backbuffer.fill(t,e,r),this.present=!0):n=q(c(a.prototype),"fill",this).call(this,t,e,r),n}},{key:"blend",value:function(t,e){this.backbuffer?(this.backbuffer.blend(t,e),this.present=!0):q(c(a.prototype),"blend",this).call(this,t,e)}},{key:"readPixels",value:function(t,e){return this.backbuffer?this.backbuffer.readPixels(t,e):q(c(a.prototype),"readPixels",this).call(this,t,e)}},{key:"writePixels",value:function(t,e){this.backbuffer?(this.backbuffer.writePixels(t,e),this.present=!0):q(c(a.prototype),"writePixels",this).call(this,t,e)}},{key:"toBlob",value:(n=ht(ct.mark((function t(){var e,r,n,i=arguments;return ct.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e=i.length>0&&void 0!==i[0]?i[0]:this.bounds,r=i.length>1?i[1]:void 0,n=i.length>2?i[2]:void 0,!this.backbuffer){t.next=9;break}return t.next=6,this.backbuffer.toBlob(e,r,n);case 6:return t.abrupt("return",t.sent);case 9:return t.next=11,q(c(a.prototype),"toBlob",this).call(this,e,r,n);case 11:return t.abrupt("return",t.sent);case 12:case"end":return t.stop()}}),t,this)}))),function(){return n.apply(this,arguments)})},{key:"resize",value:function(t,e){q(c(a.prototype),"resize",this).call(this,t,e),this.surface.width=t,this.surface.height=e}},{key:"delete",value:function(){"number"==typeof this.frameID&&cancelAnimationFrame(this.frameID),q(c(a.prototype),"delete",this).call(this),this.backbuffer&&this.backbuffer.delete()}},{key:"deleteLater",value:function(){return q(c(a.prototype),"deleteLater",this).call(this),this.backbuffer&&this.backbuffer.deleteLater(),this}}],[{key:"createInstance",value:function(t,e,r,n){if(!t||"function"!=typeof t.getContext)throw new Error("WebGL context provider is required");if(e>0&&r>0&&(t.width=e,t.height=r),!(t.width>0&&t.width>0))throw new Error("width and height are required and should be positive whole numbers");var i=new Br(t,n);return i.attributes=n||{},new a(i)}}]),a}(Rr),jr=function(){function t(r,n){var i=this;e(this,t),this.canvas=r;var o=n instanceof Rr?n:void 0,a=n&&!o?n:new Object;this.layer=o||r.createLayer(a),this.layerOptions=a,this.ownLayer=!o,this.restart=!0,this.brush=void 0,this.color=void 0,this.backgroundColor=H.TRANSPERENT,this.blendMode=Qe.SOURCE_OVER,this.randomSeed=void 0,this.preliminaryLayer=void 0,this.strokeBounds=void 0,this.updatedArea=void 0,this.streamUpdatedArea=void 0,Object.defineProperty(this,"settings",{get:function(){return{brush:i.brush,color:i.color,backgroundColor:i.backgroundColor,blendMode:i.blendMode,randomSeed:i.initialRandomSeed}},enumerable:!0})}return I(t,[{key:"configure",value:function(t){t.brush&&(this.brush=t.brush),t.color&&(this.color=t.color),t.backgroundColor&&(this.backgroundColor=t.backgroundColor),t.blendMode&&(this.blendMode=t.blendMode),this.brush instanceof ir&&isFinite(t.randomSeed)&&(this.initialRandomSeed=t.randomSeed),this.restart=!0}},{key:"draw",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.layer.isDeleted())throw new Error("StrokeRenderer cannot draw, it is already deleted");if(this.restart&&this.reset(),t instanceof ar){var r=t,n=Qe.SOURCE_OVER;if(r.renderMode&&!(n=ar.RenderMode.getBlendMode(r.renderMode)))return void console.warn("Cannot process ".concat(r.renderMode," render mode. Requres custom processing."));this.blendMode=n;var i=this.layer.draw(r);this.strokeBounds=i,this.updatedArea=i,this.restart=!0}else{if(this.validate(t)){var o=this.brush instanceof ir?this.strokeLastRendererdDrawContext:this.color,a=this.layer.drawStroke(this.brush,t,o);a&&(this.incompleteStrokeBounds=a.union(this.incompleteStrokeBounds),this.strokeBounds=a.union(this.strokeBounds),this.updatedArea=this.incompleteStrokeBounds.union(this.preliminaryDirtyArea))}else this.updatedArea=this.preliminaryDirtyArea;this.blendWithPreliminaryLayer=!1,this.preliminaryDirtyArea=null,e&&(this.strokeBounds=this.strokeBounds.ceil(),this.restart=!0)}}},{key:"drawPreliminary",value:function(t){if(this.validate(t)){var e=null,r=null;this.brush instanceof ir?(this.strokeLastRendererdDrawContext.copyTo(this.strokePrelimLastRenderedDrawContext),e=this.strokePrelimLastRenderedDrawContext):e=this.color,this.ownLayer?(this.preliminaryLayer||(this.preliminaryLayer=this.canvas.createLayer(this.layerOptions),this.preliminaryLayer.clear()),r=this.preliminaryLayer):r=this.preliminaryLayer||this.canvas,this.updatedArea&&this.preliminaryLayer&&this.preliminaryLayer.blend(this.layer,{mode:Qe.COPY,rect:this.updatedArea}),this.preliminaryDirtyArea=r.drawStroke(this.brush,t,e),this.updatedArea=$.union(this.preliminaryDirtyArea,this.updatedArea),this.preliminaryLayer&&(this.blendWithPreliminaryLayer=!0)}}},{key:"abort",value:function(){this.restart=!0}},{key:"reset",value:function(){this.incompleteStrokeBounds=null,this.strokeBounds=null,this.updatedArea=null,this.preliminaryDirtyArea=null,this.brush instanceof ir?(this.strokeLastRendererdDrawContext=new kr(this.initialRandomSeed),this.strokePrelimLastRenderedDrawContext||(this.strokePrelimLastRenderedDrawContext=new kr),delete this.initialRandomSeed,this.randomSeed=this.strokeLastRendererdDrawContext.randomSeed):delete this.randomSeed,this.ownLayer&&(this.layer.clear(this.backgroundColor),this.preliminaryLayer&&this.preliminaryLayer.clear(this.backgroundColor)),this.restart=!1}},{key:"validate",value:function(t){if(!this.brush)throw new Error("StrokeRenderer requires 'brush' to be configured");return!!t}},{key:"blendUpdatedArea",value:function(t){if(this.updatedArea){var e=this.blendWithPreliminaryLayer?this.preliminaryLayer:this.layer,r=t||this.canvas,n=r.bounds.intersect(this.updatedArea);n&&(n=n.ceil(),"function"==typeof this.streamUpdatedArea?this.streamUpdatedArea(e.getImageData(n),n,!1):r.blend(e,{mode:this.blendMode,rect:n})),this.incompleteStrokeBounds=null,this.updatedArea=null}}},{key:"blendStroke",value:function(t,e,r){if(this.strokeBounds){r||(r=this.blendMode);var n=this.layer,i=t||this.canvas;(e=i.bounds.intersect(e||this.strokeBounds))&&(e=e.ceil(),"function"==typeof this.streamUpdatedArea?this.streamUpdatedArea(n.getImageData(e),e,!0):i.blend(n,{mode:r,rect:e}))}}},{key:"toStroke",value:function(t){var e=t.getSensorData(),r=t.getSpline(),n=t.getInkPath();r.randomSeed=this.randomSeed;var i=new ar(this.brush,r,n,e);return e&&(i.sensorDataMapping=e.inkStream.getPipelineMapping()),this.blendMode!=Qe.SOURCE_OVER&&(i.renderMode=ar.RenderMode.get(this.blendMode)),i}},{key:"delete",value:function(){this.ownLayer&&(this.layer.delete(),this.preliminaryLayer&&this.preliminaryLayer.delete())}}]),t}(),Gr=function t(r,n,i){e(this,t),this.subject=r,this.predicate=n,this.object=i},Xr=function(){function t(){e(this,t),this.statements=[]}return I(t,[{key:"add",value:function(){for(var t=this,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];r.forEach((function(e){return t.statements.push(e)}))}},{key:"remove",value:function(){for(var t=this,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];r.forEach((function(e){return t.statements.remove(e)}))}},{key:"addTriple",value:function(t,e,r){this.statements.push(new Gr(t,e,r))}},{key:"search",value:function(t){return this.statements.filter((function(e){var r=!0;return Object.keys(t).forEach((function(n){r=r&&e[n]==t[n]})),r}))}}]),t}(),Yr=(m.commonJS,protobuf),zr={nested:{WacomInkFormat3:{options:{optimize_for:"SPEED",java_multiple_files:!1,java_package:"com.wacom.ink.protobuf",java_outer_classname:"Will3_0_0",csharp_namespace:"Protobuf.WILL_3_0_0"},nested:{Rectangle:{fields:{x:{type:"float",id:1},y:{type:"float",id:2},width:{type:"float",id:3},height:{type:"float",id:4}}},Matrix4:{fields:{m00:{type:"float",id:1},m01:{type:"float",id:2},m02:{type:"float",id:3},m03:{type:"float",id:4},m10:{type:"float",id:5},m11:{type:"float",id:6},m12:{type:"float",id:7},m13:{type:"float",id:8},m20:{type:"float",id:9},m21:{type:"float",id:10},m22:{type:"float",id:11},m23:{type:"float",id:12},m30:{type:"float",id:13},m31:{type:"float",id:14},m32:{type:"float",id:15},m33:{type:"float",id:16}}},Range:{fields:{min:{type:"float",id:1},max:{type:"float",id:2},remapURI:{type:"string",id:3}}},Float32:{fields:{value:{type:"float",id:1}}},Uint32:{fields:{value:{type:"uint32",id:1}}},Property:{fields:{name:{type:"string",id:1},value:{type:"string",id:2}}},SemanticTriple:{fields:{subject:{type:"string",id:1},predicate:{type:"string",id:2},object:{type:"string",id:3}}},InkState:{values:{PLANE:0,HOVERING:1,IN_VOLUME:2,VOLUME_HOVERING:3}},InkSensorMetricType:{values:{LENGTH:0,TIME:1,FORCE:2,ANGLE:3,NORMALIZED:4,LOGICAL:5,DIMENSIONLESS:6}},InkInputProviderType:{values:{PEN:0,TOUCH:1,MOUSE:2,CONTROLLER:3}},InputContext:{fields:{id:{type:"string",id:1},environmentID:{type:"string",id:2},sensorContextID:{type:"string",id:3}}},Environment:{fields:{id:{type:"string",id:1},properties:{rule:"repeated",type:"Property",id:2}}},InkInputProvider:{fields:{id:{type:"string",id:1},type:{type:"InkInputProviderType",id:2},properties:{rule:"repeated",type:"Property",id:3}}},InputDevice:{fields:{id:{type:"string",id:1},properties:{rule:"repeated",type:"Property",id:2}}},SensorContext:{fields:{id:{type:"string",id:1},sensorChannelsContext:{rule:"repeated",type:"SensorChannelsContext",id:2}}},SensorChannelsContext:{fields:{id:{type:"string",id:1},channels:{rule:"repeated",type:"SensorChannel",id:2},samplingRateHint:{type:"Uint32",id:3},latency:{type:"Uint32",id:4},inkInputProviderID:{type:"string",id:5},inputDeviceID:{type:"string",id:6}}},SensorChannel:{fields:{id:{type:"string",id:1},type:{type:"string",id:2},metric:{type:"InkSensorMetricType",id:3},resolution:{type:"double",id:4},min:{type:"float",id:5},max:{type:"float",id:6},precision:{type:"uint32",id:7}}},InputContextData:{fields:{inputContexts:{rule:"repeated",type:"InputContext",id:1},inkInputProviders:{rule:"repeated",type:"InkInputProvider",id:2},inputDevices:{rule:"repeated",type:"InputDevice",id:3},environments:{rule:"repeated",type:"Environment",id:4},sensorContexts:{rule:"repeated",type:"SensorContext",id:5}}},ChannelData:{fields:{sensorChannelID:{type:"string",id:1},values:{rule:"repeated",type:"sint32",id:2}}},SensorData:{fields:{id:{type:"string",id:1},inputContextID:{type:"string",id:2},state:{type:"InkState",id:3},timestamp:{type:"uint64",id:4},dataChannels:{rule:"repeated",type:"ChannelData",id:5}}},Stroke:{fields:{id:{type:"string",id:1},startParameter:{type:"float",id:2},endParameter:{type:"float",id:3},splineX:{rule:"repeated",type:"float",id:4},splineY:{rule:"repeated",type:"float",id:5},splineZ:{rule:"repeated",type:"float",id:6},red:{rule:"repeated",type:"float",id:7},green:{rule:"repeated",type:"float",id:8},blue:{rule:"repeated",type:"float",id:9},alpha:{rule:"repeated",type:"float",id:10},size:{rule:"repeated",type:"float",id:11},rotation:{rule:"repeated",type:"float",id:12},scaleX:{rule:"repeated",type:"float",id:13},scaleY:{rule:"repeated",type:"float",id:14},scaleZ:{rule:"repeated",type:"float",id:15},offsetX:{rule:"repeated",type:"float",id:16},offsetY:{rule:"repeated",type:"float",id:17},offsetZ:{rule:"repeated",type:"float",id:18},sensorDataOffset:{type:"uint32",id:19},sensorDataID:{type:"string",id:20},sensorDataMapping:{rule:"repeated",type:"uint32",id:21},style:{type:"Style",id:22}}},RotationMode:{values:{NONE:0,RANDOM:1,TRAJECTORY:2}},BlendMode:{values:{SOURCE_OVER:0,DESTINATION_OVER:1,DESTINATION_OUT:2,LIGHTER:3,COPY:4,MIN:5,MAX:6}},BrushPrototype:{fields:{coordX:{rule:"repeated",type:"float",id:1},coordY:{rule:"repeated",type:"float",id:2},coordZ:{rule:"repeated",type:"float",id:3},indices:{rule:"repeated",type:"uint32",id:4},shapeURI:{type:"string",id:5},size:{type:"float",id:6}}},VectorBrush:{fields:{name:{type:"string",id:1},prototype:{rule:"repeated",type:"BrushPrototype",id:2},spacing:{type:"float",id:3}}},RasterBrush:{fields:{name:{type:"string",id:1},spacing:{type:"float",id:2},scattering:{type:"float",id:3},rotationMode:{type:"RotationMode",id:4},shapeTexture:{rule:"repeated",type:"bytes",id:5},shapeTextureURI:{rule:"repeated",type:"string",id:6},fillTexture:{type:"bytes",id:7},fillTextureURI:{type:"string",id:8},fillWidth:{type:"float",id:9},fillHeight:{type:"float",id:10},randomizeFill:{type:"bool",id:11},blendMode:{type:"BlendMode",id:12}}},NodeType:{values:{STROKE_GROUP:0,SENSOR_DATA_GROUP:1,STROKE:2,SENSOR_DATA:3}},Node:{fields:{id:{type:"string",id:1},depth:{type:"uint32",id:2},index:{type:"uint32",id:3},type:{type:"NodeType",id:4},groupBoundingBox:{type:"Rectangle",id:5},chunkFromIndex:{type:"uint32",id:6},chunkToIndex:{type:"uint32",id:7}}},View:{fields:{name:{type:"string",id:1},tree:{rule:"repeated",type:"Node",id:2}}},PathPointProperties:{fields:{size:{type:"Float32",id:1},red:{type:"Float32",id:2},green:{type:"Float32",id:3},blue:{type:"Float32",id:4},alpha:{type:"Float32",id:5},rotation:{type:"Float32",id:6},scaleX:{type:"Float32",id:7},scaleY:{type:"Float32",id:8},scaleZ:{type:"Float32",id:9},offsetX:{type:"Float32",id:11},offsetY:{type:"Float32",id:12},offsetZ:{type:"Float32",id:13}}},Style:{fields:{properties:{type:"PathPointProperties",id:1},brushURI:{type:"string",id:2},particlesRandomSeed:{type:"uint32",id:3},renderModeURI:{type:"string",id:4}}},InputData:{fields:{inputContextData:{type:"InputContextData",id:1},sensorData:{rule:"repeated",type:"SensorData",id:2}}},InkData:{fields:{strokes:{rule:"repeated",type:"Stroke",id:1}}},Brushes:{fields:{vectorBrushes:{rule:"repeated",type:"VectorBrush",id:1},rasterBrushes:{rule:"repeated",type:"RasterBrush",id:2}}},TripleStore:{fields:{statements:{rule:"repeated",type:"SemanticTriple",id:1}}},Tool:{oneofs:{brush:{oneof:["vectorBrush","rasterBrush"]}},fields:{vectorBrush:{type:"VectorBrush",id:1},rasterBrush:{type:"RasterBrush",id:2},blendMode:{type:"BlendMode",id:3},context:{type:"PathPointContext",id:4}}},PathPointContext:{fields:{statics:{type:"PathPointProperties",id:1},dynamics:{type:"PathPointSettings",id:2}}},PathPointSettings:{fields:{size:{type:"PropertySettings",id:1},red:{type:"PropertySettings",id:2},green:{type:"PropertySettings",id:3},blue:{type:"PropertySettings",id:4},alpha:{type:"PropertySettings",id:5},rotation:{type:"PropertySettings",id:6},scaleX:{type:"PropertySettings",id:7},scaleY:{type:"PropertySettings",id:8},scaleZ:{type:"PropertySettings",id:9},offsetX:{type:"PropertySettings",id:11},offsetY:{type:"PropertySettings",id:12},offsetZ:{type:"PropertySettings",id:13}}},PropertySettings:{fields:{value:{type:"Range",id:1},velocity:{type:"Range",id:2},pressure:{type:"Range",id:3},altitude:{type:"Range",id:4},radiusX:{type:"Range",id:5},radiusY:{type:"Range",id:6},resolveURI:{type:"string",id:7},dependencies:{rule:"repeated",type:"InputPropertyType",id:8}}},InputPropertyType:{values:{PRESSURE:0,RADIUS_X:1,RADIUS_Y:2,AZIMUTH:3,ALTITUDE:4,ROTATION:5}},InkObject:{fields:{inputData:{type:"InputData",id:1},inkData:{type:"InkData",id:2},brushes:{type:"Brushes",id:3},inkTree:{rule:"repeated",type:"Node",id:4},views:{rule:"repeated",type:"View",id:5},knowledgeGraph:{type:"TripleStore",id:6},transform:{type:"Matrix4",id:7},properties:{rule:"repeated",type:"Property",id:8}}}}}}};function Vr(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var Hr=function(t){o(i,t);var r,n=(r=i,function(){var t,e=c(r);if(Vr()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function i(t){return e(this,i),n.call(this,t)}return i}(Yt);function Wr(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var qr=function(t){o(i,t);var r,n=(r=i,function(){var t,e=c(r);if(Wr()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function i(t){var r,o;return e(this,i),r=n.call(this,t),Object.defineProperty(s(r),"bounds",{get:function(){return o||(o=this.getBounds()),o},set:function(t){o=t},enumerable:!0}),Object.defineProperty(s(r),"root",{get:function(){for(var t=this.parent,e=this;t;)e=t,t=t.parent;return e},enumerable:!0}),r}return I(i,[{key:"updateID",value:function(t,e){var r=this.root.model;r&&r.updateRegistry(t,e)}},{key:"getBounds",value:function(){return this.content.bounds}},{key:"invalidateBounds",value:function(){this.bounds=void 0}},{key:"remove",value:function(){this.parent.removeChild(this)}}]),i}(Hr);function Zr(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var Jr=function(t){o(i,t);var r,n=(r=i,function(){var t,e=c(r);if(Zr()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function i(t){var r;return e(this,i),(r=n.call(this,t)).children=[],Object.defineProperty(s(r),"content",{value:r.children,enumerable:!0}),r}return I(i,[{key:"getBounds",value:function(){var t;return this.children.forEach((function(e){t=t?t.union(e.bounds):e.bounds})),t}},{key:"appendChild",value:function(t,e){if(!(t instanceof qr))throw new Error("Incompatible node found - ".concat(t.constructor.name,". It should be ink model Element."));if(e<0)throw new Error("Index should be a positive number");var r=t.parent;if(r&&t.parent.children.remove(t),t.parent=this,"number"==typeof e&&e<this.children.length?this.children.insert(e,t):this.children.push(t),!r){var n=this.root.model;n&&n.register(t)}return this.invalidateBounds(),t}},{key:"removeChild",value:function(t){if(!this.children.includes(t))throw new Error("Node was not found");var e=this.root.model;e&&e.unregister(t),this.invalidateBounds(),this.children.remove(t)}},{key:"remove",value:function(){this.parent?this.parent.removeChild(this):(this.model&&this.model.unregister(this),this.invalidateBounds())}}]),i}(qr);function Kr(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var Qr=function(t){o(i,t);var r,n=(r=i,function(){var t,e=c(r);if(Kr()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function i(t){var r;return e(this,i),r=n.call(this),Object.defineProperty(s(r),"content",{value:t,enumerable:!0}),r}return i}(qr),$r=function(){function t(r,n,i){e(this,t),this.model=r,this.type=n||r.type,this.tree=this.createGroup(i),this.tree.model=this,this.register(this.tree)}return I(t,[{key:"addPath",value:function(t,e){return e||(e=this.tree),e.appendChild(this.createElement(t))}},{key:"createElement",value:function(t,e,r){var n=this.model.createElement(t,this);return n.fromPointIndex=e,n.toPointIndex=r,n}},{key:"createGroup",value:function(t){return this.model.createGroup(t,this)}},{key:"register",value:function(e){var r=this;if(e instanceof Jr)e.children.forEach((function(t){return r.register(t)}));else if(e instanceof Qr){if(e.content instanceof ar){if(this.type!=t.Type.STROKE)throw new Error("Incompatible element content found - ".concat(e.content.constructor.name,". Content should be instance of Stroke."))}else{if(!(e.content instanceof ne))throw new Error("Incompatible element content found - ".concat(e.content.constructor.name,". Content should be ").concat(this.type.name,"."));if(this.type!=t.Type.SENSOR_DATA)throw new Error("Incompatible element content found - ".concat(e.content.constructor.name,". Content should be instance of SensorData."))}if(!this.model.content.includes(e.content))throw new Error("Node content not found in underling ink model - ".concat(e.content.id))}this.model.index(e),this.updateKnowledgeGraph(e.id)}},{key:"unregister",value:function(t){var e=this;t instanceof Jr&&t.children.forEach((function(t){return e.unregister(t)})),delete this.model.registry[t.id],this.updateKnowledgeGraph(t.id)}},{key:"updateKnowledgeGraph",value:function(t){if(t){var e=this.model.uriBuilder.buildNodeURI(t);if(this.model.registry[t]){var r,n;if(!this.knowledgeGraph)return;(r=this.model.knowledgeGraph).add.apply(r,w(this.knowledgeGraph.search({subject:e}))),(n=this.model.knowledgeGraph).add.apply(n,w(this.knowledgeGraph.search({object:e})))}else{var i,o;(i=this.model.knowledgeGraph).remove.apply(i,w(this.model.knowledgeGraph.search({subject:e}))),(o=this.model.knowledgeGraph).remove.apply(o,w(this.model.knowledgeGraph.search({object:e})))}}}}]),t}(),tn=function(){function t(){e(this,t)}return I(t,[{key:"setInkModelURI",value:function(t){return this.inkModelURI=t,this}},{key:"setNodeID",value:function(t){return this.inkNodeID=t,this}},{key:"buildNodeURI",value:function(t,e){return this.reset().setInkModelURI(e).setNodeID(t).build()}},{key:"build",value:function(){var t="",e="";return this.inkModelURI&&(t=this.fixedEncodeURIComponent(this.inkModelURI),e="/"),e+="node/"+this.inkNodeID,"".concat("uim:").concat(t).concat(e)}},{key:"fixedEncodeURIComponent",value:function(t){return encodeURIComponent(t).replace(/[!'()*]/g,(function(t){return"%"+t.charCodeAt(0).toString(16)}))}},{key:"reset",value:function(){return this.inkModelURI=void 0,this.inkNodeID=void 0,this}}]),t}(),en=function(){function t(){var r=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:t.Type.STROKE,i=arguments.length>1?arguments[1]:void 0;e(this,t),this.type=n,this.tree=this.createGroup(i),this.tree.model=this,this.props={},this.views={},this.knowledgeGraph=new Xr,this.uriBuilder=new tn,this.registry={},this.registry[this.tree.id]=this.tree,Object.defineProperty(this,"content",{value:[],enumerable:!0}),Object.defineProperty(this,"strokes",{get:function(){return r.type==t.Type.STROKE?r.content:[]},enumerable:!0}),Object.defineProperty(this,"sensorData",{get:function(){return r.type==t.Type.STROKE?r.content.map((function(t){return t.sensorData})).filter((function(t){return!!t})):r.content},enumerable:!0}),Object.defineProperty(this,"brushes",{get:function(){var t={};return r.strokes.forEach((function(e){return t[e.brush.name]=r.registry[e.brush.name]||e.brush})),Object.values(t)},set:function(t){t.forEach((function(t){return r.registry[t.name]=t}))},enumerable:!0})}return I(t,[{key:"addPath",value:function(t,e){return e||(e=this.tree),e.appendChild(this.createElement(t))}},{key:"removePath",value:function(t){t.nodeID&&this.registry[t.nodeID].remove()}},{key:"replacePath",value:function(t,e,r){var n=this;if(t.nodeID){var i=this.getItem(t.nodeID),o=i.parent||this.tree,a=e.map((function(t){return n.createElement(t)})),s=o.children.indexOf(i);if(r){var u=o.appendChild(this.createGroup(),s);a.forEach((function(t){return u.appendChild(t)}))}else a.forEach((function(t,e){return o.appendChild(t,s+e)}));this.removePath(t)}}},{key:"createElement",value:function(e,r){if(!e)throw new Error("Element content not found");var n=r?r.type:this.type;switch(n){case t.Type.STROKE:if(!(e instanceof ar))throw new Error("Incompatible element content found - ".concat(e.constructor.name,". Content should be instance of Stroke."));break;case t.Type.SENSOR_DATA:if(!(e instanceof ne))throw new Error("Incompatible element content found - ".concat(e.constructor.name,". Content should be instance of SensorData."));break;default:throw console.warn(n),new Error("Invalid ink model type found")}return new Qr(e)}},{key:"createGroup",value:function(t,e){return new Jr(t)}},{key:"getItem",value:function(t){return this.registry[t]}},{key:"register",value:function(e){var r=this;if(e instanceof Jr)e.children.forEach((function(t){return r.register(t)}));else if(e instanceof Qr){if(e.content instanceof ar){if(this.type!=t.Type.STROKE)throw new Error("Incompatible element content found - ".concat(e.content.constructor.name,". Content should be instance of Stroke."))}else{if(!(e.content instanceof ne))throw new Error("Incompatible element content found - ".concat(e.content.constructor.name,". Content should be ").concat(this.type.name,"."));if(this.type!=t.Type.SENSOR_DATA)throw new Error("Incompatible element content found - ".concat(e.content.constructor.name,". Content should be instance of SensorData."))}Object.defineProperty(e.content,"nodeID",{value:e.id,enumerable:!0,configurable:!0}),this.content.push(e.content),this.index(e.content)}this.index(e),e instanceof Hr&&!this.keepViews&&this.resetViews()}},{key:"updateRegistry",value:function(t,e){var r=this.registry[t];delete this.registry[t],this.registry[r.id]=r,this.updateKnowledgeGraph(t,e)}},{key:"unregister",value:function(t){var e=this;t instanceof Hr&&this.resetViews(),t instanceof Jr?t.children.forEach((function(t){return e.unregister(t)})):t instanceof Qr&&(delete t.content.nodeID,delete this.registry[t.content.id],this.content.remove(t.content)),t==this.tree?t.children.clear():delete this.registry[t.id],this.updateKnowledgeGraph(t.id)}},{key:"updateKnowledgeGraph",value:function(t,e){var r,n,i=this.uriBuilder.buildNodeURI(t),o=this.uriBuilder.buildNodeURI(e);o?(this.knowledgeGraph.search({subject:i}).forEach((function(t){return t.subject=o})),this.knowledgeGraph.search({object:i}).forEach((function(t){return t.object=o}))):((r=this.knowledgeGraph).remove.apply(r,w(this.knowledgeGraph.search({subject:i}))),(n=this.knowledgeGraph).remove.apply(n,w(this.knowledgeGraph.search({object:i}))))}},{key:"index",value:function(t){if(this.registry[t.id])throw new Error("Cannot register item with id ".concat(t.id,". Already is available item with such identifier."));this.registry[t.id]=t}},{key:"createView",value:function(t,e,r,n){var i=new $r(this,e,r);return i.name=t,this.views[t]=i,n&&(i.knowledgeGraph=n,i.updateKnowledgeGraph(r)),i}},{key:"resetViews",value:function(){for(var t in this.views)this.views[t].tree.remove(),delete this.views[t]}}]),t}();en.createEnum("Type",["STROKE","SENSOR_DATA"]),$r.Type=en.Type;var rn={extension:"uim",contentType:"application/vnd.wacom-ink.model",version:new Uint8Array([3,0,0]),fourCCLength:4,headers:{riffFourCC:"RIFF".toCharArray(!0),formatFourCC:"UINK".toCharArray(!0),headChunkFourCC:"HEAD".toCharArray(!0),inkChunkFourCC:"DATA".toCharArray(!0)}},nn=function(){function t(){e(this,t),this.reset(),Object.defineProperty(this,"data",{get:function(){return this.fileBytes||this.build(),this.fileBytes}})}return I(t,[{key:"encodeInk",value:function(t){t&&this.encode(rn.headers.inkChunkFourCC,t)}},{key:"encode",value:function(t,e){var r=t instanceof Uint8Array?t:t.toCharArray().toUint8Array();if(r.length!=rn.fourCCLength)throw new Error('Invalid fourCC: "'.concat(t,'"'));if(this.fileBytes)throw new Error("File content building completed. Cannot add more chunks.");this.chunks.push(this.createChunk(r,e))}},{key:"build",value:function(){var t=this,e=rn.headers,r=0;this.chunks.unshift(this.createChunk(rn.headers.headChunkFourCC,rn.version)),this.chunks.forEach((function(t){r+=t.length}));var n=e.formatFourCC.length+r,i=e.riffFourCC.length+Uint32Array.BYTES_PER_ELEMENT+n,o=new ArrayBuffer(i);this.fileBytes=new Uint8Array(o),this.dataView=new DataView(o),this.byteOffset=0,this.fileBytes.set(e.riffFourCC,this.byteOffset),this.byteOffset+=e.riffFourCC.length,this.dataView.setUint32(this.byteOffset,n,!0),this.byteOffset+=Uint32Array.BYTES_PER_ELEMENT,this.fileBytes.set(e.formatFourCC,this.byteOffset),this.byteOffset+=e.formatFourCC.length,this.chunks.forEach((function(e){t.appendChunk(e),t.byteOffset+=e.length}))}},{key:"createChunk",value:function(t,e){var r=e.length,n=r%2;return{fourCC:t,bytes:e,size:r,length:t.length+Uint32Array.BYTES_PER_ELEMENT+r+n}}},{key:"appendChunk",value:function(t){this.fileBytes.set(t.fourCC,this.byteOffset);var e=this.byteOffset+t.fourCC.length;this.dataView.setUint32(e,t.size,!0),e+=Uint32Array.BYTES_PER_ELEMENT,this.fileBytes.set(t.bytes,e)}},{key:"reset",value:function(){this.chunks=[],this.fileBytes=null}}]),t}(),on=function(){function t(){e(this,t)}return I(t,[{key:"decode",value:function(t){var e=rn.headers;this.reset(t);var r=this.byteOffset+e.riffFourCC.length;if(!Object.equals(this.fileBytes.subarray(this.byteOffset,r),e.riffFourCC))throw new Error("Invalid RIFF fourCC");this.byteOffset=r,r=this.byteOffset+Uint32Array.BYTES_PER_ELEMENT;var n=this.dataView.getUint32(this.byteOffset,!0)+r;if(n%2!=0)throw new Error("Invalid RIFF file size");if(n!=this.fileBytes.length)throw new Error("Incomplete RIFF file");if(this.byteOffset=r,r=this.byteOffset+e.formatFourCC.length,!Object.equals(this.fileBytes.subarray(this.byteOffset,r),e.formatFourCC))throw new Error("Invalid WILL fourCC");for(this.byteOffset=r;this.byteOffset<n;){var i=this.extractChunk();this.byteOffset+=i.length,Object.equals(i.fourCC,e.headChunkFourCC)?this.version=[i.bytes[0],i.bytes[1],i.bytes[2]]:Object.equals(i.fourCC,e.inkChunkFourCC)?this.ink=i.bytes:this.chunks.push({fourCC:String.fromCharArray(i.fourCC),bytes:i.bytes})}}},{key:"extractChunk",value:function(){var t,e,r=this.fileBytes.subarray(this.byteOffset,this.byteOffset+rn.fourCCLength),n=null,i=this.byteOffset+r.length,o=i;return i=o+Uint32Array.BYTES_PER_ELEMENT,t=this.dataView.getUint32(o,!0),i=(o=i)+t,t>0?(n=this.fileBytes.subarray(o,i),n=new Uint8Array(n,n.byteOffset,n.length)):n=new Uint8Array(0),{fourCC:r,bytes:n,size:t,length:(e=r.length+Uint32Array.BYTES_PER_ELEMENT+t)+e%2}}},{key:"reset",value:function(t){this.fileBytes=t,this.dataView=new DataView(t.buffer),this.byteOffset=0,this.chunks=[]}}]),t}();function an(t){if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(t=function(t,e){if(!t)return;if("string"==typeof t)return sn(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(r);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return sn(t,e)}(t))){var e=0,r=function(){};return{s:r,n:function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}},e:function(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,i,o=!0,a=!1;return{s:function(){n=t[Symbol.iterator]()},n:function(){var t=n.next();return o=t.done,t},e:function(t){a=!0,i=t},f:function(){try{o||null==n.return||n.return()}finally{if(a)throw i}}}}function sn(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}var un=function(){function t(){e(this,t),t.format||(t.format=Yr.Root.fromJSON(zr).WacomInkFormat3),this.riffEncoder=new nn,this.riffDecoder=new on}var r,n,i,o;return I(t,[{key:"encodeInkModel",value:(o=ht(ct.mark((function e(r){var n,i,o=this;return ct.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.structure=!0,e.t0=t.format.InkObject,e.t1=this.encodeInkInput(r.sensorData),e.t2=this.encodeInkData(r.strokes),e.next=6,this.encodeBrushes(r.brushes);case 6:return e.t3=e.sent,e.t4=this.encodeNodeTree(r),e.t5=Object.values(r.views).map((function(t){return o.encodeView(t)})),e.t6=this.encodeKnowledgeGraph(r.knowledgeGraph),e.t7=this.encodeMat4(r.transform),e.t8=this.encodeProperties(r.props),e.t9={inputData:e.t1,inkData:e.t2,brushes:e.t3,inkTree:e.t4,views:e.t5,knowledgeGraph:e.t6,transform:e.t7,properties:e.t8},n=e.t0.create.call(e.t0,e.t9),this.structure=!1,i=t.encode(n),this.riffEncoder.reset(),this.riffEncoder.encodeInk(i),e.abrupt("return",this.riffEncoder.data);case 19:case"end":return e.stop()}}),e,this)}))),function(t){return o.apply(this,arguments)})},{key:"decodeInkModel",value:function(e,r){var n=this;e instanceof ArrayBuffer&&(e=new Uint8Array(e)),this.riffDecoder.decode(e);var i=t.format.InkObject.decode(this.riffDecoder.ink);if(this.structure=!0,r){var o=this.decodeKnowledgeGraph(i.knowledgeGraph);i.views.forEach((function(t){return n.decodeView(t,r,o)}))}else{var a=this.decodeInkInput(i.inputData),s=this.decodeBrushes(i.brushes),u=this.decodeInkData(i.inkData,s,a),c=i.inkTree.first,l=c.type==t.format.NodeType.STROKE_GROUP?en.Type.STROKE:en.Type.SENSOR_DATA,h=c.type==t.format.NodeType.STROKE_GROUP?u:Object.values(a);r=new en(l,c.id),this.decodeNodeTree(r,i.inkTree.slice(1),h),i.views.forEach((function(t){return n.decodeView(t,r)})),r.knowledgeGraph=this.decodeKnowledgeGraph(i.knowledgeGraph),r.props=this.decodeProperties(i.properties),r.transform=this.decodeMat4(i.transform),r.brushes=Object.values(s)}return this.structure=!1,r}},{key:"encodeInkInput",value:function(e){var r=this,n={},i={},o={},a={},s={};e.forEach((function(t){var e=t.context;n[e.id]||(n[e.id]=e,s[e.environment.id]||(s[e.environment.id]=e.environment),i[e.sensorContext.id]||(i[e.sensorContext.id]=e.sensorContext,e.sensorContext.channelsContexts.forEach((function(t){o[t.device.id]||(o[t.device.id]=t.device),t.inkProvider&&(a[t.inkProvider.id]||(a[t.inkProvider.id]=t.inkProvider))}))))}));var u=t.format.InputData.create({sensorData:e.map((function(t){return r.encodeSensorData(t)})),inputContextData:t.format.InputContextData.create({inputContexts:Object.values(n).map((function(e){return t.format.InputContext.create({id:e.id,environmentID:e.environment.id,sensorContextID:e.sensorContext.id})})),sensorContexts:Object.values(i).map((function(e){return t.format.SensorContext.create({id:e.id,sensorChannelsContext:e.channelsContexts.map((function(e){return t.format.SensorChannelsContext.create({id:e.id,channels:e.channels.map((function(e){return t.format.SensorChannel.create({id:e.id,type:e.type,metric:t.format.InkSensorMetricType[e.metric.name],resolution:e.resolution,min:e.min,max:e.max,precision:e.precision})})),samplingRateHint:isFinite(e.samplingRate)?t.format.Uint32.create({value:e.samplingRate}):void 0,latency:isFinite(e.latency)?t.format.Uint32.create({value:e.latency}):void 0,inkInputProviderID:e.inkProvider?e.inkProvider.id:null,inputDeviceID:e.device.id})}))})})),inkInputProviders:Object.values(a).map((function(e){return t.format.InkInputProvider.create({id:e.id,type:t.format.InkInputProviderType[e.type.name],properties:r.encodeProperties(e.props)})})),inputDevices:Object.values(o).map((function(e){return t.format.InputDevice.create({id:e.id,properties:r.encodeProperties(e.props)})})),environments:Object.values(s).map((function(e){return t.format.Environment.create({id:e.id,properties:r.encodeProperties(e.props)})}))})});return this.structure?u:t.encode(u)}},{key:"decodeInkInput",value:function(e){var r=this;if(e){var n=this.structure?e:t.format.InputData.decode(e),i={},o={},a={},s={},u={};if(n.inputContextData.environments.forEach((function(t){var e=new Vt;r.decodeProperties(t.properties,e.props),Object.freeze(e),e.id!=t.id&&console.warn("Environment decode id missmatch - found ".concat(t.id,", expected ").concat(e.id)),u[e.id]=e})),n.inputContextData.inkInputProviders.forEach((function(e){var n=r.decodeProperties(e.properties),i=new Wt(Wt.Type[t.format.InkInputProviderType[e.type]],n);Object.freeze(i),i.id!=e.id&&console.warn("InkInputProvider decode id missmatch - found ".concat(e.id,", expected ").concat(i.id)),s[i.id]=i})),n.inputContextData.inputDevices.forEach((function(t){var e=new ae;r.decodeProperties(t.properties,e.props),Object.freeze(e),e.id!=t.id&&console.warn("InputDevice decode id missmatch - found ".concat(t.id,", expected ").concat(e.id)),a[e.id]=e})),n.inputContextData.sensorContexts.forEach((function(e){var r=new $t;e.sensorChannelsContext.forEach((function(e){var n=new Kt(a[e.inputDeviceID],s[e.inkInputProviderID]);e.samplingRateHint&&(n.samplingRate=e.samplingRateHint.value),e.latency&&(n.latency=e.latency.value),e.channels.forEach((function(e){var r=Zt.Metric[t.format.InkSensorMetricType[e.metric]],i=new Zt(e.type,r,e.resolution,e.min,e.max);i.precision=e.precision,n.add(i),i.id!=e.id&&console.warn("SensorChannel decode id missmatch - found ".concat(e.id,", expected ").concat(i.id))})),r.addContext(n),n.id!=e.id&&console.warn("SensorChannelsContext decode id missmatch - found ".concat(e.id,", expected ").concat(n.id))})),Object.freeze(r),o[r.id]=r,r.id!=e.id&&console.warn("SensorContext decode id missmatch - found ".concat(e.id,", expected ").concat(r.id))})),n.inputContextData.inputContexts.forEach((function(t){var e=new ee(u[t.environmentID],o[t.sensorContextID]);Object.freeze(e),e.id!=t.id&&console.warn("InputContext decode id missmatch - found ".concat(t.id,", expected ").concat(e.id)),i[e.id]=e})),this.structure){var c={};return n.sensorData.forEach((function(t){return c[t.id]=r.decodeSensorData(t,i[t.inputContextID])})),c}return n.sensorData.map((function(t){return r.decodeSensorData(t,i[t.inputContextID])}))}}},{key:"encodeSensorData",value:function(e){var r=t.format.SensorData.create({id:e.id,inputContextID:e.context.id,state:t.format.InkState[e.inkState.name],timestamp:e.created});return e.streams.forEach((function(e){var n={};e.channels.forEach((function(t){return n[t.id]=[]}));for(var i=function(t){var r=e.get(t);e.channels.forEach((function(t){n[t.id].push(r[At.getPropName(t.name)])}))},o=0;o<e.length;o++)i(o);e.channels.forEach((function(e){if(!("precision"in e))throw new Error("Precision not found for channel with id: ".concat(e.id));var i=t.format.ChannelData.create({sensorChannelID:e.id}),o=n[e.id],a=Math.pow(10,e.precision),s=Math.round(o[0]*a);i.values.push(s);for(var u=1;u<o.length;u++){var c=Math.round(o[u]*a);i.values.push(c-s),s=c}r.dataChannels.push(i)}))})),r}},{key:"decodeSensorData",value:function(e,r){var n=new ne(r);n.id=e.id,n.created=e.created,n.inkState=ne.InkState[t.format.InkState[e.state]];var i={};return e.dataChannels.forEach((function(t){var e=r.sensorContext.getContextByChannelID(t.sensorChannelID);if(!e)throw new Error("Not found corresponding channel context for data with channelID ".concat(t.sensorChannelID));var n=e.get(t.sensorChannelID),o=Math.pow(10,n.precision),a=t.values[0],s=[];s.push(a/o);for(var u=1;u<t.values.length;u++){var c=a+t.values[u];s.push(c/o),a=c}i[t.sensorChannelID]=s})),r.sensorContext.channelsContexts.forEach((function(t){for(var e=i[t.channels.first.id].length,r=new ie(t.channels),o=function(e){t.channels.forEach((function(t){var n=i[t.id];r.data.push(n[e])}))},a=0;a<e;a++)o(a);n.add(r)})),n}},{key:"encodeInkData",value:function(e){var r=this,n=t.format.InkData.create({strokes:e.map((function(t){return r.encodeStroke(t)}))});return this.structure?n:t.encode(n)}},{key:"decodeInkData",value:function(e,r,n){var i=this;if(e)return(this.structure?e:t.format.InkData.decode(e)).strokes.map((function(t){return i.decodeStroke(t,r,n)}))}},{key:"encodeStroke",value:function(e){for(var r=t.format.Stroke.create({id:e.id,startParameter:e.ts,endParameter:e.tf}),n=function(t){var n=e.pointAt(t);e.layout.forEach((function(t){switch(t){case K.Property.X:r.splineX.push(n.x);break;case K.Property.Y:r.splineY.push(n.y);break;case K.Property.Z:r.splineZ.push(n.z);break;case K.Property.RED:r.red.push(n.red/255);break;case K.Property.GREEN:r.green.push(n.green/255);break;case K.Property.BLUE:r.blue.push(n.blue/255);break;case K.Property.ALPHA:r.alpha.push(n.alpha);break;case K.Property.SIZE:r.size.push(n.size);break;case K.Property.ROTATION:r.rotation.push(n.rotation);break;case K.Property.SCALE_X:r.scaleX.push(n.scaleX);break;case K.Property.SCALE_Y:r.scaleY.push(n.scaleY);break;case K.Property.SCALE_Z:r.scaleZ.push(n.scaleZ);break;case K.Property.OFFSET_X:r.offsetX.push(n.offsetX);break;case K.Property.OFFSET_Y:r.offsetY.push(n.offsetY);break;case K.Property.OFFSET_Z:r.offsetZ.push(n.offsetZ);break;default:throw new Error("Invalid layout property provided: ".concat(t))}}))},i=0;i<e.length;i++)n(i);return e.sensorData&&(r.sensorDataID=e.sensorData.id,r.sensorDataOffset=e.sensorDataOffset,r.sensorDataMapping=e.sensorDataMapping),r.style=t.format.Style.create({brushURI:e.brush.name,renderModeURI:e.renderMode,particlesRandomSeed:e.randomSeed,properties:this.encodePathPointProperties(e.pointProps)}),r}},{key:"decodeStroke",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(0==t.splineX.length||0==t.splineY.length)throw new Error("Incomplete path definition");var n=[K.Property.X,K.Property.Y];t.splineZ.length>0&&n.push(K.Property.Z),t.red&&t.red.length>0&&n.push(K.Property.RED),t.green&&t.green.length>0&&n.push(K.Property.GREEN),t.blue&&t.blue.length>0&&n.push(K.Property.BLUE),t.alpha&&t.alpha.length>0&&n.push(K.Property.ALPHA),t.size.length>0&&n.push(K.Property.SIZE),t.rotation.length>0&&n.push(K.Property.ROTATION),t.scaleX.length>0&&n.push(K.Property.SCALE_X),t.scaleY.length>0&&n.push(K.Property.SCALE_Y),t.scaleZ.length>0&&n.push(K.Property.SCALE_Z),t.offsetX.length>0&&n.push(K.Property.OFFSET_X),t.offsetY.length>0&&n.push(K.Property.OFFSET_Y),t.offsetZ.length>0&&n.push(K.Property.OFFSET_Z);for(var i=t.splineX.length,o=n.length,a=new Float32Array(i*o),s=function(e){n.forEach((function(r,n){var i;switch(r){case K.Property.X:i=t.splineX[e];break;case K.Property.Y:i=t.splineY[e];break;case K.Property.Z:i=t.splineZ[e];break;case K.Property.RED:i=Math.round(255*t.red[e]);break;case K.Property.GREEN:i=Math.round(255*t.green[e]);break;case K.Property.BLUE:i=Math.round(255*t.blue[e]);break;case K.Property.ALPHA:i=t.alpha[e];break;case K.Property.SIZE:i=t.size[e];break;case K.Property.ROTATION:i=t.rotation[e];break;case K.Property.SCALE_X:i=t.scaleX[e];break;case K.Property.SCALE_Y:i=t.scaleY[e];break;case K.Property.SCALE_Z:i=t.scaleZ[e];break;case K.Property.OFFSET_X:i=t.offsetX[e];break;case K.Property.OFFSET_Y:i=t.offsetY[e];break;case K.Property.OFFSET_Z:i=t.offsetZ[e];break;default:throw new Error("Invalid layout property provided: ".concat(r.name))}a[e*o+n]=i}))},u=0;u<i;u++)s(u);var c=e[t.style.brushURI]||t.style.brushURI,l=this.decodePathPointProperties(t.style.properties),h=r[t.sensorDataID],f=new me(n,a,l,t.startParameter,t.endParameter);f.randomSeed=t.style.particlesRandomSeed;var d=new ar(c,f,void 0,h);return d.id=t.id,d.renderMode=t.style.renderModeURI,d.sensorDataOffset=t.sensorDataOffset,d.sensorDataMapping=t.sensorDataMapping,d}},{key:"encodeBrushes",value:(i=ht(ct.mark((function e(r){var n,i,o,a,s,u;return ct.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.format.Brushes.create(),i=an(r),e.prev=2,i.s();case 4:if((o=i.n()).done){e.next=17;break}if(!((a=o.value)instanceof pe)){e.next=11;break}s=this.encodeBrush2D(a),n.vectorBrushes.push(s),e.next=15;break;case 11:return e.next=13,this.encodeBrushGL(a);case 13:u=e.sent,n.rasterBrushes.push(u);case 15:e.next=4;break;case 17:e.next=22;break;case 19:e.prev=19,e.t0=e.catch(2),i.e(e.t0);case 22:return e.prev=22,i.f(),e.finish(22);case 25:return e.abrupt("return",this.structure?n:t.encode(n));case 26:case"end":return e.stop()}}),e,this,[[2,19,22,25]])}))),function(t){return i.apply(this,arguments)})},{key:"decodeBrushes",value:function(e){var r=this;if(e){var n=this.structure?e:t.format.Brushes.decode(e),i={};return n.vectorBrushes.forEach((function(t){return i[t.name]=r.decodeBrush2D(t)})),n.rasterBrushes.forEach((function(t){return i[t.name]=r.decodeBrushGL(t)})),this.structure?i:Object.values(i)}}},{key:"encodeBrush2D",value:function(e){if(!e.name)throw new Error("Encode Brush2D failed. name property is required.");var r=t.format.VectorBrush.create({name:e.name,spacing:e.spacing});return(Array.isArray(e.shape)?e.shape:[e.shape]).forEach((function(e){var n=t.format.BrushPrototype.create({size:e.size});if(e.descriptor.shape.name)n.shapeURI=e.descriptor.shape.name;else for(var i=0;i<e.shape.length;i+=2)n.coordX.push(e.shape[i]),n.coordY.push(e.shape[i+1]);r.prototype.push(n)})),r}},{key:"decodeBrush2D",value:function(t){var e=[];return t.prototype.forEach((function(t){var r;if(t.shapeURI)r=t.shapeURI;else{r=new Float32Array(2*t.coordX.length);for(var n=0;n<r.length/2;n++)r[2*n]=t.coordX[n],r[2*n+1]=t.coordY[n]}e.push(new he(r,t.size))})),new pe(t.name,e,t.spacing)}},{key:"encodeBrushGL",value:(n=ht(ct.mark((function e(r){var n,i,o,a;return ct.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r.name){e.next=2;break}throw new Error("Encode BrushGL failed. name property is required.");case 2:if(n={shape:[],shapeURI:[],fill:void 0,filleURI:void 0},!Array.isArray(r.shape)){e.next=11;break}if(!((i=r.descriptor.shape.map((function(t){return t.name})).filter((function(t){return t}))).length>0)){e.next=9;break}if(i.length==r.shape.length){e.next=8;break}throw new Error("Brush ".concat(r.name," shape names length do not match with brush mipmap"));case 8:n.shapeURI=i;case 9:e.next=12;break;case 11:r.descriptor.shape.name&&n.shapeURI.push(r.descriptor.shape.name);case 12:if(n.fillURI=r.descriptor.fill.name,0!=n.shapeURI.length&&n.fillURI){e.next=19;break}return e.next=16,bt(r);case 16:o=e.sent,0==n.shapeURI.length&&(Array.isArray(r.shape)?n.shape=o.shape:n.shape.push(o.shape)),n.fillURI||(n.fill=o.fill);case 19:return a=r.blendMode.replace(/-/g,"_").toUpperCase(),e.abrupt("return",t.format.RasterBrush.create({name:r.name,spacing:r.spacing,scattering:r.scattering,blendMode:t.format.BlendMode[a],rotationMode:t.format.RotationMode[r.rotationMode.name],shapeTexture:n.shape,shapeTextureURI:n.shapeURI,fillTexture:n.fill,fillTextureURI:n.fillURI,fillWidth:r.fillTextureSize.width,fillHeight:r.fillTextureSize.height,randomizeFill:r.randomizeFill}));case 21:case"end":return e.stop()}}),e)}))),function(t){return n.apply(this,arguments)})},{key:"decodeBrushGL",value:function(e){var r,n;if(e.shapeTextureURI.length>0)r=1==e.shapeTextureURI.length?{name:e.shapeTextureURI.first}:e.shapeTextureURI.map((function(t){return{name:t}}));else{if(!(e.shapeTexture.length>0))throw new Error("Decode BrushGL shape - insufficent data found");r=1==e.shapeTexture.length?{value:e.shapeTexture.first}:e.shapeTexture.map((function(t){return{value:t}}))}if(e.fillTextureURI)n={name:e.fillTextureURI};else{if(!e.fillTexture)throw new Error("Decode BrushGL fill - insufficent data found");n={value:e.fillTexture}}return new ir(e.name,r,n,{spacing:e.spacing,scattering:e.scattering,blendMode:Qe[t.format.BlendMode[e.blendMode]],rotationMode:ir.RotationMode[e.rotationMode]},{randomize:e.randomizeFill,size:{width:e.fillWidth,height:e.fillHeight}})}},{key:"encodeView",value:function(e){return t.format.View.create({name:e.name,tree:this.encodeNodeTree(e)})}},{key:"decodeView",value:function(e,r,n){var i=e.tree.first,o=i.type==t.format.NodeType.STROKE_GROUP?en.Type.STROKE:en.Type.SENSOR_DATA,a=i.type==t.format.NodeType.STROKE_GROUP?r.strokes:r.sensorData;if(!r.views[e.name]||r.views[e.name].tree.id!=e.tree[0].id){var s=r.createView(e.name,o,i.name,n);this.decodeNodeTree(s,e.tree.slice(1),a)}}},{key:"encodeNodeTree",value:function(t){var e=[];return e.push(this.encodeNode(t.type,t.tree,0)),this.addChildren(e,t,t.tree.children,1),e}},{key:"addChildren",value:function(t,e,r,n){var i=this;r.forEach((function(r){var o=r instanceof Qr?(e.model||e).content.indexOf(r.content):void 0;t.push(i.encodeNode(e.type,r,n,o)),r instanceof Jr&&i.addChildren(t,e,r.children,n+1)}))}},{key:"encodeNode",value:function(e,r,n,i){var o=e.name;return r instanceof Jr&&(o+="_GROUP"),t.format.Node.create({id:r.id,type:t.format.NodeType[o],depth:n,index:i,groupBoundingBox:r.bounds,chunkFromIndex:r.fromPointIndex,chunkToIndex:r.toPointIndex})}},{key:"decodeNodeTree",value:function(e,r,n){var i,o=e.tree,a=0,s=an(r);try{for(s.s();!(i=s.n()).done;){for(var u=i.value;a>=u.depth;)o=o.parent,a--;if(u.type==t.format.NodeType.STROKE_GROUP||u.type==t.format.NodeType.SENSOR_DATA_GROUP)o=o.appendChild(e.createGroup(u.id)),u.groupBoundingBox&&(o.bounds=$.create(u.groupBoundingBox.x,u.groupBoundingBox.y,u.groupBoundingBox.width,u.groupBoundingBox.height));else{var c=void 0;(c=u.chunkToIndex>u.chunkFromIndex?e.createElement(n[u.index],u.chunkFromIndex,u.chunkToIndex):e.createElement(n[u.index])).id=u.id,o=o.appendChild(c)}a=u.depth}}catch(t){s.e(t)}finally{s.f()}}},{key:"encodeProperties",value:function(e){return Object.keys(e).map((function(r){return t.format.Property.create({name:r,value:e[r]})}))}},{key:"decodeProperties",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t.forEach((function(t){return e[t.name]=t.value})),e}},{key:"encodeKnowledgeGraph",value:function(e){if(e){var r=t.format.TripleStore.create({statements:e.statements.map((function(e){return t.format.SemanticTriple.create({subject:e.subject,predicate:e.predicate,object:e.object})}))});return this.structure?r:t.encode(r)}}},{key:"decodeKnowledgeGraph",value:function(e){if(e){var r=new Xr,n=this.structure?e:t.format.TripleStore.decode(e);return n&&n.statements.forEach((function(t){return r.addTriple(t.subject,t.predicate,t.object)})),r}}},{key:"encodeMat4",value:function(e){if(e)return e instanceof Z||(e=Z.create(e)),t.format.Matrix4.create({m00:e.m00,m01:e.m01,m02:e.m02,m03:e.m03,m10:e.m10,m11:e.m11,m12:e.m12,m13:e.m13,m20:e.m20,m21:e.m21,m22:e.m22,m23:e.m23,m30:e.m30,m31:e.m31,m32:e.m32,m33:e.m33})}},{key:"decodeMat4",value:function(t){if(t)return Z.create([t.m00,t.m01,t.m02,t.m03,t.m10,t.m11,t.m12,t.m13,t.m20,t.m21,t.m22,t.m23,t.m30,t.m31,t.m32,t.m33])}},{key:"encodeTool",value:(r=ht(ct.mark((function e(r){var n,i,o,a,s,u=arguments;return ct.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=u.length>1&&void 0!==u[1]?u[1]:{},i=u.length>2&&void 0!==u[2]?u[2]:{},o=u.length>3&&void 0!==u[3]?u[3]:Qe.SOURCE_OVER,e.t0=t.format.Tool,e.t1=r instanceof pe?this.encodeBrush2D(r):void 0,!(r instanceof ir)){e.next=11;break}return e.next=8,this.encodeBrushGL(r);case 8:e.t2=e.sent,e.next=12;break;case 11:e.t2=void 0;case 12:return e.t3=e.t2,e.t4=t.format.PathPointContext.create({statics:this.encodePathPointProperties(i),dynamics:this.encodePathPointSettings(n)}),e.t5={vectorBrush:e.t1,rasterBrush:e.t3,context:e.t4},a=e.t0.create.call(e.t0,e.t5),o!=Qe.SOURCE_OVER&&(s=o.replace(/-/g,"_").toUpperCase(),a.blendMode=t.format.BlendMode[s]),e.abrupt("return",t.encode(a));case 18:case"end":return e.stop()}}),e,this)}))),function(t){return r.apply(this,arguments)})},{key:"decodeTool",value:function(e){if(e){e instanceof ArrayBuffer&&(e=new Uint8Array(e));var r=t.format.Tool.decode(e);return{brush:"vectorBrush"==r.brush?this.decodeBrush2D(r.vectorBrush):this.decodeBrushGL(r.rasterBrush),blendMode:Qe[t.format.BlendMode[r.blendMode]],statics:this.decodePathPointProperties(r.context.statics),dynamics:this.decodePathPointSettings(r.context.dynamics)}}}},{key:"encodePathPointProperties",value:function(e){var r=t.format.PathPointProperties.create();for(var n in t.format.PathPointProperties.fields){var i=e[n];isFinite(i)&&("red"!=n&&"green"!=n&&"blue"!=n||(i/=255),r[n]=t.format.Float32.create({value:i}))}return r}},{key:"decodePathPointProperties",value:function(e){if(e){var r={};for(var n in t.format.PathPointProperties.fields){var i=e[n];if(i){var o=i.value;"red"!=n&&"green"!=n&&"blue"!=n||(o=Math.round(255*o)),r[n]=o}}return r}}},{key:"encodePathPointSettings",value:function(e){var r=t.format.PathPointSettings.create();for(var n in t.format.PathPointSettings.fields)e[n]&&!e[n].disabled&&(r[n]=this.encodePropertySettings(n,e[n]));return r}},{key:"decodePathPointSettings",value:function(e){if(e){var r={};for(var n in t.format.PathPointSettings.fields)e[n]&&(r[n]=this.decodePropertySettings(e[n]));return r}}},{key:"encodePropertySettings",value:function(e,r){var n=this,i=function(r){if(r)return t.format.Range.create({min:r.min,max:r.max,remapURI:n.getActionDescriptorName(e,"Remap",r.remap)})};return t.format.PropertySettings.create({value:i(r.value),velocity:i(r.velocity),pressure:i(r.pressure),altitude:i(r.altitude),radiusX:i(r.radiusX),radiusY:i(r.radiusY),resolveURI:this.getActionDescriptorName(e,"Resolve",r.resolve),dependencies:(r.dependencies||[]).map((function(e){return t.format.InputPropertyType[e.name]}))})}},{key:"getActionDescriptorName",value:function(t,e,r){if(r){if("function"==typeof r)throw new Error("Encode '".concat(t,"' property failed. ").concat(e," action name property is required. Please provide ActionDescriptor for it's definition."));if("string"==typeof r)return r;if(r.name)return r.name;throw new Error("Encode '".concat(t,"' property failed. ").concat(e," action name property is required. Please provide ActionDescriptor for it's definition."))}}},{key:"decodePropertySettings",value:function(e){var r={},n=function(t,e){e&&(r[t]={min:e.min,max:e.max,remap:e.remapURI})};return n("value",e.value),n("velocity",e.velocity),n("pressure",e.pressure),n("altitude",e.altitude),n("radiusX",e.radiusX),n("radiusY",e.radiusY),r.resolve=e.resolveURI,e.dependencies.length>0&&(r.dependencies=e.dependencies.map((function(e){return Zt.Type[t.format.InputPropertyType[e]]}))),r}}],[{key:"encode",value:function(t){return t.constructor.encode(t).finish()}}]),t}(),cn=n((function(t,e){t.exports=function(){function t(t,n,i,o,a){!function t(r,n,i,o,a){for(;o>i;){if(o-i>600){var s=o-i+1,u=n-i+1,c=Math.log(s),l=.5*Math.exp(2*c/3),h=.5*Math.sqrt(c*l*(s-l)/s)*(u-s/2<0?-1:1);t(r,n,Math.max(i,Math.floor(n-u*l/s+h)),Math.min(o,Math.floor(n+(s-u)*l/s+h)),a)}var f=r[n],d=i,p=o;for(e(r,i,n),a(r[o],f)>0&&e(r,i,o);d<p;){for(e(r,d,p),d++,p--;a(r[d],f)<0;)d++;for(;a(r[p],f)>0;)p--}0===a(r[i],f)?e(r,i,p):e(r,++p,o),p<=n&&(i=p+1),n<=p&&(o=p-1)}}(t,n,i||0,o||t.length-1,a||r)}function e(t,e,r){var n=t[e];t[e]=t[r],t[r]=n}function r(t,e){return t<e?-1:t>e?1:0}var n=function(t){void 0===t&&(t=9),this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()};function i(t,e,r){if(!r)return e.indexOf(t);for(var n=0;n<e.length;n++)if(r(t,e[n]))return n;return-1}function o(t,e){a(t,0,t.children.length,e,t)}function a(t,e,r,n,i){i||(i=p(null)),i.minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(var o=e;o<r;o++){var a=t.children[o];s(i,t.leaf?n(a):a)}return i}function s(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function u(t,e){return t.minX-e.minX}function c(t,e){return t.minY-e.minY}function l(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function h(t){return t.maxX-t.minX+(t.maxY-t.minY)}function f(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function d(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function p(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function y(e,r,n,i,o){for(var a=[r,n];a.length;)if(!((n=a.pop())-(r=a.pop())<=i)){var s=r+Math.ceil((n-r)/i/2)*i;t(e,s,r,n,o),a.push(r,s,s,n)}}return n.prototype.all=function(){return this._all(this.data,[])},n.prototype.search=function(t){var e=this.data,r=[];if(!d(t,e))return r;for(var n=this.toBBox,i=[];e;){for(var o=0;o<e.children.length;o++){var a=e.children[o],s=e.leaf?n(a):a;d(t,s)&&(e.leaf?r.push(a):f(t,s)?this._all(a,r):i.push(a))}e=i.pop()}return r},n.prototype.collides=function(t){var e=this.data;if(!d(t,e))return!1;for(var r=[];e;){for(var n=0;n<e.children.length;n++){var i=e.children[n],o=e.leaf?this.toBBox(i):i;if(d(t,o)){if(e.leaf||f(t,o))return!0;r.push(i)}}e=r.pop()}return!1},n.prototype.load=function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var e=0;e<t.length;e++)this.insert(t[e]);return this}var r=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===r.height)this._splitRoot(this.data,r);else{if(this.data.height<r.height){var n=this.data;this.data=r,r=n}this._insert(r,this.data.height-r.height-1,!0)}else this.data=r;return this},n.prototype.insert=function(t){return t&&this._insert(t,this.data.height-1),this},n.prototype.clear=function(){return this.data=p([]),this},n.prototype.remove=function(t,e){if(!t)return this;for(var r,n,o,a=this.data,s=this.toBBox(t),u=[],c=[];a||u.length;){if(a||(a=u.pop(),n=u[u.length-1],r=c.pop(),o=!0),a.leaf){var l=i(t,a.children,e);if(-1!==l)return a.children.splice(l,1),u.push(a),this._condense(u),this}o||a.leaf||!f(a,s)?n?(r++,a=n.children[r],o=!1):a=null:(u.push(a),c.push(r),r=0,n=a,a=a.children[0])}return this},n.prototype.toBBox=function(t){return t},n.prototype.compareMinX=function(t,e){return t.minX-e.minX},n.prototype.compareMinY=function(t,e){return t.minY-e.minY},n.prototype.toJSON=function(){return this.data},n.prototype.fromJSON=function(t){return this.data=t,this},n.prototype._all=function(t,e){for(var r=[];t;)t.leaf?e.push.apply(e,t.children):r.push.apply(r,t.children),t=r.pop();return e},n.prototype._build=function(t,e,r,n){var i,a=r-e+1,s=this._maxEntries;if(a<=s)return o(i=p(t.slice(e,r+1)),this.toBBox),i;n||(n=Math.ceil(Math.log(a)/Math.log(s)),s=Math.ceil(a/Math.pow(s,n-1))),(i=p([])).leaf=!1,i.height=n;var u=Math.ceil(a/s),c=u*Math.ceil(Math.sqrt(s));y(t,e,r,c,this.compareMinX);for(var l=e;l<=r;l+=c){var h=Math.min(l+c-1,r);y(t,l,h,u,this.compareMinY);for(var f=l;f<=h;f+=u){var d=Math.min(f+u-1,h);i.children.push(this._build(t,f,d,n-1))}}return o(i,this.toBBox),i},n.prototype._chooseSubtree=function(t,e,r,n){for(;n.push(e),!e.leaf&&n.length-1!==r;){for(var i=1/0,o=1/0,a=void 0,s=0;s<e.children.length;s++){var u=e.children[s],c=l(u),h=(f=t,d=u,(Math.max(d.maxX,f.maxX)-Math.min(d.minX,f.minX))*(Math.max(d.maxY,f.maxY)-Math.min(d.minY,f.minY))-c);h<o?(o=h,i=c<i?c:i,a=u):h===o&&c<i&&(i=c,a=u)}e=a||e.children[0]}var f,d;return e},n.prototype._insert=function(t,e,r){var n=r?t:this.toBBox(t),i=[],o=this._chooseSubtree(n,this.data,e,i);for(o.children.push(t),s(o,n);e>=0&&i[e].children.length>this._maxEntries;)this._split(i,e),e--;this._adjustParentBBoxes(n,i,e)},n.prototype._split=function(t,e){var r=t[e],n=r.children.length,i=this._minEntries;this._chooseSplitAxis(r,i,n);var a=this._chooseSplitIndex(r,i,n),s=p(r.children.splice(a,r.children.length-a));s.height=r.height,s.leaf=r.leaf,o(r,this.toBBox),o(s,this.toBBox),e?t[e-1].children.push(s):this._splitRoot(r,s)},n.prototype._splitRoot=function(t,e){this.data=p([t,e]),this.data.height=t.height+1,this.data.leaf=!1,o(this.data,this.toBBox)},n.prototype._chooseSplitIndex=function(t,e,r){for(var n,i,o,s,u,c,h,f=1/0,d=1/0,p=e;p<=r-e;p++){var y=a(t,0,p,this.toBBox),v=a(t,p,r,this.toBBox),g=(i=y,o=v,s=Math.max(i.minX,o.minX),u=Math.max(i.minY,o.minY),c=Math.min(i.maxX,o.maxX),h=Math.min(i.maxY,o.maxY),Math.max(0,c-s)*Math.max(0,h-u)),m=l(y)+l(v);g<f?(f=g,n=p,d=m<d?m:d):g===f&&m<d&&(d=m,n=p)}return n||r-e},n.prototype._chooseSplitAxis=function(t,e,r){var n=t.leaf?this.compareMinX:u,i=t.leaf?this.compareMinY:c;this._allDistMargin(t,e,r,n)<this._allDistMargin(t,e,r,i)&&t.children.sort(n)},n.prototype._allDistMargin=function(t,e,r,n){t.children.sort(n);for(var i=this.toBBox,o=a(t,0,e,i),u=a(t,r-e,r,i),c=h(o)+h(u),l=e;l<r-e;l++){var f=t.children[l];s(o,t.leaf?i(f):f),c+=h(o)}for(var d=r-e-1;d>=e;d--){var p=t.children[d];s(u,t.leaf?i(p):p),c+=h(u)}return c},n.prototype._adjustParentBBoxes=function(t,e,r){for(var n=r;n>=0;n--)s(e[n],t)},n.prototype._condense=function(t){for(var e=t.length-1,r=void 0;e>=0;e--)0===t[e].children.length?e>0?(r=t[e-1].children).splice(r.indexOf(t[e]),1):this.clear():o(t[e],this.toBBox)},n}()})),ln=function(){function t(r){e(this,t),this.tree=r,this.attach()}return I(t,[{key:"attach",value:function(){var t=this;"loading"==document.readyState?addEventListener("DOMContentLoaded",(function(e){return t.attach()})):(this.canvas=document.getElementById("rbush"),this.ctx=this.canvas.getContext("2d"))}},{key:"refresh",value:function(e){var r=this,n=[];t.allocateSegments(n,this.tree.data,0),this.ctx.clearRect(0,0,this.canvas.width+1,this.canvas.height+1);for(var i=function(t){var e=n[t];e.hulls?e.hulls.forEach((function(t){return r.drawShape(t,e.color)})):r.drawRect(e.bounds,e.color)},o=n.length-1;o>=0;o--)i(o)}},{key:"drawRect",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:H.from(128,128,128,.3);this.ctx.strokeStyle="rgba(".concat(e.red,", ").concat(e.green,", ").concat(e.blue,", ").concat(e.alpha,")"),this.ctx.strokeRect(t.left,t.top,t.width,t.height)}},{key:"fillRect",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:H.from(128,128,128,.3);this.ctx.fillStyle="rgba(".concat(e.red,", ").concat(e.green,", ").concat(e.blue,", ").concat(e.alpha,")"),this.ctx.fillRect(t.left,t.top,t.width,t.height)}},{key:"fillPoint",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:H.BLACK;this.ctx.fillStyle="rgba(".concat(r.red,", ").concat(r.green,", ").concat(r.blue,", ").concat(r.alpha,")"),this.ctx.beginPath(),this.ctx.arc(t.x,t.y,e,0,2*Math.PI),this.ctx.closePath(),this.ctx.fill()}},{key:"drawShape",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:H.from(139,0,139,.5);this.ctx.strokeStyle="rgba(".concat(e.red,", ").concat(e.green,", ").concat(e.blue,", ").concat(e.alpha,")"),this.drawPath(t),this.ctx.stroke()}},{key:"fillShape",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:H.from(236,189,50,.6);this.ctx.fillStyle="rgba(".concat(e.red,", ").concat(e.green,", ").concat(e.blue,", ").concat(e.alpha,")"),this.drawPath(t),this.ctx.fill()}},{key:"drawPath",value:function(t){var e=this;"number"==typeof t[0]&&(t=[t]),this.ctx.beginPath(),t.forEach((function(t){e.ctx.moveTo(t[0],t[1]);for(var r=2;r<t.length;r+=2)e.ctx.lineTo(t[r],t[r+1]);e.ctx.closePath()}))}},{key:"drawRange",value:function(t){var e=this;t.forEach((function(t){return e.drawRect(t.bounds,H.fromHex("#800080"))}))}},{key:"drawIntersection",value:function(t,e){var r=this;this.drawShape(t,H.fromHex("#ffc0cb")),e.forEach((function(e){r.fillShape(e.shape,H.fromHex("#ffff00"));var n=ut.intersection(e.shape,t);if(n){var i=n.toPath2D();r.fillShape(i,H.BLACK)}}))}},{key:"drawSelection",value:function(t,e,r){this.fillRect(t),this.fillShape(e,H.from(139,0,139,.5)),this.fillShape(r)}}],[{key:"allocateSegments",value:function(e,r,n){if(r){if(r.bounds){var i=r;1==r.depth?i.color=H.RED:2==r.depth?i.color=H.BLUE:3==r.depth?i.color=H.RED:4==r.depth?i.color=H.GREEN:r.depth,e.push(i)}if(r.children)if(10!==n)for(var o=0;o<r.children.length;o++)t.allocateSegments(e,r.children[o],n+1);else console.warn("depth 10")}}},{key:"getInstance",value:function(e){return t.instance||(t.instance=new t(e)),t.instance}}]),t}();function hn(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var fn=function(t){o(i,t);var r,n=(r=i,function(){var t,e=c(r);if(hn()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function i(){var t;e(this,i);for(var r=arguments.length,o=new Array(r),a=0;a<r;a++)o[a]=arguments[a];return(t=n.call.apply(n,[this].concat(o))).detachCanvas(),t}return I(i,[{key:"toBBox",value:function(t){return{minX:t.bounds.left,minY:t.bounds.top,maxX:t.bounds.right,maxY:t.bounds.bottom}}},{key:"compareMinX",value:function(t,e){return t.bounds.x-e.bounds.x}},{key:"compareMinY",value:function(t,e){return t.bounds.y-e.bounds.y}},{key:"search",value:function(t){return q(c(i.prototype),"search",this).call(this,{minX:t.left,minY:t.top,maxX:t.right,maxY:t.bottom})}},{key:"find",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.data,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];if(e){if(e.stroke){var i=!0;Object.keys(t).forEach((function(r){i=i&&e[r]==t[r]})),i&&n.push(e)}if(e.children){if(6!==r){for(var o=0;o<e.children.length;o++)this.find(t,e.children[o]||null,r+1,n);return n}console.warn("depth 6")}}}},{key:"attachCanvas",value:function(){this.canvas=ln.getInstance(this)}},{key:"detachCanvas",value:function(){var t=this;this.canvas={},Object.getOwnPropertyNames(ln.prototype).filter((function(t){return!["constructor","attach"].includes(t)})).forEach((function(e){t.canvas[e]=function(){}}))}}]),i}(cn),dn=function(){function t(){e(this,t),this.tree=new fn,this.strokes={},this.brushAppliers={},this.nodes={}}return I(t,[{key:"add",value:function(t){if(!(t.brush instanceof ir)){this.strokes[t.id]=t;var e=this.buildStrokeSegments(t);this.load(e)}}},{key:"buildStrokeSegments",value:function(t){var e=[];this.nodes[t.id]=e;for(var r=0;r<t.segmentsCount;r++){var n=this.buildStrokeSegment(t,r);e.push(n)}return e}},{key:"buildStrokeSegment",value:function(t,e){if(e<0||e>=t.segmentsCount)throw new Error("Invalid index ".concat(e," found. Ensure that index range is {0, ").concat(t.segmentsCount-1,"}."));var r=.166666666666,n=t.getSegment(e),i=n.getPoint(0),o=n.getPoint(1),a=n.getPoint(2),s=n.getPoint(3),u=-r*i.x+o.x+r*a.x,c=-r*i.y+o.y+r*a.y,l=+r*o.x+a.x-r*s.x,h=+r*o.y+a.y-r*s.y,f=o.asArray(t.layout).concat(a.asArray(t.layout)),d=new xe(t.layout,f,t.pointProps),p=this.getBrushApplier(t.id).get(d),y=$.ofPolygon(p.first),v=$.ofPolygon(p.last),g=Math.max(y.width,v.height),m=Math.max(y.height,v.height),b=Math.max(g,m),x=$.create(u-b/2,c-m/2,b,b),E=$.create(l-b/2,h-m/2,b,b),P=y.union(v).union(x).union(E);return{strokeID:t.id,segmentIndex:e,bounds:P,point:n.getPoint(0),spline:n,shapesPath:p,depth:1}}},{key:"getStroke",value:function(t){return this.strokes[t]}},{key:"getBrushApplier",value:function(t){var e=this.strokes[t].brush;return this.brushAppliers[e.name]||(this.brushAppliers[e.name]=new Le(e)),this.brushAppliers[e.name]}},{key:"getNodes",value:function(t){return this.nodes[t]}},{key:"reload",value:function(t){this.unload(this.nodes[t.id]);var e=this.buildStrokeSegments(t);this.load(e)}},{key:"remove",value:function(t){this.unload(this.nodes[t.id]),delete this.nodes[t.id],delete this.strokes[t.id]}},{key:"update",value:function(t){var e=this,r={intersected:[],selected:[],dirtyArea:void 0};return Object.keys(t).forEach((function(n){var i=e.strokes[n],o=e.split(i,t[n]);o&&(r.intersected.push({stroke:i,strokes:o}),r.dirtyArea=i.bounds.union(r.dirtyArea),t[n].intervals.forEach((function(t,e){t.inside&&r.selected.push(o[e])})))})),r}},{key:"split",value:function(t,e){var r=this,n=e.intervals,i=e.dropoutSegments;if(0==n.length)return[];var o=t.split(n);if(o){o.forEach((function(t){r.strokes[t.id]=t}));var a=[],s=[];return n.map((function(e){return r.nodes[t.id].slice(e.fromNodeIndex,e.toNodeIndex+1)})).forEach((function(e,i){var u,c,l=o[i],h=n[i].fromIndex,f=n[i].toIndex-3;if(l.ts!=e.first.spline.ts){var d=e.first.segmentIndex,p=r.nodes[t.id].filter((function(t){return t.segmentIndex==d}));e=e.filter((function(t){return t.segmentIndex!=d})),d>=h&&(u=r.buildStrokeSegment(l,d-h),a.push(u)),s.push.apply(s,w(p))}if(e.length>0&&l.tf!=e.last.spline.tf){var y=e.last.segmentIndex,v=r.nodes[t.id].filter((function(t){return t.segmentIndex==y}));e=e.filter((function(t){return t.segmentIndex!=y})),y<=f&&(c=r.buildStrokeSegment(l,y-h),a.push(c)),s.push.apply(s,w(v))}e.forEach((function(t){t.strokeID=l.id,t.segmentIndex-=h})),u&&e.unshift(u),c&&e.push(c),r.nodes[l.id]=e})),i.push.apply(i,s),this.unload(i),this.load(a),delete this.nodes[t.id],delete this.strokes[t.id],o}}},{key:"replace",value:function(t,e){var r=this;e.forEach((function(t){return r.add(t)})),this.remove(t)}},{key:"load",value:function(t){0!=t.length&&(this.tree.load(t),this.tree.canvas.refresh())}},{key:"updateTree",value:function(t,e){this.tree.remove(t),this.nodes[t.strokeID].replace(t,e)}},{key:"unload",value:function(t){var e=this;Array.isArray(t)||(t=[t]),t.forEach((function(t){return e.tree.remove(t)})),this.tree.canvas.refresh()}},{key:"search",value:function(t){return this.tree.search(t)}},{key:"reset",value:function(){this.strokes={},this.brushAppliers={},this.nodes={},this.tree.clear(),this.tree.canvas.refresh()}}]),t}(),pn=function(){function t(r){e(this,t),this.interpolator=r}return I(t,[{key:"build",value:function(t,e,r){var n=this;return this.context=t,this.pathContext=new st(r),this.result={},this.holes=[],(e=e.unique()).sort(At.comparator({sortBy:"strokeID",sortOrder:"asc"},{sortBy:"segmentIndex",sortOrder:"asc"},{sortBy:"splineIndex",sortOrder:"asc"},{sortBy:"pointIndex",sortOrder:"asc"})),e.forEach((function(t){n.isHolePart(t)?n.update(t):n.add(t)})),this.narrow(),this.result}},{key:"add",value:function(t){this.holes=this.result[t.strokeID],this.holes||(this.holes=[],this.result[t.strokeID]=this.holes);var e=t.segmentIndex,r=t.segmentIndex,n=this.context.getNodes(t.strokeID).indexOf(t);this.holes.push({fromIndex:e,toIndex:r,fromTValue:t.prevT,toTValue:t.nextT,fromNodeIndex:n,toNodeIndex:n,strokeID:t.strokeID,nodes:[t]})}},{key:"update",value:function(t){var e=this.holes.last;e.toIndex=t.segmentIndex,e.toTValue=t.nextT,e.toNodeIndex=this.context.getNodes(t.strokeID).indexOf(t),e.nodes.push(t)}},{key:"isHolePart",value:function(t){var e=this.holes.last;return!(!e||e.strokeID!=t.strokeID)&&(t.segmentIndex==e.toIndex&&t.prevT<=e.toTValue||t.segmentIndex==e.toIndex+1&&1==e.toTValue&&0==t.prevT)}},{key:"narrow",value:function(){var t=this;this.holes.forEach((function(e){var r,n=e.nodes.first,i=e.nodes.last;r=e.nodes.length<=2?t.extractT(n,"sf",n.prevT,i.nextT):{s:t.extractT(n,"s",n.prevT,n.nextT).s,f:t.extractT(i,"f",i.prevT,i.nextT).f},n.ts=r.s,i.tf=r.f,e.fromTValue=r.s,e.toTValue=r.f}))}},{key:"extractT",value:function(t,e,r,n){if(r==n)return{};var i,o={},a=e.startsWith("s");this.interpolator.spacing=.1;for(var s=new me(t.spline.layout,t.spline.points,t.spline.pointProps,r,n),u=this.interpolator.get(s),c=0;c<u.length;c++){var l=u.getPoint(c),h=this.context.getBrushApplier(t.strokeID).applyBrush(l);if(ut.intersection(this.pathContext,h)){if(a){if(o.s=i,e.endsWith("f")){i=u.getPointT(c),a=!1;continue}break}i=u.getPointT(c)}else if(a&&(i=u.getPointT(c)),!a&&(o.f=i,i))break}if(isNaN(o.s)&&(o.s=r),isNaN(o.f)&&(o.f=n),o.s==o.f){var f=u.tValues.indexOf(o.s);0==f?o.f=u.tValues[f+1]:o.s=u.tValues[f-1]}return o}}]),t}();function yn(t){if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(t=function(t,e){if(!t)return;if("string"==typeof t)return vn(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(r);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return vn(t,e)}(t))){var e=0,r=function(){};return{s:r,n:function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}},e:function(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,i,o=!0,a=!1;return{s:function(){n=t[Symbol.iterator]()},n:function(){var t=n.next();return o=t.done,t},e:function(t){a=!0,i=t},f:function(){try{o||null==n.return||n.return()}finally{if(a)throw i}}}}function vn(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}var gn=function(){function t(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:t.Mode.WHOLE_STROKE;e(this,t),this.mode=r,this.splineInterpolator=new Me(1,8,!1),this.splineInterpolator.keepTValues=!0,this.segmentInterpolator=new Me(1,8,!0),this.segmentInterpolator.keepTValues=!0,this.convexHullChainProducer=new Be,this.holesBuilder=new pn(this.segmentInterpolator)}return I(t,[{key:"updateSegmentation",value:function(e){var r,n=[],i=!1,o=yn(e);try{for(o.s();!(r=o.n()).done;){var a=r.value;if(0!=a.length){var s=$.ofPolygon(a),u=this.context.search(s);if(u.length>0){var c,l,h=[],f=yn(u);try{for(f.s();!(l=f.n()).done;){var d=l.value;if(1==d.depth){for(var p=[],y=this.splineInterpolator.get(d.spline),v=this.context.getBrushApplier(d.strokeID).get(y),g=0;g<y.length-1;g++){var m=[v[g],v[g+1]];p.push({strokeID:d.strokeID,segmentIndex:d.segmentIndex,splineIndex:g,bounds:$.ofPolygons(m),point:y.getPoint(g),spline:new me(d.spline.layout,d.spline.points,d.spline.pointProps,y.getPointT(g),y.getPointT(g+1)),shapesPath:m,depth:2})}this.context.updateTree(d,p),h=h.concat(p),i=!0}else if(2==d.depth){this.convexHullChainProducer.reset();var b=this.convexHullChainProducer.get(d.shapesPath);d.depth=3,d.hulls=b,this.context.tree.canvas.refresh(),i=!0}else if(3==d.depth){if(ut.intersection(d.hulls,a))if(this.mode==t.Mode.PARTIAL_STROKE){var x=[];this.segmentInterpolator.spacing=1;for(var E=this.segmentInterpolator.get(d.spline),P=this.context.getBrushApplier(d.strokeID).get(E),k=0;k<E.length;k++){var w=$.ofPolygon(P[k]),R=w,S=d.spline,I=E.getPointT(k),T=E.getPointT(k-1),A=E.getPointT(k+1);if(isNaN(T)&&(T=d.spline.ts),isNaN(A)&&(A=d.spline.tf),w.width!=w.height){var C=Math.max(w.width,w.height);w=$.create(w.center.x-C/2,w.center.y-C/2,C,C)}x.push({strokeID:d.strokeID,segmentIndex:d.segmentIndex,splineIndex:d.splineIndex,pointIndex:k,bounds:w,point:E.getPoint(k),spline:S,prevT:T,t:I,nextT:A,shape:P[k],shapeBounds:R,depth:4})}this.context.updateTree(d,x),h=h.concat(x),i=!0}else n.push(d)}else $.intersect(s,d.bounds)&&(d.affected=!0),n.push(d)}}catch(t){f.e(t)}finally{f.f()}if(h.length>0&&this.context.load(h),i)return this.updateSegmentation(e);(c=this.nodes).push.apply(c,n)}}}}catch(t){o.e(t)}finally{o.f()}}},{key:"createIntervals",value:function(t,e){var r=this,n={intersected:{},selected:[]};if(0==e.length)return n;var i=this.holesBuilder.build(this.context,t,e),o=function(t){var e=r.context.getNodes(t),o=[],a=[];n.intersected[t]={intervals:o,dropoutSegments:a},i[t].forEach((function(r,s){var u,c=0==r.fromIndex&&r.fromTValue==e.first.ts,l=r.toIndex==e.last.segmentIndex&&r.toTValue==e.last.tf;if(c&&l)return n.selected.push(t),void delete n.intersected[t];a.push.apply(a,w(r.nodes)),c?u={fromIndex:r.toIndex,fromTValue:r.toTValue,fromNodeIndex:r.toNodeIndex}:l?(o.last||o.push({fromIndex:0,fromTValue:e.first.spline.ts,fromNodeIndex:0}),o.last.toIndex=r.fromIndex+3,o.last.toTValue=r.fromTValue,o.last.toNodeIndex=r.fromNodeIndex):o.last?(o.last.toIndex=r.fromIndex+3,o.last.toTValue=r.fromTValue,o.last.toNodeIndex=r.fromNodeIndex,u={fromIndex:r.toIndex,fromTValue:r.toTValue,fromNodeIndex:r.toNodeIndex}):(o.push({fromIndex:0,fromTValue:e.first.spline.ts,toIndex:r.fromIndex+3,toTValue:r.fromTValue,fromNodeIndex:0,toNodeIndex:r.fromNodeIndex}),u={fromIndex:r.toIndex,fromTValue:r.toTValue,fromNodeIndex:r.toNodeIndex}),u&&o.push(u),s!=i[t].length-1||l||(o.last.toIndex=e.last.segmentIndex+3,o.last.toTValue=e.last.spline.tf,o.last.toNodeIndex=e.length-1);var h=[];o.forEach((function(t){if(1==t.fromTValue){var r=e.filter((function(e){return e.segmentIndex==t.fromIndex+1})).first,n=e.filter((function(e){return e.segmentIndex==t.fromIndex}));a.push.apply(a,w(n)),t.fromIndex++,t.fromTValue=0,t.fromNodeIndex=e.indexOf(r)}if(0==t.toTValue){var i=t.toIndex-3,o=e.filter((function(t){return t.segmentIndex==i-1})).last,s=e.filter((function(t){return t.segmentIndex==i}));a.push.apply(a,w(s)),t.toIndex--,t.toTValue=1,t.toNodeIndex=e.indexOf(o)}if(t.toIndex-t.fromIndex<3)h.push(t);else if(t.toIndex-t.fromIndex==3&&t.fromTValue==t.toTValue){var u=e.filter((function(e){return e.segmentIndex==t.fromIndex}));a.push.apply(a,w(u)),h.push(t)}})),h.forEach((function(t){o.remove(t)}))}))};for(var a in i)o(a);return n}},{key:"reset",value:function(t){if(!t)throw new Error("Required spatial context not found");this.context=t,this.nodes=[]}}]),t}();function mn(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}gn.createEnum("Mode",["WHOLE_STROKE","PARTIAL_STROKE"]);var bn=function(t){o(i,t);var r,n=(r=i,function(){var t,e=c(r);if(mn()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function i(t){return e(this,i),n.call(this,t)}return I(i,[{key:"intersect2",value:function(t){if(!this.context)throw new Error("Required spatial context not found");return this.createIntervals(this.nodes,t)}},{key:"intersect",value:function(t){if(!this.context)throw new Error("Required spatial context not found");return this.nodes=[],this.updateSegmentation(t),this.mode==i.Mode.PARTIAL_STROKE?this.createIntervals(this.nodes,t):{intersected:{},selected:this.nodes.map((function(t){return t.strokeID}))}}}]),i}(gn);function xn(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}var En=function(t){o(i,t);var r,n=(r=i,function(){var t,e=c(r);if(xn()){var n=c(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return u(this,t)});function i(t){return e(this,i),n.call(this,t)}return I(i,[{key:"select",value:function(t){var e=this;if(!this.context)throw new Error("Required spatial context not found");var r={intersected:{},selected:[]},n=t.bounds,o=ut.createClipperPath(t.spline);setTimeout((function(){return e.context.tree.canvas.drawSelection(n,t.points,t.path.first)}),1e3);var a=this.context.search(n),s=this.nodes.map((function(t){return t.strokeID})).unique(),u=a.map((function(t){return t.strokeID})).unique().filter((function(t){return!s.includes(t)}));if(this.mode==i.Mode.PARTIAL_STROKE){var c=t.spline.getPoint(0).asArray(t.layout),l=t.spline.getPoint(t.spline.length-1).asArray(t.layout),h=[].concat(w(c),w(c),w(l),w(l)),f=new ar(t.brush,new me(t.layout,h,t.pointProps));this.updateSegmentation(f.path);var d=this.createIntervals(this.nodes,t.path);r=d,s.forEach((function(t){var r=[];d.intersected[t]&&(r=d.intersected[t].intervals),r.forEach((function(r){var n=e.context.getNodes(t)[r.fromNodeIndex];r.inside=ut.containsPoint(o,n.point)}))}))}else r.selected=s;return u.forEach((function(t){var n=e.context.getNodes(t)[0];ut.containsPoint(o,n.point)&&r.selected.push(t)})),r}}]),i}(gn);return t.BlendMode=Qe,t.Brush2D=pe,t.BrushApplier=Le,t.BrushGL=ir,t.BrushPrototype=he,t.Color=H,t.ConvexHullChainProducer=Be,t.ConvexHullProducer=Pe,t.Environment=Vt,t.GLTools=nr,t.InkBuilder=ze,t.InkBuilderAsync=Je,t.InkCanvas2D=yr,t.InkCanvasGL=Ur,t.InkCodec=un,t.InkController=Dt,t.InkInputProvider=Wt,t.InkModel=en,t.InputContext=ee,t.InputDevice=ae,t.InputListener=Ot,t.InterpolatedSpline=xe,t.Intersector=bn,t.Matrix=Z,t.OffscreenCanvasGL=xr,t.PathPoint=K,t.PathPointContext=ye,t.PathProducer=we,t.PathSegment=ge,t.PointerData=se,t.Poly=ut,t.PolygonMerger=Ue,t.PolygonSimplifier=Ge,t.Rect=$,t.Scalar=Nt,t.Selector=En,t.SemanticTriple=Gr,t.SensorChannel=Zt,t.SensorChannelsContext=Kt,t.SensorContext=$t,t.SensorData=ne,t.SensorStream=ie,t.ShapeFactory=ue,t.Smoother=Te,t.SpatialContext=dn,t.Spline=me,t.SplineInterpolator=Me,t.SplineProducer=Ce,t.Stroke=ar,t.StrokeRenderer2D=vr,t.StrokeRendererGL=jr,t.TextTable=Tt,t.TripleStore=Xr,t.TypedArrayCodec=ce,t.URIResolver=T,t.fsx=Et,t.mat4x=It,t.math=Pt,t.utils=At,t}({});
